<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ŸÑÿπÿ®ÿ© ÿßŸÑŸÇÿπÿØÿ© - ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÿßŸÑŸÇÿπÿØÿ©">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé≤</text></svg>">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#f43f5e">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="C -- ggameData.js"></script>
    <style>
        * { font-family: 'Cairo', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #1E293B;
            overscroll-behavior: none;
            user-select: none;
        }
        
        /* Page Transitions - Snappy Entry Animation */
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(10px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        .animate-enter {
            animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        
        /* Legacy Animation Support */
        .animate-in { animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .animate-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .rotate-90-text { transform: rotate(90deg); white-space: nowrap; }
        .bomb-pulse { animation: bomb 0.5s infinite; }
        @keyframes bomb { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* Floating Point Animation */
        .floating-point {
            position: fixed;
            font-size: 2.5rem;
            font-weight: 900;
            color: #10b981;
            text-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
            pointer-events: none;
            z-index: 9999;
            animation: floatUp 1.5s ease-out forwards;
        }
        @keyframes floatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-40px) scale(1.2);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-100px) scale(0.8);
            }
        }
        
        /* Confetti Particle */
        .confetti-particle {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 9998;
            animation: confettiFall 2s ease-out forwards;
        }
        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Surprise Me Button Gradient */
        .surprise-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Bottom Navigation Active State */
        #bottom-nav button {
            color: #cbd5e1; /* slate-300 */
        }
        #bottom-nav button.active {
            color: #fb7185; /* rose-400 - pastel */
        }
        #bottom-nav button.active .nav-icon {
            stroke: #fb7185;
            transform: scale(1.1);
        }
        #bottom-nav button.active .nav-label {
            color: #fb7185;
        }
        #bottom-nav button:not(.active) .nav-icon {
            stroke: #cbd5e1; /* slate-300 */
        }
        #bottom-nav button:not(.active) .nav-label {
            color: #cbd5e1;
        }
        
        /* Settings Modal - Luxury Bottom Sheet */
        .settings-modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }
        
        .settings-modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .settings-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: backdropFadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes backdropFadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(8px);
            }
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(100%);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideDown {
            from { 
                transform: translateY(0);
                opacity: 1;
            }
            to { 
                transform: translateY(100%);
                opacity: 0;
            }
        }
        
        .settings-sheet {
            position: relative;
            max-width: 28rem;
            width: 100%;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.98));
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-top-left-radius: 2rem;
            border-top-right-radius: 2rem;
            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .settings-modal-overlay.closing .settings-sheet {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.6, 1);
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .settings-close-btn {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: scale(1.05);
        }
        
        .settings-close-btn:active {
            transform: scale(0.95);
        }
        
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
        }
        
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }
        
        .settings-row:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }
        
        .settings-row-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }
        
        .settings-icon {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .settings-icon-danger {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .settings-row-title {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }
        
        .settings-row-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.25rem;
        }
        
        .settings-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
            margin: 1rem 0;
        }
        
        .settings-danger {
            cursor: pointer;
            border-color: rgba(239, 68, 68, 0.2);
        }
        
        .settings-danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.4);
            transform: translateX(-2px);
        }
        
        .settings-danger:active {
            transform: scale(0.98);
        }
        
        /* Toggle Switch - Premium Design */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.75rem;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2rem;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0.2rem;
            bottom: 0.2rem;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(1.25rem);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .toggle-switch:hover .toggle-slider {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .toggle-switch input:checked:hover + .toggle-slider {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .settings-footer {
            text-align: center;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(0, 0, 0, 0.2);
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #0f172a;
        }
        
        body.dark-mode .max-w-md {
            background: rgba(15, 23, 42, 0.98);
            border-color: rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode #bottom-nav {
            background: rgba(15, 23, 42, 0.95);
            border-top-color: rgba(255, 255, 255, 0.08);
        }
        
        body.dark-mode #bottom-nav button:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-slate-800">
    <div id="app" class="min-h-screen bg-slate-800">
        <div class="max-w-md mx-auto min-h-screen shadow-2xl bg-slate-800 relative overflow-hidden border-x-2 border-slate-700 flex flex-col">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-rose-400 via-amber-400 to-indigo-400 z-50"></div>

            <div id="screen-container" class="flex-1 flex flex-col h-full overflow-hidden pb-20 bg-slate-800"></div>
            
            <!-- Global Bottom Navigation Bar -->
            <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-slate-800/90 backdrop-blur-md border-t border-slate-700 shadow-lg z-50 pb-safe">
                <div class="max-w-md mx-auto grid grid-cols-4 h-16">
                    <!-- Home Tab -->
                    <button onclick="navigate('home')" id="nav-home" class="flex flex-col items-center justify-center gap-1 transition-all hover:bg-slate-700 active:scale-95">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        <span class="text-xs font-bold nav-label">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                </button>
                
                    <!-- Players Tab -->
                    <button onclick="navigate('players')" id="nav-players" class="flex flex-col items-center justify-center gap-1 transition-all hover:bg-slate-700 active:scale-95">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span class="text-xs font-bold nav-label">ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ</span>
                    </button>
                    
                    <!-- Scores Tab -->
                    <button onclick="navigate('scores')" id="nav-scores" class="flex flex-col items-center justify-center gap-1 transition-all hover:bg-slate-700 active:scale-95">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                            <path d="M4 22h16"></path>
                            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                        </svg>
                        <span class="text-xs font-bold nav-label">ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨</span>
                    </button>
                    
                    <!-- Settings Tab -->
                    <button onclick="openSettings()" id="nav-settings" class="flex flex-col items-center justify-center gap-1 transition-all hover:bg-slate-700 active:scale-95">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.656-14.656l-4.242 4.242m0 6l-4.242 4.242M23 12h-6m-6 0H1m20.656 5.656l-4.242-4.242m0-6L13.656 1.344"></path>
                        </svg>
                        <span class="text-xs font-bold nav-label">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span>
                </button>
            </div>
            </nav>
            
            <!-- Settings Modal - Luxury Bottom Sheet -->
            <div id="settings-modal" class="settings-modal-overlay">
                <div class="settings-backdrop" onclick="closeSettings()"></div>
                <div class="settings-sheet">
                    <!-- Header -->
                    <div class="settings-header">
                        <h2 class="text-2xl font-black text-white">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h2>
                        <button onclick="closeSettings()" class="settings-close-btn">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Settings Content -->
                    <div class="settings-content">
                        <!-- Sound Control -->
                        <div class="settings-row">
                            <div class="settings-row-info">
                                <div class="settings-icon">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="settings-row-title">ÿßŸÑÿ£ÿµŸàÿßÿ™</h3>
                                    <p class="settings-row-desc">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖÿ§ÿ´ÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©</p>
                                </div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sound-toggle" onchange="toggleMute()" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <!-- Theme Control -->
                        <div class="settings-row">
                            <div class="settings-row-info">
                                <div class="settings-icon">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="settings-row-title">ÿßŸÑŸÖÿ∏Ÿáÿ± ÿßŸÑÿØÿßŸÉŸÜ</h3>
                                    <p class="settings-row-desc">ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä</p>
                                </div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <!-- Divider -->
                        <div class="settings-divider"></div>
                        
                        <!-- Danger Zone - Reset Game -->
                        <div class="settings-row settings-danger" onclick="confirmReset()">
                            <div class="settings-row-info">
                                <div class="settings-icon settings-icon-danger">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="settings-row-title text-red-400">ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h3>
                                    <p class="settings-row-desc text-red-300/60">ŸÖÿ≥ÿ≠ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ŸàÿßŸÑŸÜŸÇÿßÿ∑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ</p>
                                </div>
                            </div>
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="settings-footer">
                        <p class="text-white/40 text-xs font-medium">El Partyta v1.0</p>
                        <p class="text-white/30 text-xs mt-1">ÿµŸèŸÜÿπ ÿ®ŸÄ ‚ù§Ô∏è ŸÖŸÜ ÿ£ÿ¨ŸÑ ÿßŸÑŸÑŸÖÿ©</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let gameInterval = null;
        let tipsInterval = null; // For Spy game discussion tips
        let activeIntervals = []; // PATCH 1: Track all intervals for cleanup
        let buttonCooldowns = {}; // PATCH 3: Track button cooldown timestamps 

        // ===== STATE =====
        let state = {
            screen: 'home',
            isMuted: false,
            daresEnabled: false,
            teamMode: false, // Ÿàÿ∂ÿπ ÿßŸÑŸÅÿ±ŸÇ
            teamsSetupTab: 'A', // ÿßŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑŸÜÿ¥ÿ∑ ŸÅŸä ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÅÿ±ŸÇ
            players: [
                { id: 1, name: 'ÿßŸÑŸÑÿßÿπÿ® Ÿ°', score: 0 },
                { id: 2, name: 'ÿßŸÑŸÑÿßÿπÿ® Ÿ¢', score: 0 },
                { id: 3, name: 'ÿßŸÑŸÑÿßÿπÿ® Ÿ£', score: 0 }
            ],
            teams: [
                { id: 'A', name: 'ŸÅÿ±ŸäŸÇ ÿ£', score: 0, color: 'text-rose-600', members: [] },
                { id: 'B', name: 'ŸÅÿ±ŸäŸÇ ÿ®', score: 0, color: 'text-indigo-600', members: [] }
            ],
            turnQueue: [], // For fair distribution
            usedItems: {}, // Track used content per category (No-Repeat System)
            lastSpyIndex: undefined, // POLISH FIX 2: Track last spy to avoid repeats
            currentGame: null
        };

        // ===== GLOBAL HELPER FUNCTIONS (SECURITY PATCHES) =====
        
        // PATCH 1: Clear all tracked intervals to prevent memory leaks
        function clearAllIntervals() {
            activeIntervals.forEach(id => {
                if (id) clearInterval(id);
            });
            activeIntervals = [];
            
            // Also clear the legacy global intervals
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            if (tipsInterval) {
                clearInterval(tipsInterval);
                tipsInterval = null;
            }
            if (window.tipsInterval) {
                clearInterval(window.tipsInterval);
                window.tipsInterval = null;
            }
        }
        
        // PATCH 3: Button debouncing wrapper to prevent spam clicks
        function withCooldown(fnName, fn, cooldownMs = 300) {
            return function(...args) {
                const now = Date.now();
                if (buttonCooldowns[fnName] && (now - buttonCooldowns[fnName] < cooldownMs)) {
                    console.warn(`üö´ ${fnName} called too quickly. Ignoring.`);
                    return;
                }
                buttonCooldowns[fnName] = now;
                return fn.apply(this, args);
            };
        }
        
        // PATCH 5: Validate minimum players before starting games
        function validateMinPlayers(min = 2) {
            if (!state.players || state.players.length < min) {
                alert(`‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸáŸÜÿßŸÉ ${min} ŸÑÿßÿπÿ®ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿπÿ® Ÿáÿ∞Ÿá ÿßŸÑŸÑÿπÿ®ÿ©!`);
                navigate('players');
                return false;
            }
            return true;
        }
        
        // POLISH FIX 4: Toast Notification System
        function showToast(message, type = 'info') {
            // Remove any existing toasts first
            const existingToasts = document.querySelectorAll('.game-toast');
            existingToasts.forEach(t => t.remove());
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'game-toast';
            
            // Set colors based on type
            const colors = {
                success: 'bg-emerald-500',
                warning: 'bg-orange-500',
                error: 'bg-rose-500',
                info: 'bg-indigo-500',
                point: 'bg-yellow-500'
            };
            
            const icons = {
                success: '‚úì',
                warning: '‚ö†Ô∏è',
                error: '‚úó',
                info: '‚ÑπÔ∏è',
                point: '+1'
            };
            
            const bgColor = colors[type] || colors.info;
            const icon = icons[type] || icons.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%) translateY(-100px);
                z-index: 99999;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                color: white;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 16px;
                transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                pointer-events: none;
            `;
            
            toast.classList.add(bgColor);
            toast.innerHTML = `<span style="font-size: 18px;">${icon}</span> ${escapeHtml(message)}`;
            
            document.body.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });
            
            // Remove after 2.5 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(-100px)';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // ===== LOCAL STORAGE FUNCTIONS =====
        function saveState() {
            try {
                localStorage.setItem('party_game_v1', JSON.stringify(state));
            } catch (e) {
                console.error('Save failed:', e);
                alert('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÖŸÖÿ™ŸÑÿ¶ÿ©.');
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('party_game_v1');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    
                    // ===== PATCH 4: STATE INTEGRITY VALIDATION =====
                    
                    // Validate players array
                    if (!Array.isArray(parsed.players)) {
                        throw new Error('Invalid players data structure');
                    }
                    
                    // Sanitize and validate each player
                    parsed.players = parsed.players.map(p => {
                        // Ensure valid structure
                        if (!p || typeof p !== 'object') {
                            return { id: Date.now(), name: 'ŸÑÿßÿπÿ®', score: 0 };
                        }
                        
                        return {
                            id: typeof p.id === 'number' ? p.id : Date.now(),
                            name: escapeHtml(String(p.name || 'ŸÑÿßÿπÿ®').substring(0, 20)),
                            score: Math.max(0, Math.min(9999, Number(p.score) || 0)), // Clamp 0-9999
                            teamId: p.teamId // Preserve team assignment
                        };
                    });
                    
                    // Validate teams array
                    if (Array.isArray(parsed.teams)) {
                        parsed.teams = parsed.teams.map(t => ({
                            ...t,
                            score: Math.max(0, Math.min(9999, Number(t.score) || 0)), // Clamp team scores
                            members: Array.isArray(t.members) ? t.members : []
                        }));
                    }
                    
                    // Validate boolean flags
                    if (typeof parsed.teamMode !== 'boolean') parsed.teamMode = false;
                    if (typeof parsed.isMuted !== 'boolean') parsed.isMuted = false;
                    if (typeof parsed.daresEnabled !== 'boolean') parsed.daresEnabled = false;
                    
                    // ===== END PATCH 4 =====
                    
                    // Merge saved state with defaults to ensure all fields exist
                    state = { ...state, ...parsed };
                    
                    // Reload Protection: Check for active game
                    if (state.currentGame && state.currentGame.phase && state.currentGame.phase !== 'result') {
                        const resume = confirm('üéÆ ŸáŸÜÿßŸÉ ŸÑÿπÿ®ÿ© ÿ¨ÿßÿ±Ÿäÿ©!\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ŸÉŸÖÿßŸÑŸáÿßÿü\n\n(ÿßÿÆÿ™ÿ± "ÿ•ŸÑÿ∫ÿßÿ°" ŸÑŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©)');
                        if (!resume) {
                            // User chose to abandon game
                            state.currentGame = null;
                            state.screen = 'home';
                        }
                        // If resume = true, keep currentGame and screen as-is
                    } else {
                        // No active game or game finished - always start at home
                        state.screen = 'home';
                    }
                    
                    // Recalculate team scores from player scores (ensures data integrity)
                    if (state.teamMode) {
                        recalculateTeamScores();
                    }
                    
                    // Ensure queues are properly restored
                    if (!state.turnQueue) state.turnQueue = [];
                    if (!state.usedItems) state.usedItems = {};
                }
            } catch (e) {
                console.error('‚ùå Load failed - Data corrupted:', e);
                // Reset to safe defaults on corruption
                localStorage.removeItem('party_game_v1');
                alert('‚ö†Ô∏è ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿßŸÑŸÅÿ©. ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÑÿπÿ®ÿ© ÿ•ŸÑŸâ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©.');
                // State already has safe defaults from initialization
            }
        }

        // ===== AUDIO =====
        // Initialize Audio Context
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration) {
            if (state.isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume(); // Fix for Chrome autoplay policy

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = type; // 'sine', 'square', 'sawtooth', 'triangle'
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSound(type) {
            if (state.isMuted) return;

            switch (type) {
                case 'tick':
                    playTone(800, 'square', 0.05); // Short tick
                    break;
                case 'click':
                    playTone(600, 'sine', 0.05); // Soft click
                    break;
                case 'success':
                    // High pitch "Ding"
                    playTone(1200, 'sine', 0.1);
                    setTimeout(() => playTone(1800, 'sine', 0.2), 100);
                    break;
                case 'fail':
                    // Low pitch "Buzz"
                    playTone(300, 'sawtooth', 0.3);
                    setTimeout(() => playTone(250, 'sawtooth', 0.3), 150);
                    break;
                case 'bomb':
                    // Rapid warning beeps
                    playTone(800, 'square', 0.1);
                    setTimeout(() => playTone(600, 'square', 0.3), 100);
                    break;
                case 'bomb_tick':
                    // Short urgent beep for bomb timer
                    playTone(1000, 'square', 0.08);
                    break;
                case 'explode':
                    // Explosion effect - descending noise
                    playTone(200, 'sawtooth', 0.5);
                    setTimeout(() => playTone(100, 'sawtooth', 0.5), 100);
                    break;
                case 'win':
                    // Victory melody
                    playTone(500, 'sine', 0.2);
                    setTimeout(() => playTone(700, 'sine', 0.2), 200);
                    setTimeout(() => playTone(1000, 'sine', 0.4), 400);
                    break;
            }
        }

        // ===== HELPERS =====
        // Security: HTML Escaping to prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            
            // Update toggle switch in settings
            const soundToggle = document.getElementById('sound-toggle');
            if (soundToggle) {
                soundToggle.checked = !state.isMuted;
            }
            
            saveState();
            playSound('click');
        }
        
        // Settings Modal Functions
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            const soundToggle = document.getElementById('sound-toggle');
            const themeToggle = document.getElementById('theme-toggle');
            
            // Sync toggle states with current state
            if (soundToggle) soundToggle.checked = !state.isMuted;
            if (themeToggle) themeToggle.checked = document.body.classList.contains('dark-mode');
            
            modal.classList.add('active');
            playSound('click');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }
        
        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            
            // Add closing animation
            modal.classList.add('closing');
            
            setTimeout(() => {
                modal.classList.remove('active', 'closing');
                document.body.style.overflow = '';
            }, 300);
            
            playSound('click');
        }
        
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            
            if (themeToggle.checked) {
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
            
            playSound('click');
        }
        
        function confirmReset() {
            // Close settings first
            closeSettings();
            
            // Wait for close animation to finish
            setTimeout(() => {
                // Show beautiful confirmation dialog
                const confirmed = confirm('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±!\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü\n\nÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠:\n‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ\n‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸÇÿßÿ∑\n‚Ä¢ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÅÿ±ŸÇ\n‚Ä¢ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÑÿπÿßÿ®\n\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!');
                
                if (confirmed) {
                    // Clear all data
                    clearAllPlayers();
                    
                    // Show success feedback
                    playSound('success');
                    
                    // Navigate to home
                    navigate('home');
                    
                    // Optional: Show success toast
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-green-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[100] animate-in';
                    toast.innerText = '‚úì ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠';
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.3s';
                        setTimeout(() => toast.remove(), 300);
                    }, 2500);
                }
            }, 350);
        }
        
        function updateBottomNav() {
            // Update active state based on current screen
            const navButtons = {
                'home': document.getElementById('nav-home'),
                'players': document.getElementById('nav-players'),
                'scores': document.getElementById('nav-scores')
            };
            
            // Remove active class from all
            Object.values(navButtons).forEach(btn => {
                if (btn) btn.classList.remove('active');
            });
            
            // Add active class to current screen
            const currentScreen = state.screen;
            if (navButtons[currentScreen]) {
                navButtons[currentScreen].classList.add('active');
            }
        }
        function goHome() { 
            playSound('click'); 
            
            // PATCH 1: Clear ALL intervals to prevent memory leaks
            clearAllIntervals();
            
            state.currentGame = null; 
            saveState();
            navigate('home'); 
        }
        // Navigate with instant snappy transition
        function navigate(screen) { 
            playSound('click'); 
            
            // PATCH 1: Stop any running game timers immediately
            clearAllIntervals();
            
            state.screen = screen; 
            render(); // Immediate render with entry animation
        }

        // Random Game Selector (Stable - Hardcoded Game List)
        function surpriseMe() {
            // STABLE GAME LIST: Hardcoded array (no DOM dependency)
            const ALL_GAME_IDS = [
                { id: 'lawyer_setup', name: 'ÿßŸÑŸÖÿ≠ÿßŸÖŸä ÿßŸÑŸÑÿπŸäŸÜ', emoji: 'üë®‚Äç‚öñÔ∏è', color: 'bg-slate-700' },
                { id: 'indian_setup', name: 'ÿ≥ŸäŸÜÿßÿ±ŸäŸà ŸáŸÜÿØŸä', emoji: 'üé¨', color: 'bg-orange-600' },
                { id: 'bomb_setup', name: 'ÿßŸÑŸÇŸÜÿ®ŸÑÿ©', emoji: 'üí£', color: 'bg-red-700' },
                { id: 'taboo_setup', name: 'ÿ£ŸàÿπŸâ ÿ™ŸÇŸàŸÑŸáÿß', emoji: 'üö´', color: 'bg-rose-900' },
                { id: 'story_setup', name: 'ÿ≠ŸÉÿßŸäÿ© ŸÅŸä ŸÉŸÑŸÖÿ™ŸäŸÜ', emoji: 'üìñ', color: 'bg-amber-600' },
                { id: 'artist_setup', name: 'ÿßŸÑÿ±ÿ≥ÿßŸÖ ÿßŸÑÿ£ÿπŸÖŸâ', emoji: 'üé®', color: 'bg-fuchsia-600' },
                { id: 'morph_setup', name: 'ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ™ÿ≠ŸàŸÑÿ©', emoji: 'üî§', color: 'bg-cyan-700' },
                { id: 'whisper_setup', name: 'ÿ•ŸÇÿ±ÿ£ ÿ¥ŸÅÿßŸäŸÅŸä', emoji: 'üéß', color: 'bg-pink-500' },
                { id: 'debate_setup', name: 'ŸÖÿ≠ŸÉŸÖÿ©', emoji: '‚öñÔ∏è', color: 'bg-amber-700' },
                { id: 'never_setup', name: 'ÿ£ŸÜÿß ÿπŸÖÿ±Ÿä ŸÖÿß', emoji: '‚úã', color: 'bg-rose-800' },
                { id: 'heads_up_setup', name: 'ÿπŸÑŸâ ÿ±ÿßÿ≥Ÿä', emoji: 'ü§Ø', color: 'bg-blue-600' },
                { id: 'emoji_setup', name: 'ŸÅŸÉ ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä', emoji: 'üß©', color: 'bg-yellow-500' },
                { id: 'lyrics_setup', name: 'ŸÉŸÖŸÑ ÿßŸÑÿ£ÿ∫ŸÜŸäÿ©', emoji: 'üé§', color: 'bg-purple-500' },
                { id: 'unscramble_setup', name: 'ÿ±ÿ™ÿ®Ÿáÿß ÿµÿ≠', emoji: 'üîÄ', color: 'bg-green-600' },
                { id: 'five_second_setup', name: 'ÿÆŸÖÿ≥ÿ© ÿπŸÑŸäŸÉ', emoji: '‚è±Ô∏è', color: 'bg-teal-600' },
                { id: 'spy_setup', name: 'ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥', emoji: 'üïµÔ∏è', color: 'bg-indigo-600' },
                { id: 'charades_setup', name: 'ÿ®ÿØŸàŸÜ ŸÉŸÑÿßŸÖ', emoji: 'üé≠', color: 'bg-rose-600' },
                { id: 'quotes_setup', name: 'ÿßŸÑÿßŸÅŸäŸáÿßÿ™', emoji: 'üé¨', color: 'bg-emerald-600' },
                { id: 'bus_setup', name: 'ÿ£Ÿàÿ™Ÿàÿ®Ÿäÿ≥', emoji: 'üöå', color: 'bg-purple-600' },
                { id: 'liar_setup', name: 'ÿßŸÑŸÉÿØÿßÿ®', emoji: 'üÉè', color: 'bg-orange-600' },
                { id: 'auction_setup', name: 'ÿßŸÑŸÖÿ≤ÿßÿØ', emoji: 'üî®', color: 'bg-cyan-600' },
                { id: 'gibberish_setup', name: 'ŸÅŸÉ ÿßŸÑÿ¥ŸÅÿ±ÿ©', emoji: 'üó£Ô∏è', color: 'bg-pink-600' },
                { id: 'hum_setup', name: 'ÿ∑ÿ±ÿ®ŸÜŸä', emoji: 'üéµ', color: 'bg-yellow-600' },
                { id: 'likely_setup', name: 'ŸÖŸäŸÜ ÿßŸÑŸÉÿßÿ±ÿ´ÿ©', emoji: 'üëâ', color: 'bg-red-600' }
            ];
            
            const allGames = [...ALL_GAME_IDS]; // Clone the array
            
            console.log('‚úÖ Discovered games:', allGames.length, allGames.map(g => g.id));
            
            // Fisher-Yates shuffle for true randomness
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            // Pick the winner FIRST
            const winner = allGames[Math.floor(Math.random() * allGames.length)];
            console.log('üéØ Winner selected:', winner.id, winner.name);
            
            // Shuffle and pick 9 UNIQUE games for the grid
            const shuffled = shuffleArray(allGames);
            let gridGames = [];
            
            // Add winner first
            gridGames.push(winner);
            
            // Add 8 more unique games (different from winner)
            for (let i = 0; i < shuffled.length && gridGames.length < 9; i++) {
                if (shuffled[i].id !== winner.id) {
                    gridGames.push(shuffled[i]);
                }
            }
            
            // Final shuffle of the grid so winner isn't always first
            gridGames = shuffleArray(gridGames);
            
            console.log('üìã Grid games:', gridGames.map(g => g.id));
            
            // Create lightweight overlay (solid background, no blur)
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(255, 255, 255, 0.95);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease-out;
            `;
            
            // Create container
            const container = document.createElement('div');
            container.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 24px;
                padding: 24px;
            `;
            
            // Add title
            const title = document.createElement('div');
            title.style.cssText = `
                font-size: 28px;
                font-weight: 900;
                color: #1e293b;
                text-align: center;
            `;
            title.textContent = 'üé≤ ŸÅÿßÿ¨ÿ¶ŸÜŸä üé≤';
            container.appendChild(title);
            
            // Create 3x3 grid
            const grid = document.createElement('div');
            grid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                width: 320px;
            `;
            
            // Create game cards with lightweight styling
            gridGames.forEach((game, index) => {
                const card = document.createElement('div');
                card.className = `roulette-card ${game.color}`;
                card.style.cssText = `
                    width: 100px;
                    height: 100px;
                    border-radius: 16px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    border: 4px solid transparent;
                    transition: border-color 0.15s ease;
                `;
                card.dataset.index = index;
                card.innerHTML = `
                    <div style="font-size: 40px; margin-bottom: 4px;">${game.emoji}</div>
                    <div style="font-size: 12px; font-weight: bold; text-align: center; padding: 0 8px; line-height: 1.2;">${game.name}</div>
                `;
                grid.appendChild(card);
            });
            
            container.appendChild(grid);
            
            // Result text (hidden initially)
            const resultText = document.createElement('div');
            resultText.style.cssText = `
                font-size: 22px;
                font-weight: bold;
                color: #1e293b;
                text-align: center;
                min-height: 32px;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            container.appendChild(resultText);
            
            overlay.appendChild(container);
            document.body.appendChild(overlay);
            
            // Trigger fade-in
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
            });
            
            // Roulette animation logic (optimized)
            let currentIndex = -1;
            let iterations = 0;
            const totalIterations = 20; // Reduced for better performance
            const startDelay = 100; // Start at 100ms (not faster)
            const maxDelay = 300; // End at 300ms
            
            const cards = grid.querySelectorAll('.roulette-card');
            const winnerIndex = gridGames.findIndex(g => g.id === winner.id);
            
            function setActiveCard(index) {
                // Remove active state from all cards (lightweight operation)
                cards.forEach(card => {
                    card.style.borderColor = 'transparent';
                    card.style.backgroundColor = '';
                });
                
                // Add active state to current card (simple border change only)
                if (index >= 0) {
                    const card = cards[index];
                    card.style.borderColor = '#fcd34d'; // Yellow border
                    card.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    
                    // Play tick sound (only if not near end)
                    if (iterations < totalIterations - 3) {
                        playTone(700, 'sine', 0.03);
                    }
                }
            }
            
            function animate() {
                iterations++;
                
                // Calculate delay with linear slowdown (simpler math)
                const progress = iterations / totalIterations;
                const delay = startDelay + (maxDelay - startDelay) * progress;
                
                // Decide next index
                if (iterations < totalIterations - 3) {
                    // Random jump
                    currentIndex = Math.floor(Math.random() * 9);
                } else if (iterations < totalIterations) {
                    // Last few jumps, hover near winner
                    const neighbors = [
                        winnerIndex,
                        (winnerIndex + 1) % 9,
                        (winnerIndex - 1 + 9) % 9
                    ];
                    currentIndex = neighbors[Math.floor(Math.random() * neighbors.length)];
                } else {
                    // Final stop on winner
                    currentIndex = winnerIndex;
                    stopAnimation();
                    return;
                }
                
                setActiveCard(currentIndex);
                setTimeout(animate, delay);
            }
            
            function stopAnimation() {
                // Final highlight on winner
                setActiveCard(winnerIndex);
                
                // Winner effects (lightweight)
                setTimeout(() => {
                    const winnerCard = cards[winnerIndex];
                    
                    // Simple flash effect (toggle border thickness)
                    let flashCount = 0;
                    const flashInterval = setInterval(() => {
                        if (flashCount % 2 === 0) {
                            winnerCard.style.borderWidth = '6px';
                            winnerCard.style.borderColor = '#fbbf24';
                        } else {
                            winnerCard.style.borderWidth = '4px';
                            winnerCard.style.borderColor = '#fcd34d';
                        }
                        flashCount++;
                        if (flashCount >= 6) {
                            clearInterval(flashInterval);
                            winnerCard.style.borderWidth = '6px';
                            winnerCard.style.borderColor = '#fbbf24';
                        }
                    }, 150);
                    
                    // Play success sound
                    playSound('correct');
                    
                    // Show confetti
                    createConfetti();
                    
                    // Show result text
                    resultText.textContent = winner.name;
                    resultText.style.opacity = '1';
                    
                    // Navigate after delay
                    setTimeout(() => {
                        overlay.style.opacity = '0';
                        setTimeout(() => {
                            document.body.removeChild(overlay);
                            
                            // ROBUST NAVIGATION: Verify winner ID before navigating
                            console.log('üöÄ Navigating to winner:', winner.id, '(' + winner.name + ')');
                            
                            // Double-check the ID is valid
                            if (!winner.id || !winner.id.includes('_setup')) {
                                console.error('‚ùå Invalid winner ID:', winner.id);
                                navigate('home');
                                return;
                            }
                            
                            // Navigate using the exact ID extracted from DOM
                            navigate(winner.id);
                        }, 300);
                    }, 1000);
                }, 100);
            }
            
            // Start animation after brief delay
            setTimeout(() => {
                animate();
            }, 400);
        }

        // Create floating +1 animation
        function createFloatingPoint(x, y, points) {
            const el = document.createElement('div');
            el.className = 'floating-point';
            el.textContent = `+${points}`;
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            document.body.appendChild(el);
            
            // Remove after animation
            setTimeout(() => el.remove(), 1500);
        }

        // Create confetti burst
        function createConfetti() {
            const colors = ['#f43f5e', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'];
            const confettiCount = 30;
            
            for (let i = 0; i < confettiCount; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-particle';
                el.style.left = `${Math.random() * 100}%`;
                el.style.top = '-10px';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.animationDelay = `${Math.random() * 0.5}s`;
                el.style.animationDuration = `${1.5 + Math.random()}s`;
                document.body.appendChild(el);
                
                // Remove after animation
                setTimeout(() => el.remove(), 3000);
            }
        }

        // Dynamic Team Score Calculation
        function recalculateTeamScores() {
            state.teams.forEach(team => {
                let total = 0;
                team.members.forEach(member => {
                    // Find the up-to-date player object from the master list
                    const realPlayer = state.players.find(p => p.id === member.id);
                    if (realPlayer) {
                        total += realPlayer.score;
                    }
                });
                team.score = total;
            });
        }

        function updateScore(id, isTeam, points = 1) {
            // 1. Update Player Score (Master Record)
            const playerIndex = state.players.findIndex(p => p.id === id);
            if (playerIndex !== -1) {
                state.players[playerIndex].score += points;
                
                // POLISH FIX 4: Show toast notification for points
                const player = state.players[playerIndex];
                const pointText = points > 0 ? `+${points}` : `${points}`;
                showToast(`${player.name}: ${pointText} ŸÜŸÇÿ∑ÿ©`, points > 0 ? 'point' : 'warning');
                
                // Visual feedback: Floating point animation
                const x = window.innerWidth / 2;
                const y = window.innerHeight / 2;
                createFloatingPoint(x, y, points);
                
                // Confetti for player milestone (every 5 points)
                if (state.players[playerIndex].score % 5 === 0 && points > 0) {
                    createConfetti();
                }
            }

            // 2. Recalculate Team Scores based on new player totals
            if (state.teamMode) {
                recalculateTeamScores();
                
                // Check for Team Confetti (Milestones)
                state.teams.forEach(t => {
                    if (t.score > 0 && t.score % 5 === 0 && points > 0) {
                        // Team milestone reached
                        createConfetti();
                    }
                });
            }

            playSound('success');
            saveState();
            render(); // Update UI to show new scores
        }
        function showDare() {
            const dare = getUniqueItem('dares', DARES_LIST);
            playSound('fail');
            const modal = `<div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center border-4 border-red-500"><h2 class="text-2xl font-black text-red-600 mb-2">ÿπŸÇŸÄŸÄŸÄŸÄÿßÿ®!</h2><p class="text-xl font-bold text-slate-800 mb-6">"${dare}"</p><button onclick="this.closest('.fixed').remove()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">ŸÜŸÅÿ∞ÿ™ ÿÆŸÑÿßÿµ</button></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        function getTimer(time) {
            if (time >= 60) { const mins = Math.floor(time / 60); const secs = time % 60; return `${mins}:${secs < 10 ? '0' : ''}${secs}`; }
            return time;
        }
        function header(title, backTo) {
            let teamBadge = '';
            if (state.teamMode && state.currentGame && state.currentGame.player) {
                const playerId = state.currentGame.player.id;
                const currentTeam = state.teams.find(t => t.members.some(m => m.id === playerId));
                if (currentTeam) {
                    const isTeamA = currentTeam.id === 'A';
                    const bgClass = isTeamA ? 'bg-rose-400/20 border-rose-400/30 text-rose-400' : 'bg-indigo-400/20 border-indigo-400/30 text-indigo-400';
                    teamBadge = `<div class="px-3 py-1.5 rounded-lg border ${bgClass} flex items-center gap-2 shadow-sm animate-in"><span class="text-xs font-black">ÿØŸàÿ± ${currentTeam.name}</span></div>`;
                }
            }
            return `<div class="flex flex-col gap-2 py-3 mb-2 border-b border-slate-700"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><button onclick="navigate('${backTo}')" class="p-2.5 bg-slate-700 rounded-xl hover:bg-slate-600 text-slate-200 transition active:scale-95"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button><h1 class="text-xl font-black text-white tracking-tight">${title}</h1></div>${teamBadge}</div></div>`;
        }

        // --- Fair Turn Logic (Strict Queue System) ---
        function getFairPlayer() {
            // Safety check
            if (!state.players || state.players.length === 0) return { id: 0, name: 'ŸÑÿßÿπÿ®' };

            // If queue is empty or invalid, create a new shuffled deck of players
            if (!state.turnQueue || state.turnQueue.length === 0) {
                // Create a shallow copy of players
                let newQueue = [...state.players];
                // Fisher-Yates Shuffle
                for (let i = newQueue.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newQueue[i], newQueue[j]] = [newQueue[j], newQueue[i]];
                }
                state.turnQueue = newQueue;
            }

            // Pop the next player
            return state.turnQueue.pop();
        }

        // --- No-Repeat Content System (Deck Logic) ---
        function getUniqueItem(categoryKey, sourceArray) {
            if (!state.usedItems) state.usedItems = {};
            if (!state.usedItems[categoryKey]) state.usedItems[categoryKey] = [];

            // Safety check: Prevent infinite recursion if sourceArray is empty
            if (!sourceArray || sourceArray.length === 0) {
                console.error('‚ö†Ô∏è getUniqueItem: sourceArray is empty for category:', categoryKey);
                return { word: 'ÿÆÿ∑ÿ£', text: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™', quote: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™' };
            }

            // Filter available items
            // If items are objects, we use a unique property (like 'word' or 'id'), otherwise use the item itself
            const used = state.usedItems[categoryKey];
            
            // Helper to get ID/String for comparison
            const getId = (item) => (typeof item === 'object' ? (item.word || item.text || item.quote || JSON.stringify(item)) : item);

            const available = sourceArray.filter(item => !used.includes(getId(item)));

            if (available.length === 0) {
                // Deck exhausted! Reset.
                state.usedItems[categoryKey] = [];
                
                // POLISH FIX 5: Show "Deck Reshuffled" visual feedback
                showToast('ÿ™ŸÖ ÿÆŸÑÿ∑ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ üîÑ', 'info');
                console.log('üîÑ Deck reshuffled for category:', categoryKey);
                
                // Safety check after reset: If still no items, return first item
                if (sourceArray.length === 0) {
                    console.error('‚ö†Ô∏è getUniqueItem: Still no items after reset for category:', categoryKey);
                    showToast('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©!', 'error');
                    return { word: 'ÿÆÿ∑ÿ£', text: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™', quote: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™' };
                }
                
                // Pick from fresh deck
                const picked = sourceArray[Math.floor(Math.random() * sourceArray.length)];
                state.usedItems[categoryKey].push(getId(picked));
                return picked;
            }

            // Pick random from available
            const picked = available[Math.floor(Math.random() * available.length)];
            
            // Mark as used
            state.usedItems[categoryKey].push(getId(picked));
            
            return picked;
        }

        // --- NEW: Unified Game Start Screen ---
        function renderGameStartScreen(title, description, emoji, buttonText, startAction, colorClass) {
            return `
                <div class="p-6 h-screen flex flex-col bg-slate-800">
                    ${header(title, 'home')}
                    <div class="flex-1 flex flex-col justify-center items-center text-center">
                        <div class="text-6xl mb-6">${emoji}</div>
                        <h2 class="text-2xl font-bold text-white mb-4">${title}</h2>
                        <p class="text-slate-300 max-w-sm mb-8 font-medium leading-relaxed">${description}</p>
                        <button onclick="${startAction}" class="w-full py-4 ${colorClass} text-white rounded-3xl font-bold text-xl shadow-xl transition transform active:scale-95 hover:brightness-110">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== RENDER =====
        function render() {
            const container = document.getElementById('screen-container');
            
            // Render the appropriate screen
            if (state.screen === 'home') container.innerHTML = renderHome();
            else if (state.screen === 'players') container.innerHTML = renderPlayers();
            else if (state.screen === 'scores') container.innerHTML = renderScores();
            else if (state.screen === 'teams_setup') container.innerHTML = renderTeamsSetup();
            // Games Setup
            else if (state.screen === 'lawyer_setup') container.innerHTML = renderLawyerSetup();
            else if (state.screen === 'indian_setup') container.innerHTML = renderIndianSetup();
            else if (state.screen === 'bomb_setup') container.innerHTML = renderBombSetup();
            else if (state.screen === 'taboo_setup') container.innerHTML = renderTabooSetup();
            else if (state.screen === 'story_setup') container.innerHTML = renderStorySetup();
            else if (state.screen === 'morph_setup') container.innerHTML = renderMorphSetup();
            else if (state.screen === 'artist_setup') container.innerHTML = renderArtistSetup();
            else if (state.screen === 'whisper_setup') container.innerHTML = renderWhisperSetup();
            else if (state.screen === 'never_setup') container.innerHTML = renderNeverSetup();
            else if (state.screen === 'debate_setup') container.innerHTML = renderDebateSetup();
            else if (state.screen === 'heads_up_setup') container.innerHTML = renderHeadsUpSetup();
            else if (state.screen === 'emoji_setup') container.innerHTML = renderEmojiSetup();
            else if (state.screen === 'lyrics_setup') container.innerHTML = renderLyricsSetup();
            else if (state.screen === 'unscramble_setup') container.innerHTML = renderUnscrambleSetup();
            else if (state.screen === 'spy_setup') container.innerHTML = renderSpySetup();
            else if (state.screen === 'charades_setup') container.innerHTML = renderCharadesSetup();
            else if (state.screen === 'quotes_setup') container.innerHTML = renderQuotesSetup();
            else if (state.screen === 'five_second_setup') container.innerHTML = renderFiveSecondSetup();
            else if (state.screen === 'bus_setup') container.innerHTML = renderBusSetup();
            else if (state.screen === 'liar_setup') container.innerHTML = renderLiarSetup();
            else if (state.screen === 'auction_setup') container.innerHTML = renderAuctionSetup();
            else if (state.screen === 'gibberish_setup') container.innerHTML = renderGibberishSetup();
            else if (state.screen === 'hum_setup') container.innerHTML = renderHumSetup();
            else if (state.screen === 'likely_setup') container.innerHTML = renderLikelySetup();
            
            // Force animation replay on every render
            container.classList.remove('animate-enter');
            void container.offsetWidth; // Trigger reflow (magic!)
            container.classList.add('animate-enter');
            
            // Update bottom navigation active state
            updateBottomNav();
        }

        function renderHome() {
            return `
                <div class="flex flex-col h-screen p-4 bg-slate-800">
                    <div class="text-center pt-8 pb-4"><h1 class="text-4xl font-black text-white mb-1">ŸÑÿπÿ®ÿ© ÿßŸÑŸÇÿπÿØÿ©</h1><p class="text-slate-300 font-medium">ÿßŸÑŸÑŸÖÿ© ŸÖÿ™ÿ≠ŸÑÿßÿ¥ ÿ∫Ÿäÿ± ÿ®ŸäŸáÿß</p></div>
                    
                    <!-- Surprise Me Button - NEON STYLE -->
                    <button onclick="surpriseMe()" class="w-full py-4 mb-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-3xl font-black text-xl shadow-lg shadow-purple-500/50 border border-purple-400/30 transition transform active:scale-95 hover:scale-[1.02] flex items-center justify-center gap-3">
                        <span class="text-3xl">üé≤</span>
                        <span>ŸÅÿßÿ¨ÿ¶ŸÜŸä! (ŸÑÿπÿ®ÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©)</span>
                    </button>
                    
                    <div class="w-full grid grid-cols-2 gap-3 flex-1 overflow-y-auto pb-2 content-start min-h-0">
                        <!-- SET 3 -->
                        ${menuButton('lawyer_setup', 'üë®‚Äç‚öñÔ∏è', 'ÿßŸÑŸÖÿ≠ÿßŸÖŸä ÿßŸÑŸÑÿπŸäŸÜ', 'ÿØÿßŸÅÿπ ÿπŸÜ ÿßŸÑŸÖÿµŸäÿ®ÿ©', 'bg-slate-700')}
                        ${menuButton('indian_setup', 'üé¨', 'ÿ≥ŸäŸÜÿßÿ±ŸäŸà ŸáŸÜÿØŸä', 'ÿ™ŸÖÿ´ŸäŸÑ Ÿàÿ£ŸàŸÅÿ±ÿ©', 'bg-orange-600')}
                        ${menuButton('bomb_setup', 'üí£', 'ÿßŸÑŸÇŸÜÿ®ŸÑÿ©', 'ÿ®ÿßÿµŸä ÿ®ÿ≥ÿ±ÿπÿ©', 'bg-red-700')}
                        ${menuButton('taboo_setup', 'üö´', 'ÿ£ŸàÿπŸâ ÿ™ŸÇŸàŸÑŸáÿß', 'ŸÖŸÖŸÜŸàÿπÿßÿ™ ŸÉÿ™Ÿäÿ±', 'bg-rose-900')}
                        <!-- SET 2 -->
                        ${menuButton('story_setup', 'üìñ', 'ÿ≠ŸÉÿßŸäÿ© ŸÅŸä ŸÉŸÑŸÖÿ™ŸäŸÜ', 'ÿ£ŸÑŸÅŸàÿß ŸÇÿµÿ©', 'bg-amber-600')}
                        ${menuButton('artist_setup', 'üé®', 'ÿßŸÑÿ±ÿ≥ÿßŸÖ ÿßŸÑÿ£ÿπŸÖŸâ', 'ÿßÿ±ÿ≥ŸÖ ŸàÿÆŸÖŸÜ', 'bg-fuchsia-600')}
                        ${menuButton('morph_setup', 'üî§', 'ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ™ÿ≠ŸàŸÑÿ©', 'ÿ∫Ÿäÿ± ÿ≠ÿ±ŸÅ', 'bg-cyan-700')}
                        <!-- SET 1 -->
                        ${menuButton('whisper_setup', 'üéß', 'ÿ•ŸÇÿ±ÿ£ ÿ¥ŸÅÿßŸäŸÅŸä', 'ÿπŸÑŸä ÿßŸÑÿµŸàÿ™', 'bg-pink-500')}
                        ${menuButton('debate_setup', '‚öñÔ∏è', 'ŸÖÿ≠ŸÉŸÖÿ©', 'ÿ•ŸÇŸÜÿßÿπ Ÿàÿ¨ÿØÿßŸÑ', 'bg-amber-700')}
                        ${menuButton('never_setup', '‚úã', 'ÿ£ŸÜÿß ÿπŸÖÿ±Ÿä ŸÖÿß', 'ŸÖŸäŸÜ ÿπŸÖŸÑÿü', 'bg-rose-800')}
                        <!-- CLASSICS -->
                        ${menuButton('heads_up_setup', 'ü§Ø', 'ÿπŸÑŸâ ÿ±ÿßÿ≥Ÿä', 'ÿ≠ÿ∑ ŸÖŸàÿ®ÿßŸäŸÑŸÉ', 'bg-blue-600')}
                        ${menuButton('emoji_setup', 'üß©', 'ŸÅŸÉ ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä', 'ÿßÿ≥ŸÖ ÿßŸÑŸÅŸäŸÑŸÖÿü', 'bg-yellow-500')}
                        ${menuButton('lyrics_setup', 'üé§', 'ŸÉŸÖŸÑ ÿßŸÑÿ£ÿ∫ŸÜŸäÿ©', 'ÿ≠ÿßŸÅÿ∏ÿü', 'bg-purple-500')}
                        ${menuButton('unscramble_setup', 'üîÄ', 'ÿ±ÿ™ÿ®Ÿáÿß ÿµÿ≠', 'ŸÉŸÑŸÖÿ© ŸÖÿ™ŸÑÿÆÿ®ÿ∑ÿ©', 'bg-green-600')}
                        ${menuButton('five_second_setup', '‚è±Ô∏è', 'ÿÆŸÖÿ≥ÿ© ÿπŸÑŸäŸÉ', '3 ÿ≠ÿßÿ¨ÿßÿ™', 'bg-teal-600')}
                        ${menuButton('spy_setup', 'üïµÔ∏è', 'ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥', 'ŸÖŸäŸÜ ÿßŸÑÿ∫ÿ±Ÿäÿ®ÿü', 'bg-indigo-600')}
                        ${menuButton('charades_setup', 'üé≠', 'ÿ®ÿØŸàŸÜ ŸÉŸÑÿßŸÖ', 'ÿ™ŸÖÿ´ŸäŸÑ', 'bg-rose-600')}
                        ${menuButton('quotes_setup', 'üé¨', 'ÿßŸÑÿßŸÅŸäŸáÿßÿ™', 'ÿ≥ŸÖŸëÿπ', 'bg-emerald-600')}
                        ${menuButton('bus_setup', 'üöå', 'ÿ£Ÿàÿ™Ÿàÿ®Ÿäÿ≥', 'ÿ≠ÿ±ŸÅ ŸàŸÅÿ¶ÿ©', 'bg-purple-600')}
                        ${menuButton('liar_setup', 'üÉè', 'ÿßŸÑŸÉÿØÿßÿ®', 'ÿßŸÖÿ≥ŸÉ ÿßŸÑŸÉÿ∞ÿ®ÿ©', 'bg-orange-600')}
                        ${menuButton('auction_setup', 'üî®', 'ÿßŸÑŸÖÿ≤ÿßÿØ', 'ŸÖŸäŸÜ Ÿäÿ≤ŸàÿØ', 'bg-cyan-600')}
                        ${menuButton('gibberish_setup', 'üó£Ô∏è', 'ŸÅŸÉ ÿßŸÑÿ¥ŸÅÿ±ÿ©', 'ŸÉŸÑÿßŸÖ ÿ∫ÿ±Ÿäÿ®', 'bg-pink-600')}
                        ${menuButton('hum_setup', 'üéµ', 'ÿ∑ÿ±ÿ®ŸÜŸä', 'ŸáŸÖŸáŸÖÿ©', 'bg-yellow-600')}
                        ${menuButton('likely_setup', 'üëâ', 'ŸÖŸäŸÜ ÿßŸÑŸÉÿßÿ±ÿ´ÿ©', 'ÿ™ŸàŸÇÿπÿßÿ™', 'bg-red-600')}
                    </div>
                </div>`;
        }

        function menuButton(screen, emoji, title, subtitle, color) { return `<button onclick="navigate('${screen}')" class="w-full aspect-square p-3 rounded-3xl shadow-xl bg-slate-700 border border-slate-600 text-white flex flex-col items-center justify-center text-center transition transform active:scale-95 hover:scale-[1.02] hover:bg-slate-600"><div class="text-5xl mb-2">${emoji}</div><div><span class="text-lg font-bold block leading-tight">${title}</span><span class="text-xs text-slate-300 block mt-1 leading-tight">${subtitle}</span></div></button>`; }
        function renderPlayers() {
            const teamActive = state.teamMode;
            return `
                <div class="p-6 h-screen flex flex-col bg-slate-800">
                    ${header('ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ', 'home')}
                    
                    <!-- Team Setup Row (ÿ∑ÿ®ŸÇÿßŸã ŸÑŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ¨ÿØŸäÿØ) -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between bg-slate-700 border border-slate-600 rounded-3xl px-3 py-2">
                            <button onclick="navigate('teams_setup')" class="px-3 py-1 bg-slate-600 rounded-xl font-bold text-xs text-white shadow-sm border border-slate-500">
                                ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÅÿ±ŸÇ
                            </button>
                            <button onclick="${teamActive ? 'deactivateTeamMode()' : 'activateTeamMode()'}" class="flex items-center gap-1 text-sm font-bold ${teamActive ? 'text-teal-400' : 'text-slate-300'}">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${teamActive ? 'bg-teal-400 text-white' : 'bg-rose-400 text-white'}">
                                    ${teamActive ? '‚úì' : '‚úï'}
                                </span>
                                <span>ŸÅÿ±ŸÇ</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Player Input Section -->
                    <form onsubmit="addPlayer(event)" class="flex items-stretch gap-3 mb-6 h-14">
                        <button type="submit" class="bg-orange-400 text-white h-full w-14 rounded-3xl font-bold flex items-center justify-center shadow-xl hover:bg-orange-500 active:scale-95 transition">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <input type="text" id="newPlayerName" placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®..." class="flex-1 h-full px-5 bg-slate-700 border-2 border-slate-600 rounded-3xl text-lg font-bold text-white placeholder-slate-400 focus:outline-none focus:border-orange-400 focus:ring-4 focus:ring-orange-400/20 transition">
                    </form>
                    
                    <!-- Players List -->
                    <div class="flex-1 overflow-y-auto space-y-3">
                        ${state.players.map(p => `
                            <div class="flex justify-between items-center bg-slate-700 p-4 rounded-3xl shadow-xl border border-slate-600">
                                <span class="font-bold text-lg text-white">${escapeHtml(p.name)}</span>
                                <button onclick="removePlayer(${p.id})" class="text-rose-400 hover:text-rose-300 transition">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Clear All / New Game Button -->
                    ${state.players.length > 0 ? `
                        <div class="mt-4 pt-4 border-t-2 border-slate-700">
                            <button onclick="clearAllPlayers()" class="w-full py-4 bg-rose-400 hover:bg-rose-500 active:scale-95 text-white rounded-3xl font-bold text-lg shadow-xl transition flex items-center justify-center gap-2">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                <span>ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ / ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©</span>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        function renderTeamsSetup() {
            const teamA = state.teams[0];
            const teamB = state.teams[1];
            return `
                <div class="flex flex-col h-screen bg-slate-800">
                    ${header('ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÅÿ±ŸÇ', 'players')}
                    <div class="flex-1 overflow-y-auto p-4 pb-32">
                        <div class="bg-slate-700 p-5 rounded-3xl shadow-xl border border-slate-600 mb-6">
                            <div class="flex items-center gap-2 mb-4 justify-center opacity-50"><span class="text-xs font-bold text-slate-300">ÿ™ÿ≥ŸÖŸäÿ© ÿßŸÑŸÅÿ±ŸÇ</span></div>
                            <div class="flex gap-4">
                                <div class="flex-1"><input type="text" value="${teamA.name}" onchange="updateTeamName('A', this.value)" class="w-full p-4 text-center font-black text-lg border-b-4 border-rose-400 rounded-3xl bg-slate-600 text-white focus:outline-none focus:bg-slate-500 focus:shadow-lg transition placeholder-slate-400" placeholder="ŸÅÿ±ŸäŸÇ ÿ£"></div>
                                <div class="flex-1"><input type="text" value="${teamB.name}" onchange="updateTeamName('B', this.value)" class="w-full p-4 text-center font-black text-lg border-b-4 border-indigo-400 rounded-3xl bg-slate-600 text-white focus:outline-none focus:bg-slate-500 focus:shadow-lg transition placeholder-slate-400" placeholder="ŸÅÿ±ŸäŸÇ ÿ®"></div>
                            </div>
                        </div>
                        <h3 class="px-2 text-slate-400 text-xs font-bold mb-3">ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ</h3>
                        <div class="space-y-3">
                            ${state.players.map(p => {
                                const inA = teamA.members.some(m => m.id === p.id);
                                const inB = teamB.members.some(m => m.id === p.id);
                                return `<div class="flex items-center justify-between bg-slate-700 p-3 pr-5 rounded-3xl shadow-xl border border-slate-600 transition hover:shadow-2xl"><span class="font-bold text-lg text-white">${escapeHtml(p.name)}</span><div class="flex gap-3"><button onclick="assignPlayerToTeam('A', ${p.id})" class="w-12 h-12 rounded-xl font-black text-lg transition-all duration-200 flex items-center justify-center ${inA ? 'bg-rose-400 text-white shadow-lg shadow-rose-400/50 transform scale-110' : 'bg-slate-600 text-slate-400 hover:bg-rose-400/20 hover:text-rose-400'}">ÿ£</button><button onclick="assignPlayerToTeam('B', ${p.id})" class="w-12 h-12 rounded-xl font-black text-lg transition-all duration-200 flex items-center justify-center ${inB ? 'bg-indigo-400 text-white shadow-lg shadow-indigo-400/50 transform scale-110' : 'bg-slate-600 text-slate-400 hover:bg-indigo-400/20 hover:text-indigo-400'}">ÿ®</button></div></div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-slate-800 via-slate-800/95 to-transparent z-50">
                        ${state.teamMode ? `<button onclick="deactivateTeamMode()" class="w-full py-4 bg-rose-400 text-white rounded-3xl font-black text-xl shadow-xl hover:bg-rose-500 active:scale-95 transition flex items-center justify-center gap-2"><span>ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑŸÅÿ±ŸÇ</span></button>` : `<button onclick="activateTeamMode()" class="w-full py-4 bg-teal-400 text-white rounded-3xl font-black text-xl shadow-xl hover:bg-teal-500 active:scale-95 transition flex items-center justify-center gap-2"><span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÑÿπÿ® ÿ®ÿßŸÑŸÅÿ±ŸÇ</span></button>`}
                    </div>
                </div>
            `;
        }
        function shareResults() {
            let shareText = 'üî• ŸÖŸÑŸàŸÉ ÿßŸÑŸÇÿπÿØÿ© ŸàÿµŸÑŸàÿß.. Ÿàÿ≥ÿπ ŸÑŸÑŸÜÿ™ÿßŸäÿ¨!\n\nüèÜ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ≠ÿßŸÑŸä:\n';
            
            if (state.teamMode) {
                const sortedTeams = [...state.teams].sort((a, b) => b.score - a.score);
                sortedTeams.forEach((t, i) => {
                    const emoji = i === 0 ? '1Ô∏è‚É£' : i === 1 ? '2Ô∏è‚É£' : '3Ô∏è‚É£';
                    shareText += `${emoji} ${t.name}: ${t.score} ŸÜŸÇÿ∑ÿ©\n`;
                });
            } else {
                const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
                sortedPlayers.slice(0, 5).forEach((p, i) => {
                    const emoji = ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£'][i];
                    shareText += `${emoji} ${escapeHtml(p.name)}: ${p.score} ŸÜŸÇÿ∑ÿ©\n`;
                });
            }
            
            shareText += '\nüé≤ ÿßŸÑÿπÿ®Ÿáÿß ŸÖÿπÿßŸÜÿß ÿØŸÑŸàŸÇÿ™Ÿä: [ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ]';
            
            // Try Web Share API first (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'ŸÑÿπÿ®ÿ© ÿßŸÑŸÇÿπÿØÿ© - ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨',
                    text: shareText
                }).catch(() => {
                    // If share cancelled or failed, fallback to clipboard
                    copyToClipboard(shareText);
                });
            } else {
                // Fallback: Copy to clipboard
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ! ÿßŸÑÿµŸÇŸáÿß ŸÅŸä ÿ£Ÿä ŸÖÿ≠ÿßÿØÿ´ÿ©');
                    playSound('success');
                });
            } else {
                // Older fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ! ÿßŸÑÿµŸÇŸáÿß ŸÅŸä ÿ£Ÿä ŸÖÿ≠ÿßÿØÿ´ÿ©');
                playSound('success');
            }
        }
        
        function renderScores() {
            if (state.teamMode) {
                const sortedTeams = [...state.teams].sort((a, b) => b.score - a.score);
                return `
                    <div class="p-6 h-screen flex flex-col bg-slate-800">
                        ${header('ŸÑŸàÿ≠ÿ© ÿßŸÑÿ¥ÿ±ŸÅ - ÿßŸÑŸÅÿ±ŸÇ', 'home')}
                        
                        <!-- Share Button -->
                        <button onclick="shareResults()" class="w-full py-3 mb-4 bg-indigo-400 text-white rounded-3xl font-bold shadow-xl hover:bg-indigo-500 transition flex items-center justify-center gap-2">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                            <span>ÿ¥ÿßÿ±ŸÉ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨</span>
                        </button>
                        
                        <div class="flex-1 overflow-y-auto space-y-4">
                            ${sortedTeams.map((t, i) => `
                                <div class="flex items-center p-4 rounded-3xl shadow-xl border border-slate-600 bg-slate-700">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ml-4 ${i === 0 ? 'bg-orange-400 text-white' : 'bg-slate-600 text-slate-300'}">${i + 1}</div>
                                    <div class="flex-1">
                                        <div class="font-bold text-lg text-white">${escapeHtml(t.name)}</div>
                                        <div class="text-sm text-slate-300 mt-1">${(t.members && t.members.length > 0) ? t.members.map(m => escapeHtml(m.name)).join(', ') : 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿπÿ∂ÿßÿ°'}</div>
                                    </div>
                                    <div class="font-black text-2xl ${t.id === 'A' ? 'text-rose-400' : 'text-indigo-400'}">${t.score}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="resetScores()" class="mt-4 w-full py-4 bg-rose-400 text-white rounded-3xl font-bold shadow-xl hover:bg-rose-500 transition">ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿπÿØÿßÿØ</button>
                    </div>
                `;
            } else {
                const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
                return `
                    <div class="p-6 h-screen flex flex-col bg-slate-800">
                        ${header('ŸÑŸàÿ≠ÿ© ÿßŸÑÿ¥ÿ±ŸÅ', 'home')}
                        
                        <!-- Share Button -->
                        <button onclick="shareResults()" class="w-full py-3 mb-4 bg-indigo-400 text-white rounded-3xl font-bold shadow-xl hover:bg-indigo-500 transition flex items-center justify-center gap-2">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                            <span>ÿ¥ÿßÿ±ŸÉ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨</span>
                        </button>
                        
                        <div class="flex-1 overflow-y-auto space-y-4">
                            ${sortedPlayers.map((p, i) => `
                                <div class="flex items-center p-4 rounded-3xl shadow-xl border border-slate-600 bg-slate-700">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ml-4 ${i === 0 ? 'bg-orange-400 text-white' : 'bg-slate-600 text-slate-300'}">${i + 1}</div>
                                    <div class="flex-1 font-bold text-lg text-white">${escapeHtml(p.name)}</div>
                                    <div class="font-black text-2xl text-indigo-400">${p.score}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="resetScores()" class="mt-4 w-full py-4 bg-rose-400 text-white rounded-3xl font-bold shadow-xl hover:bg-rose-500 transition">‚ö†Ô∏è ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿπÿØÿßÿØ</button>
                    </div>
                `;
            }
        }
        function addPlayer(e) { 
            e.preventDefault(); 
            const input = document.getElementById('newPlayerName');
            const raw = input.value.trim();
            
            // ===== PATCH 2: INPUT SANITIZATION =====
            
            // 1. Validate length
            if (!raw || raw.length === 0) {
                alert('‚ö†Ô∏è ÿßŸÑÿßÿ≥ŸÖ ŸÅÿßÿ±ÿ∫! ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®.');
                return;
            }
            
            if (raw.length > 20) {
                alert('‚ö†Ô∏è ÿßŸÑÿßÿ≥ŸÖ ÿ∑ŸàŸäŸÑ ÿ¨ÿØÿßŸã! (20 ÿ≠ÿ±ŸÅ ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ)');
                return;
            }
            
            // 2. Strip ALL HTML tags (defense in depth)
            const stripped = raw.replace(/<[^>]*>/g, '');
            
            // 3. Check for suspicious patterns (script injection attempts)
            const dangerous = ['script', 'onerror', 'javascript:', 'onclick', 'onload', '<', '>'];
            const lowerStripped = stripped.toLowerCase();
            for (let pattern of dangerous) {
                if (lowerStripped.includes(pattern)) {
                    alert('‚ö†Ô∏è ÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠! Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿ≠ÿ±ŸÅ ŸÖŸÖŸÜŸàÿπÿ©.');
                    return;
                }
            }
            
            // 4. Check for duplicates
            const isDuplicate = state.players.some(p => p.name === escapeHtml(stripped));
            if (isDuplicate) {
                alert('‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑÿßÿ≥ŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ!');
                return;
            }
            
            // 5. Add player with sanitized name
            state.players.push({
                id: Date.now(), 
                name: escapeHtml(stripped), 
                score: 0
            });
            
            // ===== END PATCH 2 =====
            
            input.value = ''; // Clear input field
            playSound('success');
            saveState(); 
            render(); 
        }
        function removePlayer(id) {
            // POLISH FIX 1: Graceful handling when deleting active player
            
            // Check if player is currently active in any game
            const isActivePlayer = state.currentGame && (
                (state.currentGame.player && state.currentGame.player.id === id) ||
                (state.currentGame.currentPlayer && state.currentGame.currentPlayer.id === id)
            );
            
            if (isActivePlayer) {
                // Offer to end game gracefully
                const endGame = confirm(
                    '‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑŸÑÿßÿπÿ® ŸÜÿ¥ÿ∑ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©!\n\n' +
                    'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑŸÑÿßÿπÿ®ÿü\n\n' +
                    '‚úÖ ŸÜÿπŸÖ = ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑŸÑÿßÿπÿ®\n' +
                    '‚ùå ÿ•ŸÑÿ∫ÿßÿ° = ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿπÿ®ÿ©'
                );
                
                if (!endGame) {
                    return; // User cancelled
                }
                
                // End the current game gracefully
                clearAllIntervals();
                state.currentGame = null;
                showToast('ÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©', 'warning');
            }
            
            // Check if this will leave too few players for current game
            const remainingPlayers = state.players.filter(p => p.id !== id).length;
            if (state.currentGame && remainingPlayers < 2) {
                alert('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÑÿßÿπÿ®!\n\nŸäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸáŸÜÿßŸÉ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑÿßÿπÿ®ÿßŸÜ.');
                return;
            }
            
            // Confirmation dialog before deletion
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÑÿßÿπÿ®ÿü')) {
                return; // User cancelled
            }
            
            // Get player name for toast notification
            const playerToDelete = state.players.find(p => p.id === id);
            const playerName = playerToDelete ? playerToDelete.name : 'ÿßŸÑŸÑÿßÿπÿ®';
            
            // Remove from players list
            state.players = state.players.filter(p => p.id !== id);
            
            // Remove from all teams
            state.teams.forEach(team => {
                team.members = team.members.filter(m => m.id !== id);
            });
            
            // Remove from turn queue if present
            if (state.turnQueue) {
                state.turnQueue = state.turnQueue.filter(p => p.id !== id);
            }
            
            // Recalculate team scores (deduct removed player's score)
            recalculateTeamScores();
            
            // Show success feedback
            showToast(`ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${escapeHtml(playerName)}`, 'success');
            
            // ‚ö†Ô∏è CRITICAL: Save state to persist the deletion
            saveState();
            render();
        }
        function clearAllPlayers() {
            // Confirm before clearing
            if (state.players.length > 0 && !confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ Ÿàÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ\n‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸÇÿßÿ∑\n‚Ä¢ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÅÿ±ŸÇ')) {
                return;
            }
            // Clear players array
            state.players = [];
            // Clear turn queue
            state.turnQueue = [];
            // Reset teams
            state.teams.forEach(team => {
                team.members = [];
                team.score = 0;
            });
            // Clear used items
            state.usedItems = {};
            // Clear current game
            state.currentGame = null;
            // Clear gameInterval if running
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            // Update localStorage
            saveState();
            // Play sound feedback
            playSound('click');
            // Update UI
            render();
        }
        function resetScores() { 
            // Confirmation dialog for safety
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿπÿØÿßÿØ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜÿü')) return;
            
            state.players = state.players.map(p => ({...p, score: 0}));
            state.teams = state.teams.map(t => ({...t, score: 0}));
            playSound('click');
            saveState();
            render(); 
        }
        function updateTeamName(teamId, newName) {
            const team = state.teams.find(t => t.id === teamId);
            if (team && newName.trim()) {
                team.name = newName.trim();
                playSound('click');
                saveState();
            }
        }
        function assignPlayerToTeam(teamId, playerId) {
            // 1. Find the player object
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;

            // 2. Remove player from ALL teams first (to avoid duplicates)
            state.teams.forEach(team => {
                team.members = team.members.filter(m => m.id !== playerId);
            });

            // 3. Add to the new target team
            const targetTeam = state.teams.find(t => t.id === teamId);
            if (targetTeam) {
                targetTeam.members.push(player);
            }

            // 4. Update the "teamId" property on the player object itself (for redundancy/safety)
            player.teamId = teamId;

            // 5. Recalculate team scores (player's score moves with them)
            recalculateTeamScores();

            // 6. ‚ö†Ô∏è CRITICAL: Save and Render
            playSound('click');
            saveState(); // <--- This ensures the assignment persists on refresh
            render();
        }
        function activateTeamMode() {
            const teamA = state.teams[0];
            const teamB = state.teams[1];
            
            if (teamA.members.length === 0 || teamB.members.length === 0) {
                alert('Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÑŸÉŸÑ ŸÅÿ±ŸäŸÇ ŸÑÿßÿπÿ® Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!');
                return;
            }
            
            state.teamMode = true;
            
            // Recalculate team scores when activating team mode
            recalculateTeamScores();
            
            playSound('success');
            saveState();
            render();
        }
        function deactivateTeamMode() {
            // Confirm before deactivating team mode
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑŸÅÿ±ŸÇÿü\n\n(ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÅÿ±ÿØŸäÿ© ÿ≥ÿ™ÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸä)')) {
                return;
            }
            
            state.teamMode = false;
            playSound('click');
            saveState();
            render();
        }

        // ============================================
        // =========== ALL GAME LOGIC =================
        // ============================================

        // --- LAWYER ---
        function startLawyerGame() {
            const data = getUniqueItem('lawyer', LAWYER_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'lawyer', phase: 'prepare', data, player, revealed: false, timeLeft: 30 };
            playSound('click');
            saveState();
            render();
        }
        function startLawyerRound() {
            state.currentGame.phase = 'playing';
            state.currentGame.revealed = true;
            playSound('click');
            saveState();
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                // DOM update for no flickering
                const timerEl = document.getElementById('game-timer');
                if (timerEl) timerEl.innerText = getTimer(state.currentGame.timeLeft);
                
                if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); }
                else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
        }
        function lawyerSuccess() { updateScore(state.currentGame.player.id, false, 1); startLawyerGame(); }
        function renderLawyerSetup() {
            if (!state.currentGame || state.currentGame.type !== 'lawyer') return renderGameStartScreen('ÿßŸÑŸÖÿ≠ÿßŸÖŸä ÿßŸÑŸÑÿπŸäŸÜ', 'ŸÖÿµŸäÿ®ÿ© Ÿáÿ™ÿ≠ÿµŸÑŸÉÿå ŸàŸÑÿßÿ≤ŸÖ ÿ™ÿ®ÿ±ÿ±Ÿáÿß Ÿàÿ™ÿÆÿ±ÿ¨ ŸÖŸÜŸáÿß Ÿàÿ™ÿ≥ÿ™ÿÆÿØŸÖ 3 ŸÉŸÑŸÖÿßÿ™ ŸÖŸÑŸáŸÖÿ¥ ÿπŸÑÿßŸÇÿ© ÿ®ÿßŸÑŸÖŸàÿ∂Ÿàÿπ ÿπÿ¥ÿßŸÜ ÿ™ŸÇŸÜÿπ ÿßŸÑŸÖÿ≠ŸÉŸÖÿ©!', 'üë®‚Äç‚öñÔ∏è', 'Ÿàÿ±ÿ∑ŸÜŸä!', 'startLawyerGame()', 'bg-rose-400');
            const game = state.currentGame;
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-xl text-slate-300 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p><h1 class="text-4xl font-black mb-8">${game.player.name}</h1><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600 shadow-xl w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-slate-800 z-10 flex items-center justify-center cursor-pointer hover:bg-slate-900 transition"><span class="text-xl font-bold animate-pulse">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑŸÖÿµŸäÿ®ÿ©</span></div>` : ''}<p class="text-sm mb-2 text-slate-400">ÿßŸÑŸÖÿµŸäÿ®ÿ©:</p><h2 class="text-2xl font-bold text-white leading-relaxed mb-4">${game.data.disaster}</h2><div class="border-t border-slate-600 pt-4"><p class="text-sm mb-2 text-slate-400">ŸÉŸÑŸÖÿßÿ™ ÿ•ÿ¨ÿ®ÿßÿ±Ÿäÿ©:</p><div class="flex flex-wrap gap-2 justify-center">${game.data.words.map(w=>`<span class="bg-slate-600 text-white px-3 py-1 rounded-lg">${w}</span>`).join('')}</div></div></div><button onclick="startLawyerRound()" class="w-full py-4 bg-rose-400 text-white rounded-3xl font-bold text-xl shadow-xl hover:bg-rose-500 transition" ${!game.revealed ? 'disabled opacity-50' : ''}>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ±ÿßŸÅÿπÿ©</button></div>`;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold text-slate-300">ÿßŸÑŸÖÿ™ŸáŸÖ: <span class="text-white">${game.player.name}</span></p></div><div class="bg-slate-700 p-4 rounded-3xl border border-slate-600 shadow-xl mb-6 text-center"><h1 class="text-3xl font-black leading-relaxed text-center text-white mb-2">${game.data.disaster}</h1><div class="flex flex-wrap gap-2 justify-center mt-4">${game.data.words.map(w=>`<span class="bg-slate-600 text-white px-2 py-1 rounded text-sm font-bold">${w}</span>`).join('')}</div></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-8xl font-black text-white" id="game-timer">${getTimer(game.timeLeft)}</div></div><div class="space-y-3"><button onclick="lawyerSuccess()" class="w-full py-4 bg-teal-400 text-white rounded-3xl font-bold text-xl shadow-xl hover:bg-teal-500 transition">‚úì ÿ®ÿ±ÿßÿ°ÿ© (ÿ£ŸÇŸÜÿπŸÜÿß)</button><button onclick="state.currentGame.phase='result'; render()" class="w-full py-3 bg-rose-400 text-white rounded-3xl font-bold shadow-xl hover:bg-rose-500 transition">‚úó ÿ•ÿπÿØÿßŸÖ (ŸÅÿ¥ŸÑ)</button></div></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-4">ÿ±ŸÅÿπÿ™ ÿßŸÑÿ¨ŸÑÿ≥ÿ©!</h2><button onclick="startLawyerGame()" class="w-full py-4 bg-rose-400 rounded-3xl font-bold text-xl mb-3 shadow-xl hover:bg-rose-500 transition">ŸÇÿ∂Ÿäÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 rounded-3xl font-bold shadow-xl hover:bg-slate-600 transition">ÿÆÿ±Ÿàÿ¨</button></div>`;
        }

        // --- INDIAN ACTION ---
        function startIndianGame() {
            const data = getUniqueItem('indian', INDIAN_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'indian', phase: 'prepare', data, player, revealed: false, timeLeft: 60 };
            playSound('click');
            saveState();
            render();
        }
        function startIndianRound() {
            state.currentGame.phase = 'playing';
            state.currentGame.revealed = true;
            playSound('click');
            saveState();
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                const timerEl = document.getElementById('game-timer');
                if (timerEl) timerEl.innerText = getTimer(state.currentGame.timeLeft);
                
                if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); }
                else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
        }
        function indianSuccess() { updateScore(state.currentGame.player.id, false, 1); startIndianGame(); }
        function indianFail() { 
            if (gameInterval) clearInterval(gameInterval);
            state.currentGame.phase = 'result'; 
            playSound('fail');
            saveState();
            render(); 
        }
        function renderIndianSetup() {
            if (!state.currentGame || state.currentGame.type !== 'indian') return renderGameStartScreen('ÿ≥ŸäŸÜÿßÿ±ŸäŸà ŸáŸÜÿØŸä', 'ŸÖÿ´ŸÑ ŸÖÿ¥ŸáÿØ ÿØÿ±ÿßŸÖŸä ŸÖÿπ ÿ¥ÿ±ÿ∑ ÿ•ÿÆÿ±ÿßÿ¨ ÿ∫ÿ±Ÿäÿ®! ÿ£ŸàŸÅÿ± ÿπŸÑŸâ ŸÇÿØ ŸÖÿß ÿ™ŸÇÿØÿ±!', 'üé¨', 'ÿ£ŸÉÿ¥ŸÜ!', 'startIndianGame()', 'bg-orange-400');
            const game = state.currentGame;
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-xl text-slate-300 mb-2">ÿßŸÑÿ®ÿ∑ŸÑ ÿßŸÑŸäŸàŸÖ</p><h1 class="text-4xl font-black mb-8">${game.player.name}</h1><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600 shadow-xl w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-slate-800 z-10 flex items-center justify-center cursor-pointer hover:bg-slate-900 transition"><span class="text-xl font-bold animate-pulse">üé¨ ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà</span></div>` : ''}<p class="text-sm mb-2 text-slate-400">ÿßŸÑŸÖÿ¥ŸáÿØ:</p><h2 class="text-2xl font-bold text-white leading-relaxed mb-4">${game.data.scene}</h2><div class="border-t border-slate-600 pt-4"><p class="text-sm mb-2 text-slate-400">ÿ¥ÿ±ÿ∑ ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨:</p><div class="bg-slate-600 text-white px-4 py-3 rounded-lg font-bold text-lg">${game.data.condition}</div></div></div><button onclick="startIndianRound()" class="w-full py-4 bg-orange-400 text-white rounded-3xl font-bold text-xl shadow-xl hover:bg-orange-500 transition" ${!game.revealed ? 'disabled opacity-50' : ''}>üé¨ ÿ£ŸÉÿ¥ŸÜ Ÿäÿß ŸÅŸÜÿßŸÜ!</button></div>`;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold text-slate-300">ÿßŸÑÿ®ÿ∑ŸÑ: <span class="text-white">${game.player.name}</span></p></div><div class="bg-slate-700 p-4 rounded-3xl border border-slate-600 shadow-xl mb-4 text-center"><p class="text-xs text-slate-400 font-bold mb-2 uppercase">ÿßŸÑŸÖÿ¥ŸáÿØ</p><h1 class="text-2xl font-black leading-relaxed text-center text-white mb-4">${game.data.scene}</h1><div class="border-t border-slate-600 pt-3"><p class="text-xs text-slate-400 font-bold mb-2 uppercase">ÿ¥ÿ±ÿ∑ ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨</p><div class="bg-slate-600 text-white px-4 py-2 rounded-lg font-bold text-base">${game.data.condition}</div></div></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-8xl font-black text-white" id="game-timer">${getTimer(game.timeLeft)}</div></div><div class="space-y-3"><button onclick="indianSuccess()" class="w-full py-4 bg-teal-400 text-white rounded-3xl font-bold text-xl shadow-xl hover:bg-teal-500 transition">üèÜ ÿ¨ÿßÿ®Ÿáÿß! (ÿ£Ÿàÿ≥ŸÉÿßÿ±)</button><button onclick="indianFail()" class="w-full py-3 bg-rose-400 text-white rounded-3xl font-bold shadow-xl hover:bg-rose-500 transition">üòÖ ÿ£ŸàŸÅÿ± ÿ£ŸàŸä (ŸÅÿ¥ŸÑ)</button></div></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-4">üé¨ ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ™ÿµŸàŸäÿ±!</h2><button onclick="startIndianGame()" class="w-full py-4 bg-orange-400 rounded-3xl font-bold text-xl mb-3 shadow-xl hover:bg-orange-500 transition">ŸÖÿ¥ŸáÿØ ÿ¨ÿØŸäÿØ</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 rounded-3xl font-bold shadow-xl hover:bg-slate-600 transition">ÿÆÿ±Ÿàÿ¨</button></div>`;
        }

        // --- BOMB ---
        function startBombGame() {
            // PATCH 5: Validate minimum players
            if (!validateMinPlayers(2)) return;
            
            // PATCH 1 & 6: Clear all previous intervals before starting
            clearAllIntervals();
            
            const category = BOMB_DATA[Math.floor(Math.random() * BOMB_DATA.length)];
            const count = Math.floor(Math.random() * 3) + 3; // ÿπÿØÿØ ÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÖŸÜ 3 ŸÑŸÄ 5
            const time = Math.floor(Math.random() * (45 - 20 + 1) + 20); // Random time 20-45 seconds
            const player = getFairPlayer();
            const playerIndex = state.players.findIndex(p => p.id === player.id);
            
            state.currentGame = { 
                type: 'bomb', 
                phase: 'playing', 
                category, 
                count, 
                player, 
                playerIndex, // Track current player position
                timeLeft: time, 
                exploded: false,
                currentTickSpeed: 1000 // Track current tick interval speed
            };
            
            playSound('click');
            saveState();
            render();
            
            // PATCH 6: Start dynamic timer with proper interval tracking
            function bombTick() {
                if (!state.currentGame || state.currentGame.type !== 'bomb') {
                    clearAllIntervals();
                    return;
                }
                
                state.currentGame.timeLeft--;
                playSound('bomb_tick');
                
                // Check for explosion
                if (state.currentGame.timeLeft <= 0) {
                    clearAllIntervals();
                    state.currentGame.exploded = true;
                    state.currentGame.phase = 'result';
                    // Deduct point from current player
                    updateScore(state.currentGame.player.id, false, -1);
                    playSound('explode');
                    saveState();
                    render();
                    return;
                }
                
                // Dynamic Speed Logic: Change interval speed based on time remaining
                let newSpeed = 1000; // Default: Normal (> 10s)
                if (state.currentGame.timeLeft <= 5) {
                    newSpeed = 200; // Panic mode (‚â§ 5s)
                } else if (state.currentGame.timeLeft <= 10) {
                    newSpeed = 500; // Fast mode (‚â§ 10s)
                }
                
                // PATCH 6: If speed changed, restart interval with proper tracking
                if (newSpeed !== state.currentGame.currentTickSpeed) {
                    state.currentGame.currentTickSpeed = newSpeed;
                    
                    // Clear ALL intervals (prevents multiple timers)
                    clearAllIntervals();
                    
                    // Start new interval and track it
                    const newIntervalId = setInterval(bombTick, newSpeed);
                    activeIntervals.push(newIntervalId);
                    gameInterval = newIntervalId;
                }
            }
            
            // Start initial interval and track it
            const initialIntervalId = setInterval(bombTick, 1000);
            activeIntervals.push(initialIntervalId);
            gameInterval = initialIntervalId;
        }
        // PATCH 3: Wrap passBomb with debouncing
        const passBomb = withCooldown('passBomb', function() { 
            if(state.currentGame && state.currentGame.phase === 'playing') {
                // DO NOT stop/restart timer - it runs continuously
                
                // Sequential player selection (circular)
                const nextPlayerIndex = (state.currentGame.playerIndex + 1) % state.players.length;
                const nextPlayer = state.players[nextPlayerIndex];
                
                // Generate new question
                const newCategory = BOMB_DATA[Math.floor(Math.random() * BOMB_DATA.length)];
                const newCount = Math.floor(Math.random() * 3) + 3; // ÿπÿØÿØ ÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÖŸÜ 3 ŸÑŸÄ 5
                
                // Update state
                state.currentGame.category = newCategory;
                state.currentGame.count = newCount;
                state.currentGame.player = nextPlayer;
                state.currentGame.playerIndex = nextPlayerIndex;
                
                // PATCH 2: Direct DOM update with escaped HTML
                const playerNameEl = document.getElementById('bomb-player-name');
                const questionEl = document.getElementById('bomb-question-text');
                
                if (playerNameEl) {
                    playerNameEl.innerText = escapeHtml(nextPlayer.name);
                }
                
                if (questionEl) {
                    questionEl.innerText = `${newCount} ${newCategory}`;
                }
                
                playSound('click');
                saveState();
            }
        }, 500); // 500ms cooldown for bomb passing
        function renderBombSetup() {
            if (!state.currentGame || state.currentGame.type !== 'bomb') return renderGameStartScreen('ÿßŸÑŸÇŸÜÿ®ŸÑÿ©', 'ÿ≥ÿ§ÿßŸÑ ŸáŸäÿ∏Ÿáÿ±ÿå ÿ¨ÿßŸàÿ® Ÿàÿ®ÿßÿµŸä ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ÿ®ÿ≥ÿ±ÿπÿ© ŸÑŸÑŸä ÿ¨ŸÜÿ®ŸÉ. ÿßŸÑŸÇŸÜÿ®ŸÑÿ© Ÿáÿ™ŸÅÿ±ŸÇÿπ ŸÅŸä ŸàŸÇÿ™ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿå ÿßŸÑŸÑŸä ŸÅŸä ÿ•ŸäÿØŸá ÿ®ŸäÿÆÿ≥ÿ±!', 'üí£', 'ÿ¥ÿ∫ŸÑ ÿßŸÑŸÅÿ™ŸäŸÑ', 'startBombGame()', 'bg-rose-400');
            const game = state.currentGame;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-slate-800 text-white animate-in"><div class="text-center mt-4 mb-4"><p class="text-slate-300 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 id="bomb-player-name" class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><div class="text-center mt-4"><p class="text-slate-300 font-bold mb-4">ÿßŸÑŸÅÿ¶ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©:</p><h1 id="bomb-question-text" class="text-4xl font-black mb-8">${game.count} ${game.category}</h1></div><div class="flex-1 flex items-center justify-center"><div class="text-9xl bomb-pulse">üí£</div></div><p class="text-center mb-8 font-bold text-lg">ÿ¨ÿßŸàÿ® Ÿàÿ®ÿßÿµŸä ÿ®ÿ≥ÿ±ÿπÿ©!</p><button onclick="passBomb()" class="w-full py-6 bg-rose-400 text-white rounded-3xl font-black text-2xl shadow-xl active:scale-95 hover:bg-rose-500 transition">ÿ®ÿßÿµŸä ÿßŸÑŸÇŸÜÿ®ŸÑÿ©! üí®</button></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-9xl mb-6">üí•</div><h2 class="text-4xl font-black text-rose-400 mb-4">ÿ®ŸàŸàŸàŸàŸÖ!</h2><p class="text-xl mb-2">ÿßŸÑŸÑÿßÿπÿ®: <span class="font-bold text-orange-400">${escapeHtml(game.player.name)}</span></p><p class="text-lg mb-8 text-slate-300">ÿ™ŸÖ ÿÆÿµŸÖ ŸÜŸÇÿ∑ÿ© (-1)</p><button onclick="startBombGame()" class="w-full py-4 bg-rose-400 rounded-3xl font-bold text-xl mb-3 shadow-xl hover:bg-rose-500 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 rounded-3xl font-bold shadow-xl hover:bg-slate-600 transition">ÿÆÿ±Ÿàÿ¨</button></div>`;
        }

        // --- TABOO ---
        function startTabooGame() {
            // PATCH 5: Validate minimum players
            if (!validateMinPlayers(2)) return;
            
            // PATCH 1: Clear intervals
            clearAllIntervals();
            
            const card = getUniqueItem('taboo', TABOO_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'taboo', phase: 'prepare', card, player, revealed: false, timeLeft: 60, score: 0 };
            playSound('click');
            render();
        }
        function startTabooRound() {
            state.currentGame.phase = 'playing';
            state.currentGame.revealed = true;
            playSound('click');
            saveState();
            render();
            
            // PATCH 1: Clear and track intervals
            clearAllIntervals();
            const intervalId = setInterval(() => {
                if (!state.currentGame || state.currentGame.type !== 'taboo') {
                    clearAllIntervals();
                    return;
                }
                
                state.currentGame.timeLeft--;
                const timerEl = document.getElementById('game-timer');
                if (timerEl) timerEl.innerText = getTimer(state.currentGame.timeLeft);
                if (state.currentGame.timeLeft <= 0) { 
                    clearAllIntervals(); 
                    state.currentGame.phase = 'result'; 
                    playSound('fail'); 
                    saveState(); 
                    render(); 
                }
                else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
            activeIntervals.push(intervalId);
            gameInterval = intervalId;
        }
        
        // PATCH 3: Apply debouncing to Taboo actions
        const tabooCorrect = withCooldown('tabooCorrect', function() { 
            // ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸÇÿ∑ÿ© ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ≠ÿßŸÑŸä ŸÇÿ®ŸÑ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿØŸàÿ±
            updateScore(state.currentGame.player.id, false, 1);
            state.currentGame.score++; 
            playSound('success'); 
            // ÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ™ÿßŸÑŸä
            const nextPlayer = getFairPlayer();
            state.currentGame.player = nextPlayer;
            state.currentGame.card = getUniqueItem('taboo', TABOO_DATA);
            saveState();
            render(); 
        });
        
        const tabooSkip = withCooldown('tabooSkip', function() { 
            playSound('click'); 
            // ÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ™ÿßŸÑŸä
            const nextPlayer = getFairPlayer();
            state.currentGame.player = nextPlayer;
            state.currentGame.card = getUniqueItem('taboo', TABOO_DATA);
            saveState();
            render(); 
        });
        
        const tabooFail = withCooldown('tabooFail', function() { 
            state.currentGame.score--; 
            playSound('fail'); 
            // ÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ™ÿßŸÑŸä
            const nextPlayer = getFairPlayer();
            state.currentGame.player = nextPlayer;
            state.currentGame.card = getUniqueItem('taboo', TABOO_DATA);
            saveState();
            render(); 
        });
        function renderTabooSetup() {
            if (!state.currentGame || state.currentGame.type !== 'taboo') return renderGameStartScreen('ÿ£ŸàÿπŸâ ÿ™ŸÇŸàŸÑŸáÿß', 'ÿßÿ¥ÿ±ÿ≠ ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÑŸä ŸÅŸàŸÇ ŸÖŸÜ ÿ∫Ÿäÿ± ŸÖÿß ÿ™ŸÇŸàŸÑ ÿ£Ÿä ŸÉŸÑŸÖÿ© ŸÖŸÜ ÿßŸÑŸÖŸÖŸÜŸàÿπÿßÿ™ ÿßŸÑŸÑŸä ÿ™ÿ≠ÿ™Ÿáÿß!', 'üö´', 'ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ÿØŸä', 'startTabooGame()', 'bg-indigo-400');
            const game = state.currentGame;
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-rose-900 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p><h1 class="text-4xl font-black mb-8">${game.player.name}</h1><div class="bg-white/10 p-6 rounded-2xl border-2 border-white/20 w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-rose-950 z-10 flex items-center justify-center cursor-pointer hover:bg-rose-900 transition"><span class="text-xl font-bold animate-pulse">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑŸÉŸÑŸÖÿ©</span></div>` : ''}<p class="text-sm mb-2 opacity-75">ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©:</p><h2 class="text-3xl font-bold text-yellow-300">${game.card.word}</h2></div><button onclick="startTabooRound()" class="w-full py-4 bg-white text-rose-900 rounded-xl font-bold text-xl" ${!game.revealed ? 'disabled opacity-50' : ''}>ÿ¨ÿßŸáÿ≤! ÿßÿ®ÿØÿ£</button></div>`;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="relative mb-4"><p class="text-center text-lg font-bold text-slate-100">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ: <span class="text-rose-300">${game.player.name}</span></p><div class="absolute right-0 top-0 text-xl font-bold text-slate-100 bg-slate-700 px-3 py-1 rounded-2xl border border-slate-600/50">ÿßŸÑŸÜŸÇÿßÿ∑: ${game.score}</div></div><div class="relative mb-6"><div class="text-center"><div class="inline-block text-3xl font-black text-rose-300 px-4 py-1 bg-slate-700 rounded-full border border-slate-600/50" id="game-timer">${getTimer(game.timeLeft)}</div></div></div><div class="flex-1 flex flex-col justify-center items-center"><div class="w-full bg-slate-700 border border-slate-600/50 rounded-3xl p-6 text-center mb-4 shadow-xl"><h1 class="text-3xl font-black leading-relaxed text-center text-white mb-6">${game.card.word}</h1><div class="bg-slate-800 rounded-2xl p-4 border border-slate-600/30"><p class="text-sm text-rose-300 font-bold mb-3">üö´ ŸÖŸÖŸÜŸàÿπ ÿ™ŸÇŸàŸÑ:</p>${game.card.taboo.map(t => `<div class="text-xl font-black text-slate-100 border-b border-slate-600/50 last:border-0 py-2">${t}</div>`).join('')}</div></div></div><div class="grid grid-cols-3 gap-2 h-20"><button onclick="tabooFail()" class="bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">ÿ∫ŸÑÿ∑ÿ©</button><button onclick="tabooSkip()" class="bg-slate-600 hover:bg-slate-700 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">ÿ™ÿÆÿ∑Ÿä</button><button onclick="tabooCorrect()" class="bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">ÿµÿ≠</button></div></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-4">ÿÆŸÑÿµ ÿßŸÑŸàŸÇÿ™!</h2><div class="text-6xl font-black text-yellow-300 mb-4">${game.score}</div><p class="text-xl mb-8 text-slate-400">ŸÜŸÇÿ∑ÿ©</p><button onclick="startTabooGame()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`;
        }

        // --- STORY ---
        function startStoryGame() { 
            const story = getUniqueItem('story', STORY_DATA);
            const currentPlayer = getFairPlayer();
            state.currentGame = { type: 'story', phase: 'ready', story, revealed: false, timeLeft: 60, currentPlayer }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startStoryRound() { 
            state.currentGame.phase = 'playing'; 
            state.currentGame.revealed = true; 
            playSound('click'); 
            render(); 
            if (gameInterval) clearInterval(gameInterval); 
            gameInterval = setInterval(() => { 
                state.currentGame.timeLeft--; 
                const t = document.getElementById('game-timer'); 
                if(t) t.innerText = state.currentGame.timeLeft; 
                if (state.currentGame.timeLeft <= 0) { 
                    clearInterval(gameInterval); 
                    state.currentGame.phase = 'result'; 
                    playSound('fail'); 
                    render(); 
                } else if (state.currentGame.timeLeft <= 10) playSound('tick'); 
            }, 1000); 
        }
        function storyNextPlayer() {
            // ÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ™ÿßŸÑŸä ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ turnQueue
            const nextPlayer = getFairPlayer();
            state.currentGame.currentPlayer = nextPlayer;
            saveState();
            render();
        }
        function storySuccess() { 
            // ÿßŸÑŸÜŸÇÿ∑ÿ© ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ≠ÿßŸÑŸä (ÿµÿßÿ≠ÿ® ÿßŸÑÿØŸàÿ±)
            if(state.currentGame.currentPlayer) updateScore(state.currentGame.currentPlayer.id, false, 1); 
            startStoryGame(); 
        }
        function storyFail() { 
            if (state.daresEnabled) showDare(); 
            startStoryGame(); 
        }
        function renderStorySetup() { 
            if (!state.currentGame || state.currentGame.type !== 'story') return renderGameStartScreen('ÿ≠ŸÉÿßŸäÿ© ŸÅŸä ŸÉŸÑŸÖÿ™ŸäŸÜ', 'ÿ®ÿØÿßŸäÿ© ŸÇÿµÿ© ŸàŸÜŸáÿßŸäÿ© ÿ•ÿ¨ÿ®ÿßÿ±Ÿäÿ©. ŸÉŸÑ Ÿàÿßÿ≠ÿØ ŸäŸÇŸàŸÑ ŸÉŸÑŸÖÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ŸàÿµŸÑŸàÿß ŸÑŸÑŸÜŸáÿßŸäÿ© ÿØŸä ŸÅŸä ÿÆŸÑÿßŸÑ 60 ÿ´ÿßŸÜŸäÿ©!', 'üìñ', 'ÿßŸÅÿ™ÿ≠ ÿßŸÑŸÉÿ™ÿßÿ®', 'startStoryGame()', 'bg-amber-600'); 
            const game = state.currentGame; 
            if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">üìú</div><h2 class="text-3xl font-bold mb-8">ÿ¨ÿßŸáÿ≤ŸäŸÜ ŸÑŸÑÿ™ÿ£ŸÑŸäŸÅÿü</h2><div onclick="startStoryRound()" class="w-full py-8 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-black text-2xl shadow-xl cursor-pointer active:scale-95 transition">ÿØŸàÿ≥ ŸàÿßŸÉÿ¥ŸÅ ÿßŸÑŸÇÿµÿ©</div></div>`; 
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-slate-800 animate-in"><div class="text-center mb-4"><p class="text-lg font-bold text-slate-100">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ: <span class="text-orange-300">${game.currentPlayer ? escapeHtml(game.currentPlayer.name) : 'ŸÑÿßÿπÿ®'}</span></p></div><div class="flex-1 flex flex-col justify-center items-center space-y-6"><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600/50 w-full shadow-xl"><p class="text-sm text-orange-300 font-bold mb-2">ÿßŸÑÿ®ÿØÿßŸäÿ©:</p><h1 class="text-3xl font-black leading-relaxed text-center text-white">"${game.story.start}"</h1></div><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600/50 w-full shadow-xl"><p class="text-sm text-rose-300 font-bold mb-2">ÿßŸÑŸÜŸáÿßŸäÿ© ÿßŸÑÿ•ÿ¨ÿ®ÿßÿ±Ÿäÿ©:</p><h1 class="text-3xl font-black leading-relaxed text-center text-white">"${game.story.end}"</h1></div><div class="text-center mt-4"><div class="text-6xl font-black text-orange-300" id="game-timer">${game.timeLeft}</div></div></div><div class="space-y-3 mt-auto"><button onclick="storySuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ŸàÿµŸÑÿ™Ÿàÿß ŸÑŸÑŸÜŸáÿßŸäÿ©!</button><button onclick="storyNextPlayer()" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition">ÿßŸÑÿ™ÿßŸÑŸä (ÿØŸàÿ± ÿ¨ÿØŸäÿØ)</button><button onclick="storyFail()" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition">‚úó ÿßŸÑŸàŸÇÿ™ ÿÆŸÑÿµ (ÿπŸÇÿßÿ®)</button></div></div>`; 
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-4">ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÇÿµÿ©!</h2><button onclick="startStoryGame()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ŸÇÿµÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; 
        }

        // --- MORPH ---
        function startMorphGame() { 
            const word = getUniqueItem('morph', MORPH_DATA);
            const startingPlayer = getFairPlayer();
            state.currentGame = { type: 'morph', phase: 'ready', word, timeLeft: 45, startingPlayer, losers: [] }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startMorphRound() { 
            state.currentGame.phase = 'playing'; 
            playSound('click'); 
            render(); 
            if (gameInterval) clearInterval(gameInterval); 
            gameInterval = setInterval(() => { 
                state.currentGame.timeLeft--; 
                const t = document.getElementById('game-timer'); 
                if(t) t.innerText = state.currentGame.timeLeft; 
                if (state.currentGame.timeLeft <= 0) { 
                    clearInterval(gameInterval); 
                    state.currentGame.phase = 'result'; 
                    playSound('fail'); 
                    render(); 
                } else if (state.currentGame.timeLeft <= 10) playSound('tick'); 
            }, 1000); 
        }
        function toggleMorphLoser(playerId) {
            if (!state.currentGame.losers) state.currentGame.losers = [];
            const index = state.currentGame.losers.indexOf(playerId);
            if (index > -1) {
                state.currentGame.losers.splice(index, 1);
            } else {
                state.currentGame.losers.push(playerId);
            }
            render();
        }
        function morphSuccess() {
            // Round ended successfully - all players succeeded
            // Optional: Award point to starting player
            if (state.currentGame.startingPlayer) {
                updateScore(state.currentGame.startingPlayer.id, false, 1);
            }
            playSound('success');
            startMorphGame();
        }
        function morphFail() {
            // Someone failed - go to result phase to select losers
            if (gameInterval) clearInterval(gameInterval);
            state.currentGame.phase = 'result';
            playSound('fail');
            saveState();
            render();
        }
        function morphConfirmResult() {
            // ŸÉŸÑ ÿÆÿßÿ≥ÿ± Ÿäÿ™ÿÆÿµŸÖ ŸÖŸÜŸá (-1)
            state.currentGame.losers.forEach(loserId => {
                updateScore(loserId, false, -1);
            });
            // ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑŸàÿ≠ŸäÿØ ÿßŸÑŸÑŸä ŸÖÿ™ŸÖÿ¥ ÿßÿÆÿ™Ÿäÿßÿ±Ÿá ŸÉÿÆÿßÿ≥ÿ± ŸäÿßÿÆÿØ (+2)
            const allPlayerIds = state.players.map(p => p.id);
            const winners = allPlayerIds.filter(id => !state.currentGame.losers.includes(id));
            if (winners.length === 1) {
                updateScore(winners[0], false, 2);
            }
            startMorphGame();
        }
        function renderMorphSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'morph') return renderGameStartScreen('ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ™ÿ≠ŸàŸÑÿ©', 'ŸÉŸÑŸÖÿ© Ÿáÿ™ÿ∏Ÿáÿ±. ŸÉŸÑ ŸÑÿßÿπÿ® Ÿäÿ∫Ÿäÿ± ÿ≠ÿ±ŸÅ Ÿàÿßÿ≠ÿØ ÿ®ÿ≥ ÿπÿ¥ÿßŸÜ ŸäÿπŸÖŸÑ ŸÉŸÑŸÖÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸäŸáÿß ŸÖÿπŸÜŸâ. ŸÑŸà ÿ≠ÿØ ŸàŸÇŸÅ ÿ£Ÿà ÿßŸÑŸàŸÇÿ™ ÿÆŸÑÿµ ÿ®ŸäÿÆÿ≥ÿ±!', 'üî§', 'Ÿáÿßÿ™ ÿßŸÑŸÉŸÑŸÖÿ©', 'startMorphGame()', 'bg-cyan-700'); 
            const game = state.currentGame; 
            if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">üé≤</div><h2 class="text-3xl font-bold mb-8">ÿ¨ÿßŸáÿ≤ŸäŸÜ ŸÑŸÑÿ™ÿ∫ŸäŸäÿ±ÿü</h2><div class="mb-4"><p class="text-lg text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h3 class="text-2xl font-bold text-yellow-300">${game.startingPlayer ? game.startingPlayer.name : 'ŸÑÿßÿπÿ®'}</h3></div><div onclick="startMorphRound()" class="w-full py-8 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-black text-2xl shadow-xl cursor-pointer active:scale-95 transition">ÿØŸàÿ≥ ŸàÿßŸÉÿ¥ŸÅ ÿßŸÑŸÉŸÑŸÖÿ©</div></div>`; 
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-slate-800 animate-in"><div class="text-center mb-4"><p class="text-lg font-bold text-slate-100">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ: <span class="text-teal-300">${game.startingPlayer ? game.startingPlayer.name : 'ŸÑÿßÿπÿ®'}</span></p></div><div class="flex-1 flex flex-col justify-center items-center text-center"><p class="text-lg text-slate-400 mb-4">ŸÉŸÑŸÖÿ© ÿßŸÑÿ®ÿØÿßŸäÿ©:</p><div class="bg-slate-700 p-8 rounded-3xl w-full mb-8 shadow-xl border border-slate-600/50"><h1 class="text-3xl font-black leading-relaxed text-center text-white">${game.word}</h1></div><div class="text-8xl font-black text-teal-300" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3 mt-auto"><button onclick="morphSuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ŸÜÿ¨ÿ≠ (+1 ŸÜŸÇÿ∑ÿ©)</button><button onclick="morphFail()" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition">‚úó ŸÅÿ¥ŸÑ</button></div></div>`; 
            if (game.phase === 'result') {
                if (!game.losers) game.losers = [];
                return `<div class="h-screen flex flex-col p-6 bg-slate-800 text-white"><h2 class="text-3xl font-bold mb-6 text-center">ÿßŸÑÿ¨ŸàŸÑÿ© ÿÆŸÑÿµÿ™!</h2><p class="text-lg mb-4 text-center text-slate-400">ŸÖŸäŸÜ ÿßŸÑŸÑŸä ÿÆÿ≥ÿ±Ÿàÿßÿü (ÿßÿÆÿ™ÿ± ŸÉŸÑ ÿßŸÑÿÆÿßÿ≥ÿ±ŸäŸÜ)</p><div class="flex-1 overflow-y-auto mb-4">${state.players.map(p => `<label class="flex items-center p-4 bg-slate-700 rounded-2xl mb-2 cursor-pointer hover:bg-slate-600 transition border border-slate-600/50 shadow-lg"><input type="checkbox" ${game.losers.includes(p.id) ? 'checked' : ''} onchange="toggleMorphLoser(${p.id})" class="w-6 h-6 mr-3"><span class="text-xl font-bold">${escapeHtml(p.name)}</span></label>`).join('')}</div><button onclick="morphConfirmResult()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; 
            }
        }

        // --- ARTIST ---
        function startArtistGame() { if (state.players.length < 2) { alert("ŸÖÿ≠ÿ™ÿßÿ¨ŸäŸÜ ŸÑÿßÿπÿ®ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!"); return; } const word = getUniqueItem('artist', ARTIST_DATA); const artist = getFairPlayer(); let guesser = state.players[Math.floor(Math.random() * state.players.length)]; while (guesser.id === artist.id) guesser = state.players[Math.floor(Math.random() * state.players.length)]; state.currentGame = { type: 'artist', phase: 'setup', word, artist, guesser, timeLeft: 60, revealed: false }; playSound('click'); render(); }
        function revealArtistWord() { state.currentGame.revealed = true; playSound('click'); saveState(); render(); }
        function startArtistDrawing() { state.currentGame.phase = 'drawing'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function artistSuccess() { updateScore(state.currentGame.guesser.id, false, 1); updateScore(state.currentGame.artist.id, false, 1); startArtistGame(); }
        function renderArtistSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'artist') return renderGameStartScreen('ÿßŸÑÿ±ÿ≥ÿßŸÖ ÿßŸÑÿ£ÿπŸÖŸâ', 'ÿßŸÑÿ±ÿ≥ÿßŸÖ Ÿäÿ¥ŸàŸÅ ÿßŸÑŸÉŸÑŸÖÿ©. ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ™ÿßŸÜŸä Ÿäÿ≠ÿ∑ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ÿπŸÑŸâ ÿ±ÿßÿ≥Ÿá ÿ£Ÿà ŸÖŸäÿ®ÿµÿ¥. ÿßŸÑÿ±ÿ≥ÿßŸÖ Ÿäÿ±ÿ≥ŸÖÿå ŸàÿßŸÑÿ™ÿßŸÜŸä ŸäÿÆŸÖŸÜ ŸÖŸÜ ŸàÿµŸÅ ÿßŸÑŸÜÿßÿ≥ ŸÑŸÑÿ±ÿ≥ŸÖÿ©!', 'üé®', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÅŸÜ', 'startArtistGame()', 'bg-fuchsia-600'); 
            const game = state.currentGame; 
            if (game.phase === 'setup') {
                if (!game.revealed) {
                    return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><h2 class="text-2xl font-bold mb-4">Ÿäÿß <span class="text-yellow-300">${game.artist.name}</span></h2><p class="mb-8 text-slate-400">ÿÆÿØ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ŸàŸÖÿ≥ŸÉŸá ŸÉŸàŸäÿ≥!</p><div class="bg-slate-700 p-8 rounded-3xl mb-8 border border-slate-600/50 shadow-xl relative overflow-hidden"><div class="absolute inset-0 bg-slate-800 blur-md flex items-center justify-center"><span class="text-4xl font-black opacity-50">üé®</span></div><p class="text-sm text-slate-400 mb-2 relative z-10" style="filter: blur(8px); user-select: none;">ŸÖÿ∑ŸÑŸàÿ® ÿ™ÿ±ÿ≥ŸÖ:</p><h1 class="text-4xl font-black relative z-10" style="filter: blur(8px); user-select: none;">${game.word}</h1></div><button onclick="revealArtistWord()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÉÿ¥ŸÅ</button></div>`;
                }
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><h2 class="text-2xl font-bold mb-4">Ÿäÿß <span class="text-yellow-300">${game.artist.name}</span></h2><p class="mb-8 text-slate-400">ÿÆÿØ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ŸàŸÖÿ≥ŸÉŸá ŸÉŸàŸäÿ≥!</p><div class="bg-slate-700 p-8 rounded-3xl mb-8 border border-slate-600/50 shadow-xl"><p class="text-sm text-slate-400 mb-2">ŸÖÿ∑ŸÑŸàÿ® ÿ™ÿ±ÿ≥ŸÖ:</p><h1 class="text-4xl font-black">${game.word}</h1></div><p class="mb-4 text-sm text-slate-400">ÿØŸÑŸàŸÇÿ™Ÿä ÿÆÿ®Ÿä ÿßŸÑŸÉŸÑŸÖÿ© ŸàÿßÿØŸä ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ŸÑŸÄ ${game.guesser.name}</p><button onclick="startArtistDrawing()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition">ŸäŸÑÿß ŸÜÿ±ÿ≥ŸÖ!</button></div>`;
            }
            if (game.phase === 'drawing') return `<div class="h-screen flex flex-col p-6 bg-slate-800 animate-in"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold text-slate-100">ÿßŸÑÿ±ÿ≥ÿßŸÖ: <span class="text-rose-300">${game.artist.name}</span></p><p class="text-lg font-bold text-slate-100">ÿ®ŸäÿÆŸÖŸÜ: <span class="text-rose-300">${game.guesser.name}</span></p></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black text-rose-300 mb-8" id="game-timer">${game.timeLeft}</div><p class="text-center text-slate-400 px-4">ÿßŸÑÿ±ÿ≥ÿßŸÖ ÿ®Ÿäÿ±ÿ≥ŸÖ ÿØŸÑŸàŸÇÿ™.. ŸàÿßŸÑŸÜÿßÿ≥ ÿ®ÿ™ŸàÿµŸÅ ÿßŸÑÿ±ÿ≥ŸÖÿ© (ŸÖŸÜ ÿ∫Ÿäÿ± ŸÖÿß ŸäŸÇŸàŸÑŸàÿß ÿßŸÑŸÉŸÑŸÖÿ©!)</p></div><div class="space-y-3 mt-auto"><button onclick="artistSuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ÿπÿ±ŸÅŸáÿß!</button><button onclick="state.currentGame.phase='result'; render()" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition">‚úó ŸÖÿπÿ±ŸÅÿ¥</button></div></div>`; 
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-4">ÿÆŸÑÿµ ÿßŸÑŸàŸÇÿ™!</h2><p class="mb-4 text-xl text-slate-400">ÿßŸÑŸÉŸÑŸÖÿ© ŸÉÿßŸÜÿ™: <span class="text-yellow-300 font-bold">${game.word}</span></p><button onclick="startArtistGame()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ÿ±ÿ≥ŸÖÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; 
        }

        // --- WHISPER ---
        function startWhisperGame() { if (state.players.length < 2) { alert("ŸÖÿ≠ÿ™ÿßÿ¨ŸäŸÜ ŸÑÿßÿπÿ®ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!"); return; } const phrase = getUniqueItem('whisper', WHISPER_DATA); const listener = getFairPlayer(); let speakerIndex = Math.floor(Math.random() * state.players.length); while (state.players[speakerIndex].id === listener.id) speakerIndex = Math.floor(Math.random() * state.players.length); state.currentGame = { type: 'whisper', phase: 'setup', phrase: phrase, listener, speaker: state.players[speakerIndex], timeLeft: 60, revealed: false }; playSound('click'); render(); }
        function startWhisperRound() { state.currentGame.phase = 'playing'; state.currentGame.revealed = true; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function whisperSuccess() { updateScore(state.currentGame.listener.id, false, 1); startWhisperGame(); }
        function whisperFail() { if (state.daresEnabled) showDare(); startWhisperGame(); }
        function renderWhisperSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'whisper') return renderGameStartScreen('ÿ•ŸÇÿ±ÿ£ ÿ¥ŸÅÿßŸäŸÅŸä', 'Ÿàÿßÿ≠ÿØ ŸäŸÑÿ®ÿ≥ ÿ≥ŸÖÿßÿπÿ© ŸÅŸäŸáÿß ÿ£ÿ∫ŸÜŸäÿ© ÿ®ÿµŸàÿ™ ÿπÿßŸÑŸäÿå ŸàÿßŸÑÿ™ÿßŸÜŸä ŸäŸÇÿ±ÿ£ ÿ¨ŸÖŸÑÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©. ÿ≠ÿßŸàŸÑ ÿ™ÿÆŸÖŸÜ ÿßŸÑÿ¨ŸÖŸÑÿ© ŸÖŸÜ ÿ≠ÿ±ŸÉÿ© ÿßŸÑÿ¥ŸÅÿßŸäŸÅ!', 'üéß', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startWhisperGame()', 'bg-pink-500'); 
            const game = state.currentGame; 
            if (game.phase === 'setup') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="mb-8"><p class="text-lg text-slate-400">ŸäŸÑÿ®ÿ≥ ÿßŸÑÿ≥ŸÖÿßÿπÿ©:</p><h1 class="text-4xl font-black text-yellow-300 mb-4">${game.listener.name}</h1><div class="w-full h-1 bg-slate-600/50 rounded-full mb-4"></div><p class="text-lg text-slate-400">ŸäŸÇÿ±ÿ£ ÿßŸÑÿ¨ŸÖŸÑÿ©:</p><h1 class="text-3xl font-bold">${game.speaker.name}</h1></div><div class="bg-slate-700 p-6 rounded-2xl border border-slate-600/50 mb-8 shadow-xl"><p class="text-sm">Ÿäÿß ${game.listener.name}ÿå ÿπŸÑŸä ÿßŸÑÿµŸàÿ™ ÿπÿßŸÑÿßÿÆÿ±! üéµ</p></div><button onclick="startWhisperRound()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition">ÿ¨ÿßŸáÿ≤ŸäŸÜ! ÿßŸÉÿ¥ŸÅ ÿßŸÑÿ¨ŸÖŸÑÿ©</button></div>`; 
            } 
            if (game.phase === 'playing') { 
                return `<div class="h-screen flex flex-col p-6 bg-slate-800 animate-in"><div class="text-center mt-4 mb-8"><p class="text-lg font-bold text-slate-100">ÿßŸÑŸÖÿ™ÿ≠ÿØÿ´: <span class="text-rose-300">${game.speaker.name}</span></p></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black text-rose-300 mb-8" id="game-timer">${game.timeLeft}</div><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600/50 w-full text-center shadow-xl"><p class="text-sm text-rose-300 mb-2">ÿßŸÑÿ¨ŸÖŸÑÿ© ŸáŸä:</p><h1 class="text-3xl font-black leading-relaxed text-center text-white">${game.phrase}</h1></div></div><div class="space-y-3 mt-auto"><button onclick="whisperSuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ÿπÿ±ŸÅŸáÿß! (+ŸÜŸÇÿ∑ÿ©)</button><button onclick="whisperFail()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ŸÖÿπÿ±ŸÅÿ¥ (ÿ™ÿÆÿ∑Ÿä)</button></div></div>`; 
            } 
            if (game.phase === 'result') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-4">ÿÆŸÑÿµ ÿßŸÑŸàŸÇÿ™!</h2><p class="text-xl mb-8 text-slate-400">ÿßŸÑÿ¨ŸÖŸÑÿ© ŸÉÿßŸÜÿ™: <br><span class="text-yellow-300 font-bold">${game.phrase}</span></p><button onclick="startWhisperGame()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; 
            } 
        }

        // --- NEVER ---
        function startNeverGame() { const statement = getUniqueItem('never', NEVER_DATA); state.currentGame = { type: 'never', phase: 'ready', statement: statement, revealed: false }; playSound('click'); render(); }
        function revealNeverCard() { state.currentGame.phase = 'playing'; state.currentGame.revealed = true; playSound('click'); render(); }
        function neverScoreSelect() { state.currentGame.phase = 'scoring'; saveState(); render(); }
        function renderNeverSetup() { if (!state.currentGame || state.currentGame.type !== 'never') return renderGameStartScreen('ÿ£ŸÜÿß ÿπŸÖÿ±Ÿä ŸÖÿß', 'ÿßÿ±ŸÅÿπŸàÿß 5 ÿ£ÿµÿßÿ®ÿπ. ÿ¨ŸÖŸÑÿ© Ÿáÿ™ÿ∏Ÿáÿ±ÿå ŸÑŸà ÿπŸÖŸÑÿ™ ÿßŸÑÿ≠ÿßÿ¨ÿ© ÿØŸä ŸÇÿ®ŸÑ ŸÉÿØŸáÿå ŸÜÿ≤ŸÑ ÿµÿ®ÿßÿπ. ÿ¢ÿÆÿ± Ÿàÿßÿ≠ÿØ ŸäŸÅÿ∂ŸÑ ÿ±ÿßŸÅÿπ ÿµÿ®ÿßÿπŸá ŸáŸà ÿßŸÑŸÉÿ≥ÿ®ÿßŸÜ!', '‚úã', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startNeverGame()', 'bg-rose-800'); const game = state.currentGame; if (game.phase === 'ready') { return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">‚úã</div><h2 class="text-3xl font-bold mb-8">ÿ¨ÿßŸáÿ≤ŸäŸÜÿü</h2><p class="text-lg text-slate-400 mb-8">ÿßÿ±ŸÅÿπŸàÿß ÿ•ŸäÿØŸäŸÉŸÖ (5 ÿ£ÿµÿßÿ®ÿπ) ÿØŸÑŸàŸÇÿ™Ÿä!</p><div onclick="revealNeverCard()" class="w-full py-8 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-black text-2xl shadow-xl cursor-pointer active:scale-95 transition">ÿØŸàÿ≥ ŸàÿßŸÉÿ¥ŸÅ ÿßŸÑŸÉÿßÿ±ÿ™</div></div>`; } if (game.phase === 'playing') { return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-xl font-bold text-slate-400 mb-4">ÿ£ŸÜÿß ÿπŸÖÿ±Ÿä ŸÖÿß...</p><div class="bg-slate-700 text-white p-8 rounded-3xl w-full mb-8 shadow-xl border border-slate-600/50"><h1 class="text-3xl font-black leading-relaxed">${game.statement}</h1></div><div class="w-full space-y-3"><button onclick="startNeverGame()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ÿßŸÑŸÉÿßÿ±ÿ™ ÿßŸÑŸÑŸä ÿ®ÿπÿØŸá</button><button onclick="neverScoreSelect()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white border border-slate-600/50 rounded-2xl font-bold shadow-lg active:scale-95 transition">ÿ™Ÿàÿ≤Ÿäÿπ ŸÜŸÇÿßÿ∑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</button><button onclick="goHome()" class="w-full py-3 bg-transparent text-slate-400 font-bold hover:text-white transition">ÿÆÿ±Ÿàÿ¨</button></div></div>`; } if (game.phase === 'scoring') { return `<div class="h-screen flex flex-col p-6 bg-slate-800 text-white text-center"><h2 class="text-2xl font-bold mb-6">ŸÖŸäŸÜ Ÿäÿ≥ÿ™ÿ≠ŸÇ ÿßŸÑŸÜŸÇÿ∑ÿ©ÿü</h2><div class="grid grid-cols-2 gap-3 w-full mb-8 flex-1 overflow-y-auto content-start">${state.players.map(p => `<button onclick="updateScore(${p.id}, false, 1); startNeverGame()" class="p-4 bg-slate-700 border border-slate-600/50 rounded-2xl font-bold hover:bg-slate-600 shadow-lg active:scale-95 transition">${p.name}</button>`).join('')}</div><button onclick="startNeverGame()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿ™ÿÆÿ∑Ÿä (ÿ®ÿØŸàŸÜ ŸÜŸÇÿßÿ∑)</button></div>`; } }

        // --- DEBATE ---
        function startDebateGame() { if (state.players.length < 2) { alert("ŸÖÿ≠ÿ™ÿßÿ¨ŸäŸÜ ŸÑÿßÿπÿ®ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!"); return; } const topic = getUniqueItem('debate', DEBATE_DATA); const p1 = getFairPlayer(); let p2 = state.players[Math.floor(Math.random() * state.players.length)]; while (p2.id === p1.id) p2 = state.players[Math.floor(Math.random() * state.players.length)]; state.currentGame = { type: 'debate', phase: 'assign', topic, p1, p2, timeLeft: 60, revealed: false }; playSound('click'); render(); }
        function startDebateRound() { state.currentGame.phase = 'playing'; state.currentGame.revealed = true; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'voting'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function endDebateEarly() { if (gameInterval) clearInterval(gameInterval); state.currentGame.phase = 'voting'; playSound('fail'); saveState(); render(); }
        function debateVote(winnerId) { updateScore(winnerId, false, 1); state.currentGame.phase = 'result'; saveState(); render(); }
        function renderDebateSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'debate') return renderGameStartScreen('ŸÖÿ≠ŸÉŸÖÿ©', 'ŸÖŸàÿ∂Ÿàÿπ ÿ¨ÿØŸÑŸä ÿ™ÿßŸÅŸá ŸáŸäÿ∑ŸÑÿπ. ÿßŸÑŸÑÿπÿ®ÿ© Ÿáÿ™ÿÆÿ™ÿßÿ± "ŸÖÿ≠ÿßŸÖŸä" Ÿà "ŸÜŸäÿßÿ®ÿ©". ŸÉŸÑ Ÿàÿßÿ≠ÿØ ŸÖÿπÿßŸá ÿØŸÇŸäŸÇÿ© ŸäŸÇŸÜÿπ ÿßŸÑŸÇÿπÿØÿ© ÿ®Ÿàÿ¨Ÿáÿ© ŸÜÿ∏ÿ±Ÿá!', '‚öñÔ∏è', 'ÿßÿ®ÿØÿ£ ÿßŸÑÿ¨ŸÑÿ≥ÿ©', 'startDebateGame()', 'bg-amber-700'); 
            const game = state.currentGame; 
            if (game.phase === 'assign') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><h2 class="text-3xl font-bold mb-8">ÿ£ÿ∑ÿ±ÿßŸÅ ÿßŸÑŸÇÿ∂Ÿäÿ©</h2><div class="w-full bg-slate-700 p-4 rounded-2xl mb-4 border-r-4 border-teal-400 shadow-xl"><p class="text-sm text-slate-400">ŸÖÿπ ÿßŸÑŸÖŸàÿ∂Ÿàÿπ (ÿØŸÅÿßÿπ)</p><h1 class="text-2xl font-black">${game.p1.name}</h1></div><div class="text-2xl font-bold mb-4">VS</div><div class="w-full bg-slate-700 p-4 rounded-2xl mb-8 border-r-4 border-rose-400 shadow-xl"><p class="text-sm text-slate-400">ÿ∂ÿØ ÿßŸÑŸÖŸàÿ∂Ÿàÿπ (ŸÜŸäÿßÿ®ÿ©)</p><h1 class="text-2xl font-black">${game.p2.name}</h1></div><button onclick="startDebateRound()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition">ÿßŸÉÿ¥ŸÅ ÿßŸÑŸÇÿ∂Ÿäÿ© Ÿàÿßÿ®ÿØÿ£</button></div>`; 
            } 
            if (game.phase === 'playing') { 
                return `<div class="h-screen flex flex-col p-6 bg-slate-800 animate-in"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold text-slate-400">ÿßŸÑŸÇÿ∂Ÿäÿ© ÿ±ŸÇŸÖ #99</p></div><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600/50 w-full text-center mb-6 shadow-xl"><h1 class="text-3xl font-black leading-relaxed text-center text-white">${game.topic}</h1></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black text-orange-300" id="game-timer">${game.timeLeft}</div></div><div class="flex justify-between gap-4 mt-auto mb-4"><div class="text-center w-1/2"><div class="font-bold text-teal-300 mb-1">ŸÖÿπ</div><div class="p-2 bg-slate-700 rounded-2xl font-bold text-sm border border-slate-600/50">${game.p1.name}</div></div><div class="text-center w-1/2"><div class="font-bold text-rose-300 mb-1">ÿ∂ÿØ</div><div class="p-2 bg-slate-700 rounded-2xl font-bold text-sm border border-slate-600/50">${game.p2.name}</div></div></div><button onclick="endDebateEarly()" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÅŸàÿ±ÿßŸã</button></div>`; 
            } 
            if (game.phase === 'voting') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">üë®‚Äç‚öñÔ∏è</div><h2 class="text-3xl font-bold mb-8">ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ≠ŸÉŸÖÿ©!</h2><p class="text-lg text-slate-400 mb-6">ŸÖŸäŸÜ ÿ£ŸÇŸÜÿπŸÉŸÖ ÿ£ŸÉÿ™ÿ±ÿü</p><div class="w-full space-y-4"><button onclick="debateVote(${game.p1.id})" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">${game.p1.name} (ŸÖÿπ)</button><button onclick="debateVote(${game.p2.id})" class="w-full py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">${game.p2.name} (ÿ∂ÿØ)</button></div></div>`; 
            } 
            if (game.phase === 'result') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-4">ÿ™ŸÖ ÿßŸÑÿ≠ŸÉŸÖ!</h2><p class="mb-8 text-slate-400">ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜŸÇÿ∑ÿ© ŸÑŸÑŸÅÿßÿ¶ÿ≤.</p><button onclick="startDebateGame()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ŸÇÿ∂Ÿäÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; 
            } 
        }

        // --- HEADS UP (FIXED) ---
        function startHeadsUpGame(category) {
            // PATCH 5: Validate minimum players
            if (!validateMinPlayers(2)) return;
            
            // PATCH 1: Clear intervals
            clearAllIntervals();
            
            const words = HEADS_UP_DATA[category];
            const player = getFairPlayer();
            state.currentGame = {
                type: 'heads_up',
                phase: 'ready_check',
                category: category,
                pool: [...words],
                currentWord: null,
                score: 0,
                timeLeft: 60,
                skipped: 0,
                currentPlayer: player,
                wordHidden: true
            };
            playSound('click');
            saveState();
            render();
        }

        function startHeadsUpMix() {
            console.log('üîÄ Mix Button Clicked for [Heads Up - ÿπŸÑŸâ ÿ±ÿßÿ≥Ÿä]');
            
            // Combine all categories into one mixed array
            let allWords = Object.values(HEADS_UP_DATA).flat();
            
            // Remove duplicates
            allWords = [...new Set(allWords)];
            
            console.log(`‚úÖ Total Items found: ${allWords.length}`);
            console.log(`üìù Sample Items: [${allWords.slice(0, 5).join(', ')}...]`);
            
            // Shuffle using Fisher-Yates
            for (let i = allWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
            }
            const player = getFairPlayer();
            state.currentGame = {
                type: 'heads_up',
                phase: 'ready_check',
                category: 'ŸÉŸàŸÉÿ™ŸäŸÑ üîÄ',
                pool: allWords,
                currentWord: null,
                score: 0,
                timeLeft: 60,
                skipped: 0,
                currentPlayer: player,
                wordHidden: true
            };
            playSound('click');
            saveState();
            render();
        }

        function headsUpReady() {
            const words = state.currentGame.pool;
            state.currentGame.currentWord = words[Math.floor(Math.random() * words.length)];
            state.currentGame.phase = 'playing';
            state.currentGame.wordHidden = true;
            playSound('click');
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                const t = document.getElementById('hu-timer');
                if(t) t.innerText = state.currentGame.timeLeft;
                if (state.currentGame.timeLeft <= 0) {
                    clearInterval(gameInterval);
                    updateScore(state.currentGame.currentPlayer.id, false, state.currentGame.score);
                    state.currentGame.phase = 'result';
                    playSound('fail');
                    saveState();
                    render();
                } else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
        }

        function revealHeadsUpWord() {
            state.currentGame.wordHidden = false;
            playSound('click');
            render();
        }

        function headsUpCorrect() {
            // Validation: Must reveal card first
            if (state.currentGame.wordHidden) {
                playSound('fail');
                
                // Create Warning Toast (Same style/text as Spy Game)
                const warning = document.createElement('div');
                warning.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[100] animate-in border-2 border-red-400 whitespace-nowrap';
                warning.innerText = '( ÿ∑ÿ® ÿÆÿØ ŸÅŸÉÿ±Ÿá ÿ¥ŸàŸÅ ÿßŸÑŸÉŸÑŸÖŸá .. ŸÅŸàŸàŸàŸàŸÇŸà ÿ®ŸÇŸä üò° )';
                document.body.appendChild(warning);
                
                // Fade out and remove
                setTimeout(() => {
                    warning.style.opacity = '0';
                    warning.style.transition = 'opacity 0.3s';
                    setTimeout(() => warning.remove(), 300);
                }, 2000);
                
                return; // Stop execution
            }

            state.currentGame.score++;
            playSound('success');
            headsUpNextWord();
        }

        function headsUpPass() {
            // Validation: Must reveal card first
            if (state.currentGame.wordHidden) {
                playSound('fail');
                
                // Create Warning Toast (Same style/text as Spy Game)
                const warning = document.createElement('div');
                warning.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[100] animate-in border-2 border-red-400 whitespace-nowrap';
                warning.innerText = '( ÿ∑ÿ® ÿÆÿØ ŸÅŸÉÿ±Ÿá ÿ¥ŸàŸÅ ÿßŸÑŸÉŸÑŸÖŸá .. ŸÅŸàŸàŸàŸàŸÇŸà ÿ®ŸÇŸä üò° )';
                document.body.appendChild(warning);
                
                // Fade out and remove
                setTimeout(() => {
                    warning.style.opacity = '0';
                    warning.style.transition = 'opacity 0.3s';
                    setTimeout(() => warning.remove(), 300);
                }, 2000);
                
                return; // Stop execution
            }

            state.currentGame.skipped++;
            playSound('fail');
            headsUpNextWord();
        }

        function headsUpNextWord() {
            const words = state.currentGame.pool;
            state.currentGame.currentWord = words[Math.floor(Math.random() * words.length)];
            state.currentGame.wordHidden = true;
            saveState();
            render();
        }

        function headsUpNewRound() {
            // CRITICAL FIX: Properly restart game with new player
            // Clear any existing interval
            if (gameInterval) clearInterval(gameInterval);
            
            // Get the category from current game
            const category = state.currentGame.category;
            
            // Start completely fresh game with new player (Fair Play rotation)
            const words = HEADS_UP_DATA[category];
            const newPlayer = getFairPlayer();
            
            state.currentGame = {
                type: 'heads_up',
                phase: 'ready_check',
                category: category,
                pool: [...words],
                currentWord: null,
                score: 0,
                timeLeft: 60,
                skipped: 0,
                currentPlayer: newPlayer,
                wordHidden: true
            };
            
            playSound('click');
            saveState();
            render();
        }

        function renderHeadsUpSetup() {
            if (!state.currentGame || state.currentGame.type !== 'heads_up') {
                const categories = Object.keys(HEADS_UP_DATA);
                return `
                    <div class="p-6 h-screen flex flex-col bg-slate-800">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="navigate('home')" class="p-2 bg-slate-700 rounded-xl hover:bg-slate-600 text-white transition active:scale-95 shadow-lg border border-slate-600/50">
                                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                            </button>
                            <h1 class="text-2xl font-black text-white">ü§Ø ÿπŸÑŸâ ÿ±ÿßÿ≥Ÿä</h1>
                            <div class="w-10"></div>
                        </div>
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">ü§Ø</div>
                            <h3 class="font-bold text-white mb-2">ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => {
                                // Format category name: put text in parentheses on new line with smaller/lighter text
                                let displayName = cat;
                                if (cat.includes('(')) {
                                    displayName = cat.replace('(', '<br/><span class="text-sm opacity-90">(') + '</span>';
                                }
                                return `
                                <button onclick="startHeadsUpGame('${cat}')" class="w-full min-h-[80px] flex items-center justify-center py-6 rounded-3xl font-black text-xl shadow-xl bg-indigo-500 hover:bg-indigo-600 text-white transition active:scale-95 text-center break-words leading-tight">
                                    ${displayName}
                                </button>
                            `;
                            }).join('')}
                        </div>
                        <button onclick="startHeadsUpMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-purple-600 to-blue-600 shadow-lg shadow-purple-500/50 border border-purple-400/30 text-white font-black text-xl py-4 rounded-2xl hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>üîÄ</span> ŸÉŸàŸÉÿ™ŸäŸÑ ŸÉŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
                        </button>
                    </div>
                `;
            }

            const game = state.currentGame;

            if (game.phase === 'ready_check') {
                return `
                    <div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in">
                        <p class="text-xl text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p>
                        <h1 class="text-5xl font-black mb-10 text-yellow-300">${escapeHtml(game.currentPlayer.name)}</h1>
                        <div class="bg-slate-700 p-6 rounded-3xl mb-8 border border-slate-600/50 shadow-xl">
                            <p class="text-lg">ÿ≠ÿ∑ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ÿπŸÑŸâ ÿ¨ÿ®Ÿáÿ™ŸÉ üì≤</p>
                            <p class="text-sm text-slate-400 mt-2">ÿÆŸÑŸä ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸÜÿßÿ≠Ÿäÿ© ÿµÿ≠ÿßÿ®ŸÉ</p>
                        </div>
                        <button onclick="headsUpReady()" class="w-full py-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded-2xl font-bold text-2xl shadow-xl active:scale-95 transition">
                            ÿ¨ÿßŸáÿ≤! ÿßÿ®ÿØÿ£
                        </button>
                    </div>
                `;
            }

            if (game.phase === 'playing') {
                return `
                    <div class="h-screen flex flex-col p-4 bg-slate-800 relative">
                        <!-- Player Name - Glass Frame (Top-Right) -->
                        <div class="absolute top-4 right-4 z-40 bg-slate-700/80 backdrop-blur-md border border-slate-600/50 rounded-xl px-4 py-2 text-white font-bold text-lg shadow-xl">
                            ${game.currentPlayer.name}
                        </div>

                        <!-- Timer (Centered) -->
                        <div class="text-center mb-4 text-white pt-2">
                            <div class="text-4xl font-black text-yellow-300" id="hu-timer">${game.timeLeft}</div>
                        </div>

                        <!-- Main Card Area -->
                        <div class="flex-1 flex items-center justify-center relative mb-4">
                            <div onclick="revealHeadsUpWord()" class="w-full h-full bg-slate-700 rounded-3xl shadow-2xl flex items-center justify-center cursor-pointer relative overflow-hidden border border-slate-600/50">
                                ${game.wordHidden ? `
                                    <div class="text-center animate-pulse">
                                        <div class="text-8xl text-slate-500 font-black mb-4">?</div>
                                        <p class="text-slate-400 font-bold text-xl">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ∏Ÿáÿ± ÿßŸÑŸÉŸÑŸÖÿ©</p>
                                    </div>
                                ` : `
                                    <!-- Rotated Text Container -->
                                    <div class="rotate-90-text text-center w-[200vh]">
                                        <h1 class="text-6xl md:text-8xl font-black text-white leading-tight">
                                            ${game.currentWord}
                                        </h1>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Controls (Standard Buttons) -->
                        <div class="grid grid-cols-2 gap-4 h-24">
                            <button onclick="headsUpPass()" class="bg-rose-500 hover:bg-rose-600 text-white rounded-2xl text-xl font-bold flex flex-col items-center justify-center shadow-lg active:scale-95 transition">
                                <span>‚úó</span>
                                <span>ÿ™ÿÆÿ∑Ÿä</span>
                            </button>
                            <button onclick="headsUpCorrect()" class="bg-teal-500 hover:bg-teal-600 text-white rounded-2xl text-xl font-bold flex flex-col items-center justify-center shadow-lg active:scale-95 transition">
                                <span>‚úì</span>
                                <span>ÿπÿ±ŸÅŸáÿß</span>
                            </button>
                        </div>
                    </div>
                `;
            }

            if (game.phase === 'result') {
                return `
                    <div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in">
                        <h2 class="text-3xl font-bold mb-2">ÿÆŸÑÿµ ÿßŸÑŸàŸÇÿ™!</h2>
                        <h1 class="text-4xl font-black text-yellow-300 mb-6">${game.currentPlayer.name}</h1>
                        
                        <div class="grid grid-cols-2 gap-4 w-full mb-8">
                            <div class="bg-slate-700 p-4 rounded-3xl border border-slate-600/50 shadow-xl">
                                <div class="text-4xl font-black text-teal-300">${game.score}</div>
                                <div class="text-sm text-slate-400">ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠</div>
                            </div>
                            <div class="bg-slate-700 p-4 rounded-3xl border border-slate-600/50 shadow-xl">
                                <div class="text-4xl font-black text-rose-300">${game.skipped}</div>
                                <div class="text-sm text-slate-400">ÿ™ÿÆÿ∑Ÿä</div>
                            </div>
                        </div>

                        <button onclick="headsUpNewRound()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-xl shadow-lg mb-3 active:scale-95 transition">
                            üîÑ ÿ±ÿßÿ≥ ÿ¨ÿØŸäÿØÿ©
                        </button>
                        
                        <button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold active:scale-95 transition border border-slate-600/50 shadow-lg">ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
                    </div>
                `;
            }
        }

        // ================== OTHER GAMES ==================
        function startEmojiMix() {
            console.log('üîÄ Mix Button Clicked for [Emoji Quiz - ŸÅŸÉ ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä]');
            
            // Combine all categories into one mixed array
            let allItems = Object.values(EMOJI_QUIZ_DATA).flat();
            
            // Remove duplicates (by emoji signature)
            const seen = new Set();
            allItems = allItems.filter(item => {
                const key = item.emoji;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
            
            console.log(`‚úÖ Total Items found: ${allItems.length}`);
            console.log(`üìù Sample Items: [${allItems.slice(0, 3).map(i => i.emoji).join(', ')}...]`);
            
            // Shuffle using Fisher-Yates
            for (let i = allItems.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
            }
            const roundData = getUniqueItem('emoji_mix', allItems);
            state.currentGame = { type: 'emoji', phase: 'playing', category: 'ŸÉŸàŸÉÿ™ŸäŸÑ üîÄ', data: roundData, revealed: false }; 
            playSound('click'); 
            saveState();
            render();
        }
        
        function startEmojiGame(category) {
            const categoryData = EMOJI_QUIZ_DATA[category] || EMOJI_QUIZ_DATA['ÿ£ŸÅŸÑÿßŸÖ ÿπÿ±ÿ®Ÿä'];
            const roundData = getUniqueItem('emoji_' + category, categoryData);
            state.currentGame = { type: 'emoji', phase: 'playing', category, data: roundData, revealed: false }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function revealEmojiAnswer() { state.currentGame.revealed = true; playSound('click'); saveState(); render(); }
        function emojiPlayerWins(playerId) { 
            updateScore(playerId, false, 1); 
            startEmojiGame(state.currentGame.category); 
        }
        function emojiSkip() { 
            startEmojiGame(state.currentGame.category); 
        }
        function renderEmojiSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'emoji') {
                const categories = Object.keys(EMOJI_QUIZ_DATA);
                return `
                    <div class="p-6 h-screen flex flex-col bg-slate-800">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="navigate('home')" class="p-2 bg-slate-700 rounded-xl hover:bg-slate-600 text-white transition active:scale-95 shadow-lg border border-slate-600/50">
                                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                            </button>
                            <h1 class="text-2xl font-black text-white">üß© ŸÅŸÉ ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä</h1>
                            <div class="w-10"></div>
                        </div>
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">üß©</div>
                            <h3 class="font-bold text-white mb-2">ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÅÿ¶ÿ©:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => `
                                <button onclick="startEmojiGame('${cat}')" class="py-6 rounded-3xl font-black text-xl shadow-xl bg-orange-500 hover:bg-orange-600 text-white transition active:scale-95">
                                    ${cat}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="startEmojiMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-purple-600 to-blue-600 shadow-lg shadow-purple-500/50 border border-purple-400/30 text-white font-black text-xl py-4 rounded-2xl hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>üîÄ</span> ŸÉŸàŸÉÿ™ŸäŸÑ ŸÉŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
                        </button>
                    </div>
                `;
            }
            const game = state.currentGame; 
            return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="bg-slate-700 p-8 rounded-3xl shadow-xl w-full mb-8 border border-slate-600/50"><div class="text-6xl mb-4 leading-relaxed">${game.data.emojis}</div></div>${!game.revealed ? `<button onclick="revealEmojiAnswer()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©</button>` : `<div class="mb-8 animate-in w-full"><p class="text-lg text-slate-400 mb-2">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©:</p><h2 class="text-4xl font-black text-yellow-300">${game.data.answer}</h2></div><p class="text-lg text-white font-bold mb-4">ŸÖŸäŸÜ ÿßŸÑŸÑŸä ÿπÿ±ŸÅ ÿßŸÑÿ≠ŸÑÿü</p><div class="grid grid-cols-2 gap-3 w-full mb-4">${state.players.map(p => `<button onclick="emojiPlayerWins(${p.id})" class="py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">${escapeHtml(p.name)}</button>`).join('')}</div><button onclick="emojiSkip()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold mb-3 shadow-lg active:scale-95 transition border border-slate-600/50">ŸÖÿ≠ÿØÿ¥ ÿπÿ±ŸÅ (ÿ™ÿÆÿ∑Ÿä)</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button>`}</div>`; 
        }
        function startLyricsGame() { 
            const roundData = getUniqueItem('lyrics', LYRICS_DATA);
            const player = getFairPlayer(); 
            state.currentGame = { type: 'lyrics', phase: 'playing', data: roundData, player, lyricsRevealed: false, answerRevealed: false }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function revealLyricsText() { 
            state.currentGame.lyricsRevealed = true; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function revealLyricsAnswer() { 
            state.currentGame.answerRevealed = true; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function lyricsPlayerWins(playerId) { 
            updateScore(playerId, false, 1); 
            startLyricsGame(); 
        }
        function lyricsSkip() { 
            startLyricsGame(); 
        }
        function renderLyricsSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'lyrics') return renderGameStartScreen('ŸÉŸÖŸÑ ÿßŸÑÿ£ÿ∫ŸÜŸäÿ©', 'ŸáŸäÿ∏Ÿáÿ± ŸÖŸÇÿ∑ÿπ ŸÖŸÜ ÿ£ÿ∫ŸÜŸäÿ© ŸàŸÅŸäŸá ŸÉŸÑŸÖÿ© ŸÜÿßŸÇÿµÿ©. ŸÉŸÖŸÑŸáÿß Ÿàÿ∫ŸÜŸäŸáÿß ÿµÿ≠!', 'üé§', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startLyricsGame()', 'bg-purple-500'); 
            const game = state.currentGame; 
            if (!game.lyricsRevealed) {
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-400 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 class="text-2xl font-bold">${game.player.name}</h2></div><p class="mb-4 text-slate-400 font-bold">${game.data.singer}</p><div class="bg-slate-700 p-8 rounded-3xl w-full mb-8 border border-slate-600/50 shadow-xl relative overflow-hidden"><div class="absolute inset-0 bg-slate-800 blur-md flex items-center justify-center"><span class="text-4xl font-black opacity-50">üéµ</span></div><h2 class="text-2xl font-bold leading-relaxed mb-2 relative z-10" style="filter: blur(8px); user-select: none;">"${game.data.part}"</h2><div class="inline-block px-6 py-2 bg-slate-600/50 rounded-lg mt-2 text-yellow-300 font-black text-2xl relative z-10" style="filter: blur(8px);">${game.data.answer}</div></div><button onclick="revealLyricsText()" class="w-full py-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ŸÉÿ¥ŸÅ ÿßŸÑŸÉŸÑŸÖÿßÿ™</button></div>`;
            }
            if (!game.answerRevealed) {
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-400 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><p class="mb-4 text-slate-400 font-bold">${game.data.singer}</p><div class="bg-slate-700 p-8 rounded-3xl w-full mb-8 border border-slate-600/50 shadow-xl"><h2 class="text-2xl font-bold leading-relaxed mb-2">"${game.data.part}"</h2><div class="inline-block px-6 py-2 bg-slate-600/50 rounded-lg mt-2 text-yellow-300 font-black text-2xl">ÿüÿüÿüÿüÿü</div></div><button onclick="revealLyricsAnswer()" class="w-full py-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ŸÉÿ¥ŸÅ ÿßŸÑŸÉŸÑŸÖÿ©</button></div>`;
            }
            return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-400 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><p class="mb-4 text-slate-400 font-bold">${game.data.singer}</p><div class="bg-slate-700 p-8 rounded-3xl w-full mb-8 border border-slate-600/50 shadow-xl"><h2 class="text-2xl font-bold leading-relaxed mb-2">"${game.data.part}"</h2><div class="inline-block px-6 py-2 bg-slate-600/50 rounded-lg mt-2 text-yellow-300 font-black text-2xl">${game.data.answer}</div></div><p class="text-lg text-white font-bold mb-4">ŸÖŸäŸÜ ÿßŸÑŸÑŸä ÿπÿ±ŸÅ ÿßŸÑÿ≠ŸÑÿü</p><div class="grid grid-cols-2 gap-3 w-full mb-4">${state.players.map(p => `<button onclick="lyricsPlayerWins(${p.id})" class="py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">${escapeHtml(p.name)}</button>`).join('')}</div><button onclick="lyricsSkip()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold mb-3 shadow-lg active:scale-95 transition border border-slate-600/50">ŸÖÿ≠ÿØÿ¥ ÿπÿ±ŸÅ (ÿ™ÿÆÿ∑Ÿä)</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; 
        }

        // --- UNSCRAMBLE ---
        function scrambleWord(word) {
            const letters = word.split('');
            // Fisher-Yates shuffle
            for (let i = letters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [letters[i], letters[j]] = [letters[j], letters[i]];
            }
            return letters.join('');
        }
        function startUnscrambleGame() {
            const item = getUniqueItem('unscramble', SCRAMBLE_DATA);
            const scrambled = scrambleWord(item.word);
            const player = getFairPlayer();
            state.currentGame = { type: 'unscramble', phase: 'playing', category: item.category, word: item.word, scrambled, player, revealed: false };
            playSound('click');
            saveState();
            render();
        }
        function revealUnscrambleAnswer() {
            state.currentGame.revealed = true;
            playSound('click');
            render();
        }
        function unscramblePlayerWins(playerId) {
            updateScore(playerId, false, 1);
            startUnscrambleGame();
        }
        function unscrambleSkip() {
            startUnscrambleGame();
        }
        function renderUnscrambleSetup() {
            if (!state.currentGame || state.currentGame.type !== 'unscramble') return renderGameStartScreen('ÿ±ÿ™ÿ®Ÿáÿß ÿµÿ≠', 'ŸÉŸÑŸÖÿ© ÿ≠ÿ±ŸàŸÅŸáÿß ŸÖÿ™ŸÑÿÆÿ®ÿ∑ÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÅÿ¶ÿ© ŸÖÿπŸäŸÜÿ©. ÿ≠ÿßŸàŸÑ ÿ™ÿπÿ±ŸÅ ÿßŸÑŸÉŸÑŸÖÿ© Ÿàÿ™ÿ±ÿ™ÿ®Ÿáÿß ÿµÿ≠!', 'üîÄ', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startUnscrambleGame()', 'bg-green-600');
            const game = state.currentGame;
            if (!game.revealed) {
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-400 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 class="text-2xl font-bold">${game.player.name}</h2></div><div class="bg-slate-700 p-6 rounded-3xl mb-6 w-full shadow-xl border border-slate-600/50"><p class="text-sm text-slate-400 mb-2">ÿßŸÑŸÅÿ¶ÿ©:</p><h3 class="text-2xl font-bold text-yellow-300">${game.category}</h3></div><div class="bg-slate-700 p-8 rounded-3xl w-full mb-8 border border-slate-600/50 shadow-xl"><h1 class="text-5xl font-black text-yellow-300 tracking-widest">${game.scrambled}</h1></div><button onclick="revealUnscrambleAnswer()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©</button></div>`;
            }
            return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-400 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 class="text-2xl font-bold">${game.player.name}</h2></div><div class="bg-slate-700 p-6 rounded-3xl mb-6 w-full shadow-xl border border-slate-600/50"><p class="text-sm text-slate-400 mb-2">ÿßŸÑŸÅÿ¶ÿ©:</p><h3 class="text-2xl font-bold text-yellow-300">${game.category}</h3></div><div class="bg-slate-700 p-8 rounded-3xl w-full mb-8 border border-slate-600/50 shadow-xl"><h1 class="text-5xl font-black text-yellow-300 tracking-widest mb-4">${game.scrambled}</h1><div class="border-t border-slate-600/50 pt-4"><p class="text-sm text-slate-400 mb-2">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©:</p><h2 class="text-4xl font-black text-teal-300">${game.word}</h2></div></div><p class="text-lg text-white font-bold mb-4">ŸÖŸäŸÜ ÿßŸÑŸÑŸä ÿπÿ±ŸÅ ÿßŸÑÿ≠ŸÑÿü</p><div class="grid grid-cols-2 gap-3 w-full mb-4">${state.players.map(p => `<button onclick="unscramblePlayerWins(${p.id})" class="py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">${p.name}</button>`).join('')}</div><button onclick="unscrambleSkip()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold mb-3 shadow-lg active:scale-95 transition border border-slate-600/50">ŸÖÿ≠ÿØÿ¥ ÿπÿ±ŸÅ (ÿ™ÿÆÿ∑Ÿä)</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`;
        }

        // --- SPY ---
        const SPY_TIPS = [
            "ÿ±ÿßŸÇÿ® ŸÑÿ∫ÿ© ÿßŸÑÿ¨ÿ≥ÿØ.. ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÖÿ™Ÿàÿ™ÿ± üò∞",
            "ŸÅŸä Ÿàÿßÿ≠ÿØ ÿ®Ÿäÿ≠ÿßŸàŸÑ Ÿäÿ∫Ÿäÿ± ÿßŸÑŸÖŸàÿ∂Ÿàÿπ ü§î",
            "ÿ®ÿµ ŸÅŸä ÿπŸäŸÜ ÿßŸÑŸÑŸä ÿ¨ŸÜÿ®ŸÉ üëÅÔ∏è",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ®Ÿäÿπÿ±ŸÇ ÿØŸÑŸàŸÇÿ™Ÿä üí¶",
            "ŸÖŸäŸÜ ÿ≥ÿßŸÉÿ™ ÿ≤ŸäÿßÿØÿ© ÿπŸÜ ÿßŸÑŸÑÿ≤ŸàŸÖÿü üò∂",
            "ÿ´ŸÇ ŸÅŸä ÿ≠ÿØÿ≥ŸÉ.. ÿ®ÿ≥ ŸÖÿ¥ ÿ£ŸàŸä üòà",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ®Ÿäÿ∂ÿ≠ŸÉ ÿ∂ÿ≠ŸÉÿ© ÿµŸÅÿ±ÿß üòÇ",
            "ŸÖŸäŸÜ ÿ®Ÿäÿ®ÿ±ÿ®ÿ¥ ŸÉÿ™Ÿäÿ±ÿü ü§®",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿπÿßŸÖŸÑ ŸÜŸÅÿ≥Ÿá ŸÖŸÜ ÿ®ŸÜŸáÿß üè†",
            "ÿ±ŸÉÿ≤ ŸÅŸä ŸÜÿ®ÿ±ÿ© ÿßŸÑÿµŸàÿ™.. ŸÖŸáÿ≤Ÿàÿ≤ÿ©ÿü üìâ",
            "ÿ≠ÿØ ÿ®Ÿäÿ≠ÿßŸàŸÑ Ÿäÿ™ŸàŸá ÿßŸÑŸÉŸÑÿßŸÖ ÿπÿ¥ÿßŸÜ ÿÆÿßŸäŸÅ üó£Ô∏è",
            "ÿßŸÑŸÑŸä ÿµŸàÿ™Ÿá ÿπÿßŸÑŸä ÿ∫ÿßŸÑÿ®ÿßŸã ÿ®ŸäŸÖÿ´ŸÑ üé≠",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÜÿ≥Ÿä ŸáŸà ŸÅŸäŸÜ ÿ£ÿµŸÑÿßŸã üåç",
            "ÿ®ÿµ ÿπŸÑŸâ ÿ•ŸäÿØŸäŸáŸÖ.. ŸÖŸäŸÜ ÿ®ŸäŸÅÿ±ŸÉÿü üëê",
            "Ÿäÿß ÿ™ÿ±Ÿâ ŸÖŸäŸÜ ÿßŸÑŸÑŸä ÿ®ÿßÿπŸÜÿßÿü üí∏",
            "ÿ¥ŸÉ ŸÅŸä ÿ£ŸÇÿ±ÿ® ÿßŸÑŸÜÿßÿ≥ ŸÑŸäŸÉ üëØ‚Äç‚ôÇÔ∏è",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ®ŸäŸÅŸÉÿ± ŸÅŸä ŸÉÿØÿ®ÿ© ÿØŸÑŸàŸÇÿ™Ÿä üí≠",
            "ŸÖŸäŸÜ ÿ®Ÿäÿ∂ÿ≠ŸÉ ŸÖŸÜ ÿ∫Ÿäÿ± ÿ≥ÿ®ÿ®ÿü ü§£",
            "ÿßŸÑŸÑŸä ÿ®Ÿäÿ®ÿµ ŸÅŸä ÿßŸÑÿ≥ŸÇŸÅ ÿØŸá ŸÖÿ¥ ŸÖÿ±Ÿäÿ≠ üôÑ",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿπÿßŸäÿ≤ ÿßŸÑÿ¨ŸàŸÑÿ© ÿ™ÿÆŸÑÿµ ÿ®ÿ≥ÿ±ÿπÿ© ‚è±Ô∏è",
            "ÿ≥ÿ§ÿßŸÑ ÿ´ÿπÿ®ÿßŸÜŸä ŸáŸäÿ®ŸäŸÜ ŸÉŸÑ ÿ≠ÿßÿ¨ÿ© üêç",
            "ÿßŸàÿπŸâ ÿ™ÿ∏ŸÑŸÖ ÿßŸÑÿ®ÿ±Ÿäÿ°.. (ÿ£Ÿà ÿßÿ∏ŸÑŸÖŸá ÿπÿßÿØŸä) ‚öñÔ∏è",
            "ŸÜÿ∏ÿ±ÿßÿ™ ÿßŸÑÿπŸäŸàŸÜ ŸÅÿ∂ÿßÿ≠ÿ© üëÄ",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÖÿ¥ ÿπÿßÿ±ŸÅ ÿ•ÿ≠ŸÜÿß ÿ®ŸÜÿ™ŸÉŸÑŸÖ ÿπŸÜ ÿ•ŸäŸá ü§∑‚Äç‚ôÇÔ∏è",
            "ŸÖŸäŸÜ ŸàÿßŸÉŸÑ ÿ≥ÿØ ÿßŸÑÿ≠ŸÜŸÉÿü ü§ê",
            "ÿßŸÑÿ≠ÿ±ŸÉÿ© ÿØŸä ŸÖÿ¥ ÿ≠ÿ±ŸÉÿ© ŸÖŸàÿßÿ∑ŸÜ ÿ¥ÿ±ŸäŸÅ üö®",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ®Ÿäÿ≠ÿßŸàŸÑ ŸäŸÇŸÑÿØŸÉŸÖ ü¶ú",
            "ŸÖŸäŸÜ Ÿàÿ¥Ÿá ÿ£ÿ≠ŸÖÿ±ÿü üò≥",
            "ÿÆŸÑŸä ÿ®ÿßŸÑŸÉ ŸÖŸÜ ÿßŸÑŸáÿßÿØŸä.. ŸÖŸäÿßŸá ŸÖŸÜ ÿ™ÿ≠ÿ™ ÿ™ÿ®ŸÜ üåä",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ®ŸäŸÇŸàŸÑ Ÿäÿßÿ±ÿ® ŸÖÿ≠ÿØÿ¥ Ÿäÿ≥ÿ£ŸÑŸÜŸä ü§≤",
            "ÿßÿ±ŸÖŸä ŸÉŸÑŸÖÿ© Ÿàÿ¥ŸàŸÅ ÿ±ÿØ ÿßŸÑŸÅÿπŸÑ üí£",
            "ŸÖŸäŸÜ ÿπŸÖÿßŸÑ Ÿäÿ®ÿµ ŸÅŸä ÿßŸÑÿ≥ÿßÿπÿ©ÿü ‚åö",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ®Ÿäÿ®ÿµ ÿπŸÑŸâ ÿßŸÑŸÑŸä ÿ®Ÿäÿ™ŸÉŸÑŸÖ ÿ®ÿ™ÿ±ŸÉŸäÿ≤ ÿ£ŸàŸä üßê",
            "ÿ•ÿ≠ÿ≥ÿßÿ≥Ÿä ÿ®ŸäŸÇŸàŸÑ ÿ•ŸÜ ÿßŸÑŸÑŸä ÿ¨ŸÜÿ®ŸÉ ŸáŸà ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ üëâ",
            "ŸÖŸäŸÜ ÿ±ŸäŸÇŸá ŸÜÿßÿ¥ŸÅÿü ü•§",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ®Ÿäÿ≠ÿßŸàŸÑ Ÿäÿ®ÿßŸÜ ÿ∑ÿ®ŸäÿπŸä ÿ®ÿßŸÑÿπÿßŸÅŸäÿ© ü§ñ",
            "ŸÉŸÑŸá ÿ™ÿ≠ÿ™ ÿßŸÑÿ≥Ÿäÿ∑ÿ±ÿ©.. ŸÖÿßÿπÿØÿß ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ü§Ø",
            "ÿßŸÑŸáÿ¨ŸàŸÖ ÿÆŸäÿ± Ÿàÿ≥ŸäŸÑÿ© ŸÑŸÑÿØŸÅÿßÿπ.. ÿ±ÿßŸÇÿ® ÿßŸÑŸÑŸä ÿ®ŸäŸáÿßÿ¨ŸÖ ‚öîÔ∏è",
            "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÖÿ®Ÿäÿ≠ÿ®ÿ¥ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸÇŸäŸÇÿ© üìù"
        ];

        function updateVotingTip() {
            const el = document.getElementById('discussion-tips-text');
            if(el) {
                // Fade out
                el.style.opacity = 0;
                setTimeout(() => {
                    el.innerText = SPY_TIPS[Math.floor(Math.random() * SPY_TIPS.length)];
                    // Fade in
                    el.style.opacity = 1;
                }, 300);
            }
        }

        function startSpyMix() {
            // Combine all categories into one mixed array
            const allWords = Object.values(SPY_CATEGORIES).flat();
            // Shuffle using Fisher-Yates
            for (let i = allWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
            }
            const word = getUniqueItem('spy_mix', allWords);
            const spyIndex = Math.floor(Math.random() * state.players.length);
            state.currentGame = { type: 'spy', phase: 'reveal', category: 'ŸÉŸàŸÉÿ™ŸäŸÑ üîÄ', word, spyIndex, currentPlayerIndex: 0, revealed: false, timeLeft: 120, votes: {}, votingPlayerIndex: 0 };
            saveState();
            render();
        }
        
        function startSpyGame(cat) { 
            // PATCH 5: Validate minimum players (Spy needs at least 3 players)
            if (!validateMinPlayers(3)) return;
            
            // PATCH 1: Clear intervals
            clearAllIntervals();
            
            const words = SPY_CATEGORIES[cat] || SPY_CATEGORIES['ÿ£ŸÖÿßŸÉŸÜ ÿÆÿ±Ÿàÿ¨']; 
            const word = getUniqueItem('spy_' + cat, words); 
            
            // POLISH FIX 2: Enhanced Spy RNG - Avoid same player twice in a row
            let spyIndex = Math.floor(Math.random() * state.players.length);
            
            // If there are 3+ players and we have history of previous spy
            if (state.players.length >= 3 && state.lastSpyIndex !== undefined) {
                let attempts = 0;
                const maxAttempts = 20; // Prevent infinite loop
                
                // Try to pick a different player
                while (spyIndex === state.lastSpyIndex && attempts < maxAttempts) {
                    spyIndex = Math.floor(Math.random() * state.players.length);
                    attempts++;
                }
                
                if (attempts > 0) {
                    console.log(`üé≤ Spy RNG: Avoided repeat spy after ${attempts} attempts`);
                }
            }
            
            // Store this spy index for next round
            state.lastSpyIndex = spyIndex;
            
            state.currentGame = { 
                type: 'spy', 
                phase: 'reveal', 
                category: cat, 
                word, 
                spyIndex, 
                currentPlayerIndex: 0, 
                revealed: false, 
                timeLeft: 120, 
                votes: {}, 
                votingPlayerIndex: 0 
            }; 
            saveState(); 
            render(); 
        }
        function revealSpyWord() {
            if (state.currentGame.revealed) return;
            
            state.currentGame.revealed = true;
            playSound('click');
            saveState();

            const cardContent = document.getElementById('spy-card-content');
            const cardBtn = document.getElementById('spy-reveal-btn');
            
            if (cardContent && cardBtn) {
                // Update Card Glow
                cardBtn.classList.remove('from-indigo-500/50', 'via-purple-500/50', 'to-indigo-800/50');
                cardBtn.classList.add('from-emerald-500/50', 'to-emerald-900/50', 'shadow-[0_0_50px_rgba(16,185,129,0.4)]');

                const isSpy = state.currentGame.spyIndex === state.currentGame.currentPlayerIndex;
                
                // Inject Content
                cardContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center h-full w-full animate-enter">
                        ${isSpy ? 
                        `
                            <div class="text-8xl mb-6 drop-shadow-[0_0_15px_rgba(239,68,68,0.5)]">üïµÔ∏è</div>
                            <h2 class="text-4xl font-black text-red-500 mb-2">ÿ£ŸÜÿ™ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!</h2>
                            <p class="text-slate-300 text-sm">ÿßÿπŸÖŸÑ ŸÜŸÅÿ≥ŸÉ ŸÖŸÜ ÿ®ŸÜŸáÿß üòâ</p>
                        ` : 
                        `
                            <div class="flex-1 flex flex-col items-center justify-center">
                                <p class="text-indigo-300 text-xs font-bold uppercase tracking-widest mb-6 opacity-70">ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ŸáŸä</p>
                                <h2 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-indigo-200 leading-tight drop-shadow-lg">${state.currentGame.word}</h2>
                            </div>
                            <p class="text-slate-400 text-xs mt-auto">ÿßŸÇŸÅÿ¥ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!</p>
                        `}
                    </div>
                `;
            }
        }
        function nextSpyPlayer() {
            // VALIDATION CHECK
            if (!state.currentGame.revealed) {
                playSound('fail');
                
                // Create Temporary Warning Toast
                const warning = document.createElement('div');
                warning.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[100] animate-in border-2 border-red-400 whitespace-nowrap';
                warning.innerText = '( ÿßŸÉÿ¥ŸÅ ÿßŸÖ ÿßŸÑŸÉÿßÿ±ÿ™ .. ŸÅŸàŸàŸàŸàŸÇ ÿ®ŸÇŸä üò° )';
                document.body.appendChild(warning);
                
                // Remove after 2 seconds
                setTimeout(() => {
                    warning.style.opacity = '0';
                    warning.style.transition = 'opacity 0.3s';
                    setTimeout(() => warning.remove(), 300);
                }, 2000);
                
                return; // Stop execution
            }

            // Existing Logic...
            if(state.currentGame.currentPlayerIndex < state.players.length - 1) { 
                state.currentGame.currentPlayerIndex++; 
                state.currentGame.revealed = false; 
            } else { 
                state.currentGame.phase = 'discuss'; 
                startSpyTimer(); 
            } 
            render();
        }
        function startSpyTimer() {
            if (gameInterval) clearInterval(gameInterval);
            
            // Initial render to show the timer immediately
            render();

            // Start Tips Rotation for Discussion Phase
            if (tipsInterval) clearInterval(tipsInterval);
            setTimeout(updateVotingTip, 100); // Initial tip
            tipsInterval = setInterval(updateVotingTip, 3500);

            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                
                // OPTIMIZED: Update DOM directly, NO full re-render
                const timerEl = document.getElementById('spy-timer-display');
                if (timerEl) {
                    timerEl.innerText = getTimer(state.currentGame.timeLeft);
                }

                if (state.currentGame.timeLeft <= 0) {
                    clearInterval(gameInterval);
                    if (tipsInterval) clearInterval(tipsInterval); // Stop tips when timer ends
                    startSpyVoting();
                } else if (state.currentGame.timeLeft <= 10) {
                    playSound('tick');
                }
                
                // Removed saveState() and render() from interval for performance
            }, 1000);
        }
        function startSpyVoting() {
            if (gameInterval) clearInterval(gameInterval);
            if (tipsInterval) clearInterval(tipsInterval); // Stop tips from discussion phase
            state.currentGame.phase = 'voting';
            state.currentGame.votingPlayerIndex = 0;
            playSound('fail'); // Alarm sound
            saveState();
            render(); // Render the new voting screen structure
        }
        function voteForSpy(suspectedPlayerId) {
            const voter = state.players[state.currentGame.votingPlayerIndex];
            state.currentGame.votes[voter.id] = suspectedPlayerId;
            if (state.currentGame.votingPlayerIndex < state.players.length - 1) {
                state.currentGame.votingPlayerIndex++;
                playSound('click');
                render();
            } else {
                // Clear tips interval when voting is complete
                if (tipsInterval) clearInterval(tipsInterval);
                // Calculate results
                const spyId = state.players[state.currentGame.spyIndex].id;
                const voteCounts = {};
                Object.values(state.currentGame.votes).forEach(votedId => {
                    voteCounts[votedId] = (voteCounts[votedId] || 0) + 1;
                });
                
                let spyFound = false;
                if (Object.keys(voteCounts).length > 0) {
                    const maxVotes = Math.max(...Object.values(voteCounts));
                    const mostVoted = Object.keys(voteCounts).find(id => voteCounts[id] === maxVotes);
                    if (mostVoted) {
                        spyFound = parseInt(mostVoted) === spyId;
                    }
                }
                
                if (spyFound) {
                    // All players except spy get +1
                    state.players.forEach(p => {
                        if (p.id !== spyId) updateScore(p.id, false, 1);
                    });
                } else {
                    // Spy gets +2
                    updateScore(spyId, false, 2);
                }
                
                state.currentGame.spyFound = spyFound;
                state.currentGame.phase = 'result';
                playSound(spyFound ? 'success' : 'fail');
                saveState();
                render();
            }
        }
        function restartSpyGame() { startSpyGame(state.currentGame.category); }
        function renderSpySetup() { 
            if(!state.currentGame || state.currentGame.type !== 'spy') {
                const categories = Object.keys(SPY_CATEGORIES);
                return `
                    <div class="p-6 h-screen flex flex-col bg-slate-800">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="navigate('home')" class="p-2 bg-slate-700 rounded-xl hover:bg-slate-600 text-white transition active:scale-95 shadow-lg border border-slate-600/50">
                                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                            </button>
                            <h1 class="text-2xl font-black text-white">üïµÔ∏è ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥</h1>
                            <div class="w-10"></div>
                        </div>
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">üïµÔ∏è</div>
                            <h3 class="font-bold text-white mb-2">ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÅÿ¶ÿ©:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => `
                                <button onclick="startSpyGame('${cat}')" class="w-full min-h-[80px] flex items-center justify-center py-6 rounded-3xl font-black text-xl shadow-xl bg-rose-500 hover:bg-rose-600 text-white transition active:scale-95 text-center break-words leading-tight">
                                    ${cat}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="startSpyMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-purple-600 to-blue-600 shadow-lg shadow-purple-500/50 border border-purple-400/30 text-white font-black text-xl py-4 rounded-2xl hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>üîÄ</span> ŸÉŸàŸÉÿ™ŸäŸÑ ŸÉŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
                        </button>
                    </div>
                `;
            } 
            const game = state.currentGame;
            if(game.phase === 'reveal') { 
                const p = state.players[game.currentPlayerIndex];
                return `
                <div class="h-screen flex flex-col items-center justify-center bg-slate-800 text-white p-6 overflow-hidden relative">
                    <h1 class="text-4xl font-black mb-8 text-yellow-300 relative z-10">${p.name}</h1>
                    
                    <button id="spy-reveal-btn" onclick="revealSpyWord()" class="relative group w-full max-w-sm aspect-[3/4] rounded-[2rem] p-1 bg-gradient-to-br from-slate-700 via-slate-600 to-slate-700 shadow-xl transition-all duration-300 hover:scale-[1.02] active:scale-95 border border-slate-600/50">
                        <div class="w-full h-full bg-slate-700 backdrop-blur-xl rounded-[1.8rem] flex flex-col items-center justify-center p-6 border border-slate-600/30 relative overflow-hidden" id="spy-card-content">
                            <div class="flex flex-col items-center text-center animate-in">
                                <div class="text-7xl mb-6 opacity-80 group-hover:scale-110 transition-transform duration-500">üîí</div>
                                <h2 class="text-2xl font-bold text-white mb-2">ŸÖŸáŸÖÿ© ÿ≥ÿ±Ÿäÿ©</h2>
                                <p class="text-slate-400 text-sm">ÿØŸàÿ≥ ŸáŸÜÿß ÿπÿ¥ÿßŸÜ ÿ™ÿπÿ±ŸÅ ÿßŸÜÿ™ ŸÖŸäŸÜ..<br>ŸàÿßŸàÿπŸâ ÿ≠ÿØ Ÿäÿ®ÿµ ŸÖÿπÿßŸÉ! ü§´</p>
                                <div class="mt-8 px-6 py-2 rounded-full bg-slate-600/50 border border-slate-500/50 text-slate-300 text-xs font-bold animate-pulse">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÉÿ¥ŸÅ</div>
                            </div>
                        </div>
                    </button>

                    <button onclick="nextSpyPlayer()" class="mt-8 w-full max-w-sm py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-black text-xl shadow-xl active:scale-95 transition relative z-10">
                        ÿßŸÑÿ™ÿßŸÑŸä (ÿÆÿ®ŸëŸä ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ) ü´£
                    </button>
                </div>`;
            } 
            if(game.phase === 'discuss') {
                return `
                <div class="h-screen flex flex-col p-6 bg-slate-800 text-white">
                    <h1 class="text-3xl font-bold text-center mt-10 text-white">ŸÜÿßŸÇÿ¥Ÿàÿß Ÿàÿßÿπÿ±ŸÅŸàÿß ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!</h1>
                    <div id="spy-timer-display" class="text-6xl mt-8 font-black text-yellow-300 mx-auto" style="font-family: 'Cairo', sans-serif; font-variant-numeric: tabular-nums; width: 300px; text-align: center; font-weight: 900;">${getTimer(game.timeLeft)}</div>
                    
                    <div class="flex-1 flex items-center justify-center z-10">
                        <div class="bg-slate-700 border border-slate-600/50 p-6 rounded-3xl w-full max-w-sm text-center shadow-xl flex flex-col items-center justify-center min-h-[140px]">
                            <div class="text-rose-300 text-xs font-bold mb-2 tracking-widest uppercase bg-slate-600/50 px-3 py-1 rounded-full">ÿ™ŸÑŸÖŸäÿ≠:</div>
                            <p id="discussion-tips-text" class="text-xl font-bold text-white transition-all duration-500 flex items-center justify-center leading-relaxed">
                                ${SPY_TIPS[0]}
                            </p>
                        </div>
                    </div>
                    
                    <button onclick="startSpyVoting()" class="w-full bg-rose-500 hover:bg-rose-600 text-white py-4 rounded-2xl font-bold text-lg transition shadow-lg active:scale-95">
                        ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿµŸàŸäÿ™
                    </button>
                </div>`;
            } 
            if(game.phase === 'voting') {
                const voter = state.players[game.votingPlayerIndex];
                return `
                <div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white relative overflow-hidden animate-in gap-10">
                    <div class="text-center relative z-10 w-full">
                        <div class="text-6xl mb-4 drop-shadow-md">üßê</div>
                        <p class="text-slate-400 font-bold text-sm uppercase tracking-widest mb-2">ŸÖŸäŸÜ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÅŸä ÿ±ÿ£ŸäŸÉ Ÿäÿß</p>
                        <h1 class="text-5xl font-black text-yellow-300 leading-tight">
                            ${voter.name}
                        </h1>
                    </div>

                    <div class="w-full max-h-[50vh] overflow-y-auto relative z-10">
                        <p class="text-center text-slate-400 text-xs mb-3 font-bold">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑŸÖÿ¥ŸÉŸàŸÉ ŸÅŸäŸá üëá</p>
                        <div class="grid grid-cols-2 gap-4">
                            ${state.players.map(p => `
                            <button onclick="voteForSpy(${p.id})" class="py-5 bg-slate-700 hover:bg-slate-600 rounded-3xl font-bold text-xl transition-all border border-slate-600/50 shadow-xl active:scale-95 flex items-center justify-center gap-2 group">
                                <span class="grayscale group-hover:grayscale-0 transition">üë§</span> ${escapeHtml(p.name)}
                            </button>`).join('')}
                        </div>
                    </div>
                </div>`;
            }
            return `<div class="h-screen flex flex-col items-center justify-center bg-slate-800 text-white p-6 text-center"><div class="text-6xl mb-6">${game.spyFound ? 'üéâ' : 'üïµÔ∏è'}</div><h1 class="text-4xl mb-4 font-bold ${game.spyFound ? 'text-teal-300' : 'text-rose-300'}">${game.spyFound ? 'ÿπÿ±ŸÅŸàÿß ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!' : 'ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÅŸÑÿ™!'}</h1><div class="bg-slate-700 p-6 rounded-3xl mb-6 w-full shadow-xl border border-slate-600/50"><p class="text-xl mb-2 text-slate-400">ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÉÿßŸÜ:</p><h2 class="text-3xl font-black text-yellow-300">${escapeHtml(state.players[game.spyIndex].name)}</h2><p class="text-lg mt-4 text-slate-400">ÿßŸÑŸÉŸÑŸÖÿ©: ${game.word}</p></div><div class="mb-6"><p class="text-lg text-slate-400">${game.spyFound ? 'ŸÉŸÑ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ (ŸÖÿßÿπÿØÿß ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥) ÿ£ÿÆÿ∞Ÿàÿß +1 ŸÜŸÇÿ∑ÿ©' : 'ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ÿ£ÿÆÿ∞ +2 ŸÜŸÇÿ∑ÿ©'}</p></div><button onclick="restartSpyGame()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; 
        }

        // --- CHARADES ---
        function startCharadesMix() {
            console.log('üîÄ Mix Button Clicked for [Charades - ÿ®ÿØŸàŸÜ ŸÉŸÑÿßŸÖ]');
            
            // Combine all categories into one mixed array
            let allWords = Object.values(CHARADES_DATA).flat();
            
            // Remove duplicates
            allWords = [...new Set(allWords)];
            
            console.log(`‚úÖ Total Items found: ${allWords.length}`);
            console.log(`üìù Sample Items: [${allWords.slice(0, 5).join(', ')}...]`);
            
            // Shuffle using Fisher-Yates
            for (let i = allWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
            }
            const word = getUniqueItem('charades_mix', allWords);
            const actor = getFairPlayer();
            state.currentGame = { type: 'charades', phase: 'prepare', category: 'ŸÉŸàŸÉÿ™ŸäŸÑ üîÄ', word, actor, revealed: false, timeLeft: 60 };
            playSound('click');
            render();
        }
        
        function startCharadesGame(cat) { const words = CHARADES_DATA[cat]; const word = getUniqueItem('charades_' + cat, words); const actor = getFairPlayer(); state.currentGame = { type: 'charades', phase: 'prepare', category: cat, word, actor, revealed: false, timeLeft: 60 }; playSound('click'); render(); }
        function startCharadesRound() { state.currentGame.phase = 'acting'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = getTimer(state.currentGame.timeLeft); if(state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); charadesFail(); return; } if(state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function charadesSuccess() { updateScore(state.currentGame.actor.id, false, 1); startCharadesGame(state.currentGame.category); }
        function charadesFail() { if(state.daresEnabled) showDare(); startCharadesGame(state.currentGame.category); }
        function renderCharadesSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'charades') { 
                const categories = Object.keys(CHARADES_DATA); 
                return `
                    <div class="p-6 h-screen flex flex-col bg-slate-800">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="navigate('home')" class="p-2 bg-slate-700 rounded-xl hover:bg-slate-600 text-white transition active:scale-95 shadow-lg border border-slate-600/50">
                                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                            </button>
                            <h1 class="text-2xl font-black text-white">üé≠ ÿ®ÿØŸàŸÜ ŸÉŸÑÿßŸÖ</h1>
                            <div class="w-10"></div>
                        </div>
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">üé≠</div>
                            <h3 class="font-bold text-white mb-2">ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÅÿ¶ÿ©:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => `
                                <button onclick="startCharadesGame('${cat}')" class="py-6 rounded-3xl font-black text-xl shadow-xl bg-rose-500 hover:bg-rose-600 text-white transition active:scale-95">
                                    ${cat}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="startCharadesMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-purple-600 to-blue-600 shadow-lg shadow-purple-500/50 border border-purple-400/30 text-white font-black text-xl py-4 rounded-2xl hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>üîÄ</span> ŸÉŸàŸÉÿ™ŸäŸÑ ŸÉŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
                        </button>
                    </div>
                `; 
            } 
            const game = state.currentGame; 
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-xl text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p><h1 class="text-4xl font-black mb-8">${game.actor.name}</h1><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600/50 w-full mb-8 relative overflow-hidden shadow-xl">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-slate-800 z-10 flex items-center justify-center cursor-pointer hover:bg-slate-700 transition"><span class="text-xl font-bold animate-pulse">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑŸÉŸÑŸÖÿ©</span></div>` : ''}<p class="text-sm mb-2 text-slate-400">ŸÖÿ∑ŸÑŸàÿ® ÿ™ŸÖÿ´ŸäŸÑ:</p><h2 class="text-3xl font-bold text-yellow-300">${game.word}</h2></div><button onclick="startCharadesRound()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ÿ¨ÿßŸáÿ≤! ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ§ŸÇÿ™</button></div>`; 
            if (game.phase === 'acting') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="text-center mt-4 mb-8"><p class="text-lg font-bold text-slate-100">ÿßŸÑŸÖŸÖÿ´ŸÑ: <span class="text-rose-300">${game.actor.name}</span></p><h1 class="text-3xl font-black leading-relaxed text-center text-white mt-2">${game.word}</h1></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-8xl font-black text-rose-300" id="game-timer">${getTimer(game.timeLeft)}</div></div><div class="space-y-3"><button onclick="charadesSuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ÿπÿ±ŸÅŸàŸáÿß!</button><button onclick="charadesFail()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ŸÖÿπÿ±ŸÅŸàÿ¥ (ÿ™ÿÆÿ∑Ÿä)</button></div></div>`; 
        }

        // --- QUOTES ---
        function startQuotesGame() { const quote = getUniqueItem('quotes', QUOTES_DATA); const reader = getFairPlayer(); state.currentGame = { type: 'quotes', phase: 'play', quote, reader, revealed: false }; playSound('click'); render(); }
        function revealQuoteAnswer() { state.currentGame.phase = 'answer'; playSound('click'); render(); }
        function quotePlayerWins(pid) { updateScore(pid, false, 1); startQuotesGame(); }
        function nextQuoteRound() { startQuotesGame(); }
        function renderQuotesSetup() { if (!state.currentGame || state.currentGame.type !== 'quotes') return renderGameStartScreen('ÿßŸÑÿßŸÅŸäŸáÿßÿ™', 'Ÿàÿßÿ≠ÿØ ŸáŸäŸÇÿ±ÿ£ ÿßŸÑÿßŸÅŸäŸáÿå ŸàÿßŸÑÿ®ÿßŸÇŸä ŸÑÿßÿ≤ŸÖ ŸäÿÆŸÖŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÅŸäŸÑŸÖ/ÿßŸÑŸÖÿ≥ÿ±ÿ≠Ÿäÿ© ŸàÿßŸÑŸÖŸÖÿ´ŸÑ.', 'üé¨', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®', 'startQuotesGame()', 'bg-emerald-600'); const game = state.currentGame; if (game.phase === 'play') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ: <span class="font-bold text-white text-lg">${game.reader.name}</span></p><div class="text-sm bg-slate-700 px-3 py-1 rounded-full mb-8 border border-slate-600/50">ÿßŸÇÿ±ÿ£ ÿßŸÑÿßŸÅŸäŸá ÿ®ÿµŸàÿ™ ÿπÿßŸÑŸä</div><div class="relative mb-10 w-full">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-slate-700 z-10 rounded-3xl flex items-center justify-center cursor-pointer hover:bg-slate-600 transition h-32 border border-slate-600/50 shadow-xl"><span class="text-xl font-bold animate-pulse">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑÿßŸÅŸäŸá</span></div>` : `<div class="text-6xl absolute -top-8 -right-4 text-teal-300 opacity-50">"</div><h2 class="text-3xl font-black leading-relaxed px-4">${game.quote.quote}</h2><div class="text-6xl absolute -bottom-12 -left-4 text-teal-300 opacity-50">"</div>`}</div>${game.revealed ? `<button onclick="revealQuoteAnswer()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg mt-8 active:scale-95 transition">ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©</button>` : ''}</div>`; if (game.phase === 'answer') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="text-center mt-8 mb-8 border-b-2 border-slate-700 pb-8"><h2 class="text-slate-400 mb-2">ÿßŸÑÿßŸÅŸäŸá ŸÉÿßŸÜ:</h2><p class="text-xl font-bold text-white mb-6">"${game.quote.quote}"</p><div class="space-y-2"><div class="inline-block px-4 py-2 bg-teal-500 text-white rounded-2xl font-bold mx-1">üé¨ ${game.quote.work}</div><div class="inline-block px-4 py-2 bg-orange-500 text-white rounded-2xl font-bold mx-1">üë§ ${game.quote.actor}</div></div></div><h3 class="text-center font-bold text-white mb-4">ŸÖŸäŸÜ ÿπÿ±ŸÅŸáÿßÿü</h3><div class="grid grid-cols-2 gap-3 flex-1 overflow-y-auto pb-4">${state.players.map(p => `<button onclick="quotePlayerWins(${p.id})" class="p-3 bg-slate-700 border border-slate-600/50 rounded-2xl font-semibold text-white hover:bg-slate-600 shadow-lg active:scale-95 transition ${p.id === game.reader.id ? 'opacity-75' : ''}">${p.name}${p.id === game.reader.id ? ' (ÿßŸÑŸÇÿßÿ±ÿ¶)' : ''}</button>`).join('')}</div><div class="mt-4 space-y-2"><button onclick="nextQuoteRound()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ŸÖÿ≠ÿØÿ¥ ÿπÿ±ŸÅ (ÿßŸÑÿ™ÿßŸÑŸä)</button></div></div>`; }

        // --- FIVE SECOND ---
        function startFiveSecondGame() { const question = getUniqueItem('five_second', FIVE_SECOND_QUESTIONS); const player = getFairPlayer(); state.currentGame = { type: 'fivesecond', phase: 'prepare', question, player, revealed: false, timeLeft: 5 }; playSound('click'); render(); }
        function startFiveSecondRound() { state.currentGame.phase = 'playing'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); fiveSecondFail(); return; } if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function fiveSecondSuccess() { updateScore(state.currentGame.player.id, false, 1); startFiveSecondGame(); }
        function fiveSecondFail() { if(state.daresEnabled) showDare(); startFiveSecondGame(); }
        function renderFiveSecondSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'fivesecond') return renderGameStartScreen('ÿÆŸÖÿ≥ÿ© ÿπŸÑŸäŸÉ', 'ÿßÿ∞ŸÉÿ± Ÿ£ ÿ£ÿ¥Ÿäÿßÿ° ŸÅŸä Ÿ• ÿ´ŸàÿßŸÜŸä. ŸÑŸà ŸÜÿ¨ÿ≠ÿ™ ÿ™ÿßÿÆÿØ ŸÜŸÇÿ∑ÿ©ÿå ŸÑŸà ŸÅÿ¥ŸÑÿ™.. Ÿäÿß ŸàŸäŸÑŸá!', '‚è±Ô∏è', 'ÿßÿ®ÿØÿ£ ÿ£ŸàŸÑ ÿ¨ŸàŸÑÿ©', 'startFiveSecondGame()', 'bg-teal-600'); 
            const game = state.currentGame; 
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-xl text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p><h1 class="text-4xl font-black mb-8">${game.player.name}</h1><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600/50 w-full mb-8 relative overflow-hidden shadow-xl">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-slate-800 z-10 flex items-center justify-center cursor-pointer hover:bg-slate-700 transition"><span class="text-xl font-bold animate-pulse">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑÿ≥ÿ§ÿßŸÑ</span></div>` : ''}<p class="text-sm mb-2 text-slate-400">ŸÖÿ∑ŸÑŸàÿ® ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿπŸÑŸâ:</p><h2 class="text-3xl font-bold text-yellow-300">${game.question.text}</h2></div><button onclick="startFiveSecondRound()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition" ${!game.revealed ? 'disabled opacity-50' : ''}>ÿ¨ÿßŸáÿ≤! ÿßÿ®ÿØÿ£ ÿßŸÑÿ¨ŸàŸÑÿ©</button></div>`; 
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="text-center mt-4 mb-8"><p class="text-lg font-bold text-slate-100">ÿßŸÑŸÑÿßÿπÿ®: <span class="text-teal-300">${game.player.name}</span></p><h1 class="text-3xl font-black leading-relaxed text-center text-white mt-2">${game.question.text}</h1></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black ${game.timeLeft <= 2 ? 'text-rose-300 animate-pulse' : 'text-teal-300'}" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3"><button onclick="fiveSecondSuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ÿ£ÿ≠ÿ≥ŸÜÿ™! (ÿ£ÿ¨ÿßÿ® ÿµÿ≠)</button><button onclick="fiveSecondFail()" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition">üíÄ ŸÅÿ¥ŸÑ! (ÿπŸÇŸàÿ®ÿ©)</button></div></div>`; 
        }

        // --- BUS ---
        function startBusGame() { 
            const arabicLetters = ['ÿ£', 'ÿ®', 'ÿ™', 'ÿ´', 'ÿ¨', 'ÿ≠', 'ÿÆ', 'ÿØ', 'ÿ∞', 'ÿ±', 'ÿ≤', 'ÿ≥', 'ÿ¥', 'ÿµ', 'ÿ∂', 'ÿ∑', 'ÿπ', 'ÿ∫', 'ŸÅ', 'ŸÇ', 'ŸÉ', 'ŸÑ', 'ŸÖ', 'ŸÜ', 'Ÿá', 'Ÿà', 'Ÿä']; 
            const category = getUniqueItem('bus_categories', BUS_CATEGORIES);
            const letter = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
            
            state.currentGame = { type: 'bus', phase: 'ready', category, letter, playerIndex: 0, results: [], timeLeft: 20, lastCategory: category.name, lastLetter: letter }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startBusTimerNow() { state.currentGame.phase = 'playing'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); busPlayerFail(); return; } if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function generateNewBusRound() {
            const arabicLetters = ['ÿ£', 'ÿ®', 'ÿ™', 'ÿ´', 'ÿ¨', 'ÿ≠', 'ÿÆ', 'ÿØ', 'ÿ∞', 'ÿ±', 'ÿ≤', 'ÿ≥', 'ÿ¥', 'ÿµ', 'ÿ∂', 'ÿ∑', 'ÿπ', 'ÿ∫', 'ŸÅ', 'ŸÇ', 'ŸÉ', 'ŸÑ', 'ŸÖ', 'ŸÜ', 'Ÿá', 'Ÿà', 'Ÿä'];
            const lastCategory = state.currentGame.lastCategory;
            const lastLetter = state.currentGame.lastLetter;
            const currentPlayer = state.players[state.currentGame.playerIndex];
            
            let category, letter;
            // If not first player and same player as last, avoid same category and letter
            if (state.currentGame.playerIndex > 0 && lastCategory && lastLetter) {
                const lastPlayer = state.players[state.currentGame.playerIndex - 1];
                if (currentPlayer.id === lastPlayer.id) {
                    let availableCategories = BUS_CATEGORIES.filter(c => c.name !== lastCategory);
                    let availableLetters = arabicLetters.filter(l => l !== lastLetter);
                    category = availableCategories.length > 0 ? availableCategories[Math.floor(Math.random() * availableCategories.length)] : BUS_CATEGORIES[Math.floor(Math.random() * BUS_CATEGORIES.length)];
                    letter = availableLetters.length > 0 ? availableLetters[Math.floor(Math.random() * availableLetters.length)] : arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
                } else {
                    category = BUS_CATEGORIES[Math.floor(Math.random() * BUS_CATEGORIES.length)];
                    letter = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
                }
            } else {
                category = BUS_CATEGORIES[Math.floor(Math.random() * BUS_CATEGORIES.length)];
                letter = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
            }
            
            state.currentGame.category = category;
            state.currentGame.letter = letter;
            state.currentGame.lastCategory = category.name;
            state.currentGame.lastLetter = letter;
        }
        function busPlayerSuccess() { const player = state.players[state.currentGame.playerIndex]; state.currentGame.results.push({ player, success: true }); updateScore(player.id, false, 1); if (state.currentGame.playerIndex < state.players.length - 1) { state.currentGame.playerIndex++; generateNewBusRound(); state.currentGame.timeLeft = 20; state.currentGame.phase = 'ready'; playSound('success'); saveState(); render(); } else { state.currentGame.phase = 'result'; playSound('success'); saveState(); render(); } }
        function busPlayerFail() { const player = state.players[state.currentGame.playerIndex]; state.currentGame.results.push({ player, success: false }); if (state.currentGame.playerIndex < state.players.length - 1) { state.currentGame.playerIndex++; generateNewBusRound(); state.currentGame.timeLeft = 20; state.currentGame.phase = 'ready'; playSound('fail'); saveState(); render(); } else { state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } }
        function nextBusRound() { startBusGame(); }
        function renderBusSetup() { if (!state.currentGame || state.currentGame.type !== 'bus') return renderGameStartScreen('ÿ£Ÿàÿ™Ÿàÿ®Ÿäÿ≥ ŸÉŸàŸÖÿ®ŸÑŸäÿ™', 'ŸÉŸÑ ÿ¨ŸàŸÑÿ© ÿ™ÿ∏Ÿáÿ± ŸÅÿ¶ÿ© ŸàÿßŸÑÿ≠ÿ±ŸÅ ÿßŸÑÿ£ŸàŸÑ. ŸÅŸä Ÿ°Ÿ† ÿ´ŸàÿßŸÜŸä ŸÉŸÑ ŸÑÿßÿπÿ® ŸäŸÇŸàŸÑ ŸÉŸÑŸÖÿ© ÿ™ÿ®ÿØÿ£ ÿ®ÿßŸÑÿ≠ÿ±ŸÅ. ŸÑŸà ŸÜÿ¨ÿ≠ÿ™Ÿàÿß ŸÉŸÑŸÉŸÖ +Ÿ° ŸÑŸÉŸÑ ŸÜÿßÿ¨ÿ≠!', 'üöå', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startBusGame()', 'bg-purple-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-2xl text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</div><div class="text-5xl font-bold mb-10">${state.players[game.playerIndex].name}</div><div onclick="startBusTimerNow()" class="w-40 h-40 bg-indigo-500 hover:bg-indigo-600 rounded-full flex items-center justify-center cursor-pointer shadow-xl animate-pulse active:scale-95 transition border-4 border-indigo-400/30"><span class="text-2xl font-bold">ÿØŸàÿ≥<br>ÿπÿ¥ÿßŸÜ ÿ™ÿ®ÿØÿ£</span></div></div>`; if (game.phase === 'playing') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><div class="bg-slate-700 p-6 rounded-3xl mb-8 w-full shadow-xl border border-slate-600/50"><div class="text-sm text-slate-400 mb-2">ÿßŸÑŸÅÿ¶ÿ©</div><div class="text-4xl font-black mb-4">${game.category.name}</div><div class="text-sm text-slate-400 mb-2">ÿßŸÑÿ≠ÿ±ŸÅ</div><div class="text-6xl font-black text-yellow-300">${game.letter}</div></div><div class="mb-6"><div class="text-lg text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</div><div class="text-3xl font-bold">${state.players[game.playerIndex].name}</div></div><div class="text-7xl font-black mb-8" id="game-timer">${game.timeLeft}</div><div class="grid grid-cols-2 gap-3 w-full"><button onclick="busPlayerSuccess()" class="py-3 bg-teal-500 hover:bg-teal-600 rounded-2xl font-bold shadow-lg active:scale-95 transition">‚úì ŸÜÿ¨ÿ≠</button><button onclick="busPlayerFail()" class="py-3 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold shadow-lg active:scale-95 transition">‚úó ŸÅÿ¥ŸÑ</button></div></div>`; if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><h2 class="text-3xl font-bold mb-6">ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ¨ŸàŸÑÿ©!</h2><div class="bg-slate-700 p-6 rounded-3xl w-full mb-8 shadow-xl border border-slate-600/50">${game.results.map(r => `<div class="flex justify-between items-center py-2 border-b border-slate-600/50"><span>${r.player.name}</span><span class="text-2xl">${r.success ? '‚úì' : '‚úó'}</span></div>`).join('')}</div><button onclick="nextBusRound()" class="w-full py-4 bg-indigo-500 hover:bg-indigo-600 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold mt-3 shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; }

        // --- LIAR ---
        function startLiarGame() { const card = getUniqueItem('liar', LIAR_CARDS); const player = getFairPlayer(); state.currentGame = { type: 'liar', phase: 'ready', card, player, selectedFact: null, timeLeft: 15 }; playSound('click'); render(); }
        function startLiarTimerNow() { state.currentGame.phase = 'reading'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); if (state.currentGame.selectedFact !== null) revealLiarCard(); } if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function selectLiarFact(index) { state.currentGame.selectedFact = index; playSound('click'); render(); }
        function revealLiarCard() { state.currentGame.phase = 'result'; playSound('click'); saveState(); render(); }
        function liarGameAddPoint() { const p = getFairPlayer(); updateScore(p.id, false, 1); nextLiarRound(); }
        function nextLiarRound() { startLiarGame(); }
        function renderLiarSetup() { if (!state.currentGame || state.currentGame.type !== 'liar') return renderGameStartScreen('ÿßŸÑŸÉÿßÿ±ÿ™ ÿßŸÑŸÉÿØÿßÿ®', 'ŸÉŸÑ ŸÉÿßÿ±ÿ™ ŸÅŸäŸá Ÿ£ ÿ≠ŸÇÿßÿ¶ŸÇÿå ŸÑŸÉŸÜ Ÿàÿßÿ≠ÿØÿ© ŸÉÿ∞ÿ®ÿ©. ÿßŸÖÿ≥ŸÉ ÿßŸÑŸÉÿ∞ÿ®ÿ© ŸÅŸä Ÿ°Ÿ• ÿ´ÿßŸÜŸäÿ©!', 'üÉè', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startLiarGame()', 'bg-orange-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-xl text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p><h1 class="text-4xl font-black mb-6">${game.player.name}</h1><div class="text-6xl mb-6">üÉè</div><h2 class="text-3xl font-bold mb-8">ÿ¨ÿßŸáÿ≤ Ÿäÿß ÿ®ÿ∑ŸÑÿü</h2><p class="text-xl text-slate-400 mb-10">ŸáÿØŸäŸÉ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ.. ÿßŸÇÿ±ÿ£ ÿßŸÑŸÄ 3 ÿ≠ŸÇÿßÿ¶ŸÇ ÿ®ÿ≥ÿ±ÿπÿ©!</p><div onclick="startLiarTimerNow()" class="w-full py-6 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-black text-2xl shadow-xl cursor-pointer active:scale-95 transition">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑŸÉÿßÿ±ÿ™<br><span class="text-sm font-normal text-slate-400">(ÿßŸÑÿπÿØÿßÿØ ŸáŸäÿ®ÿØÿ£ ŸÅŸàÿ±ÿßŸã!)</span></div></div>`; if (game.phase === 'reading') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><div class="text-center mb-4"><p class="text-slate-400 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 class="text-2xl font-bold">${game.player.name}</h2></div><h2 class="text-3xl font-bold mb-6">${game.card.topic}</h2><div class="bg-slate-700 p-6 rounded-3xl w-full mb-8 space-y-4 shadow-xl border border-slate-600/50">${game.card.facts.map((fact, i) => `<button onclick="selectLiarFact(${i})" class="w-full p-4 bg-slate-600 hover:bg-slate-500 rounded-2xl text-right shadow-lg active:scale-95 transition ${game.selectedFact === i ? 'ring-4 ring-yellow-300' : ''}"><span class="font-bold">${i + 1}.</span> ${fact}</button>`).join('')}</div><div class="text-5xl font-black mb-6" id="game-timer">${game.timeLeft}</div><button onclick="revealLiarCard()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition" ${game.selectedFact === null ? 'disabled opacity-50' : ''}>ŸÉÿ¥ŸÅ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©</button></div>`; if (game.phase === 'result') { const lieIndex = 2; const isCorrect = game.selectedFact === lieIndex; return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">${isCorrect ? '‚úì' : '‚úó'}</div><h2 class="text-3xl font-bold mb-4 ${isCorrect ? 'text-teal-300' : 'text-rose-300'}">${isCorrect ? 'ÿµÿ≠! ÿ£ÿ≠ÿ≥ŸÜÿ™!' : 'ÿ∫ŸÑÿ∑!'}</h2><p class="text-xl mb-8 text-slate-400">ÿßŸÑŸÉÿ∞ÿ®ÿ© ŸÉÿßŸÜÿ™: "${game.card.facts[lieIndex]}"</p>${isCorrect ? `<button onclick="updateScore(${game.player.id}, false, 1); nextLiarRound()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold mb-3 shadow-lg active:scale-95 transition border border-slate-600/50">+Ÿ° ŸÜŸÇÿ∑ÿ©</button>` : state.daresEnabled ? `<button onclick="showDare()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold mb-3 shadow-lg active:scale-95 transition border border-slate-600/50">üíÄ ÿπŸÇÿßÿ®</button>` : ''}<button onclick="nextLiarRound()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold mt-3 shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; } }

        // --- AUCTION ---
        function startAuctionGame() { const category = getUniqueItem('auction', AUCTION_CATEGORIES); state.currentGame = { type: 'auction', phase: 'bidding', category, currentBid: 1, timeLeft: 30 }; playSound('click'); render(); }
        function raiseBid() { state.currentGame.currentBid++; playSound('click'); render(); }
        function auctionPass() { state.currentGame.phase = 'select_winner'; state.currentGame.finalBid = state.currentGame.currentBid; playSound('click'); saveState(); render(); }
        function selectAuctionWinner(playerId) { state.currentGame.winnerId = playerId; state.currentGame.phase = 'answering_ready'; state.currentGame.timeLeft = 30; playSound('click'); render(); }
        function startAuctionTimerNow() { state.currentGame.phase = 'answering'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); auctionFail(); return; } if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function auctionSuccess() { updateScore(state.currentGame.winnerId, false, state.currentGame.finalBid); startAuctionGame(); }
        function auctionFail() { if (state.daresEnabled) showDare(); startAuctionGame(); }
        function renderAuctionSetup() { if (!state.currentGame || state.currentGame.type !== 'auction') return renderGameStartScreen('ÿßŸÑŸÖÿ≤ÿßÿØ', 'ÿßŸÑŸÅÿ±ŸäŸÇ Ÿäÿ±ÿßŸáŸÜ ÿπŸÑŸâ ÿπÿØÿØ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÑŸä ŸäŸÇÿØÿ± ŸäŸÇŸàŸÑŸáÿß. ÿßŸÑŸÖÿ≤ÿßÿØ ŸÑŸÑÿ£ÿπŸÑŸâÿå ŸàÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑŸÅÿßŸäÿ≤ ŸÑÿßÿ≤ŸÖ ŸäŸÜŸÅÿ∞!', 'üî®', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startAuctionGame()', 'bg-cyan-600'); const game = state.currentGame; if (game.phase === 'bidding') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><div class="bg-slate-700 p-6 rounded-3xl mb-8 w-full shadow-xl border border-slate-600/50"><div class="text-sm text-slate-400 mb-2">ÿßŸÑŸÅÿ¶ÿ©:</div><h2 class="text-3xl font-bold">${game.category.name}</h2></div><div class="text-lg text-slate-400 mb-4">ÿ£ÿπŸÑŸâ ÿ±ŸÇŸÖ ŸÖÿ≤ÿßÿØ:</div><div class="text-8xl font-black text-yellow-300 mb-8">${game.currentBid}</div><div class="grid grid-cols-2 gap-3 w-full"><button onclick="raiseBid()" class="py-4 bg-teal-500 hover:bg-teal-600 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">+Ÿ° ÿπŸÑŸä</button><button onclick="auctionPass()" class="py-4 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ÿ®ÿßÿ≥!</button></div></div>`; if (game.phase === 'select_winner') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">üî®</div><h2 class="text-3xl font-bold mb-4">ÿßŸÑŸÖÿ≤ÿßÿØ ÿÆŸÑÿµ!</h2><p class="text-xl text-slate-400 mb-2">ŸÖÿ∑ŸÑŸàÿ® <span class="font-black text-yellow-300 text-2xl">${game.finalBid}</span> ÿ•ÿ¨ÿßÿ®ÿ©</p><p class="text-lg mb-6 mt-6">ŸÖŸäŸÜ ÿ±ÿ≥Ÿâ ÿπŸÑŸäŸá ÿßŸÑŸÖÿ≤ÿßÿØÿü</p><div class="grid grid-cols-2 gap-3 w-full max-h-[50vh] overflow-y-auto">${state.players.map(p => `<button onclick="selectAuctionWinner(${p.id})" class="py-4 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition border border-slate-600/50">${p.name}</button>`).join('')}</div></div>`; if (game.phase === 'answering_ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">üî®</div><h2 class="text-3xl font-bold mb-4">ÿ¨ÿßŸáÿ≤ŸäŸÜÿü</h2><p class="text-xl text-slate-400 mb-2">ÿßŸÑŸÅÿßÿ¶ÿ≤: <span class="font-black text-yellow-300">${state.players.find(p => p.id === game.winnerId)?.name}</span></p><p class="text-lg text-slate-400 mb-4">ŸÖÿ∑ŸÑŸàÿ® <span class="font-black text-yellow-300 text-2xl">${game.finalBid}</span> ÿ•ÿ¨ÿßÿ®ÿ©</p><div onclick="startAuctionTimerNow()" class="w-full py-6 mt-8 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-black text-2xl shadow-xl cursor-pointer active:scale-95 transition">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ®ÿØÿ£ ÿßŸÑÿπÿØÿßÿØ</div></div>`; if (game.phase === 'answering') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="text-center mt-8 mb-8"><h2 class="text-slate-400 text-lg">ÿßŸÑŸÅÿ¶ÿ©: <span class="font-bold text-white">${game.category.name}</span></h2><div class="text-5xl font-black text-teal-300 mt-4">ŸÑÿßÿ≤ŸÖ ${game.finalBid} ÿ•ÿ¨ÿßÿ®ÿ©!</div></div><div class="flex-1 flex justify-center items-center"><div class="text-8xl font-black text-teal-300" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3"><button onclick="auctionSuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ŸÜÿ¨ÿ≠!</button><button onclick="auctionFail()" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition">‚úó ŸÅÿ¥ŸÑ!</button></div></div>`; }

        // --- GIBBERISH ---
        function startGibberishGame() { 
            const phrase = getUniqueItem('gibberish', GIBBERISH_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'gibberish', phase: 'ready', phrase, player, timeLeft: 30 }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startGibberishTimerNow() { state.currentGame.phase = 'playing'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); revealGibberishAnswer(); } if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function revealGibberishAnswer() { state.currentGame.phase = 'answer'; playSound('click'); saveState(); render(); }
        function nextGibberishRound() { startGibberishGame(); }
        function renderGibberishSetup() { if (!state.currentGame || state.currentGame.type !== 'gibberish') return renderGameStartScreen('ŸÅŸÉ ÿßŸÑÿ¥ŸÅÿ±ÿ©', 'ÿ¨ŸÖŸÑ ÿ∫ÿ±Ÿäÿ®ÿ©! ÿßŸÇÿ±ÿ£Ÿáÿß ÿ®ÿµŸàÿ™ ÿπÿßŸÑŸä ŸÉÿ∞ÿß ŸÖÿ±ÿ© ŸÑÿ≠ÿØ ŸÖÿß ÿ™ŸÅŸáŸÖ ÿßŸÑŸÖÿπŸÜŸâ ÿßŸÑÿ≠ŸÇŸäŸÇŸä!', 'üó£Ô∏è', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startGibberishGame()', 'bg-pink-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><p class="text-xl text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p><h1 class="text-4xl font-black mb-8">${game.player.name}</h1><div class="text-6xl mb-6">üó£Ô∏è</div><h2 class="text-3xl font-bold mb-8">ÿ¨ÿßŸáÿ≤ ÿ™ŸÅŸÉ ÿßŸÑÿ¥ŸÅÿ±ÿ©ÿü</h2><div onclick="startGibberishTimerNow()" class="w-full py-6 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-black text-2xl shadow-xl cursor-pointer active:scale-95 transition">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ®ÿØÿ£<br><span class="text-sm font-normal text-slate-400">(ÿßŸÑÿπÿØÿßÿØ ŸáŸäÿ®ÿØÿ£ ŸÅŸàÿ±ÿßŸã!)</span></div></div>`; if (game.phase === 'playing') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><div class="text-center mb-4"><p class="text-slate-400 mb-1">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ:</p><h2 class="text-2xl font-bold">${game.player.name}</h2></div><div class="text-sm text-slate-400 mb-4">ÿßŸÇÿ±ÿ£Ÿáÿß ÿ®ÿµŸàÿ™ ÿπÿßŸÑŸä!</div><div class="bg-slate-700 p-8 rounded-3xl mb-8 shadow-xl border border-slate-600/50"><h1 class="text-4xl font-black">${game.phrase.gibberish}</h1></div><div class="text-6xl font-black mb-8" id="game-timer">${game.timeLeft}</div><button onclick="revealGibberishAnswer()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©</button></div>`; if (game.phase === 'answer') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><div class="bg-slate-700 p-6 rounded-3xl mb-8 shadow-xl border border-slate-600/50"><div class="text-sm text-slate-400 mb-2">ŸÉÿßŸÜÿ™:</div><div class="text-2xl font-bold mb-4">${game.phrase.gibberish}</div><div class="text-sm text-slate-400 mb-2">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©:</div><div class="text-3xl font-black text-yellow-300">${game.phrase.answer}</div></div><button onclick="nextGibberishRound()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold text-xl mb-3 shadow-lg active:scale-95 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; }

        // --- HUM ---
        function startHumGame() { const song = getUniqueItem('hum', HUM_SONGS); const player = getFairPlayer(); state.currentGame = { type: 'hum', phase: 'prepare', song, player, revealed: false, timeLeft: 45 }; playSound('click'); saveState(); render(); }
        function startHumRound() { state.currentGame.phase = 'humming'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); humFail(); return; } if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function humSuccess() { updateScore(state.currentGame.player.id, false, 1); startHumGame(); }
        function humFail() { if (state.daresEnabled) showDare(); startHumGame(); }
        function renderHumSetup() { if (!state.currentGame || state.currentGame.type !== 'hum') return renderGameStartScreen('ÿ∑ÿ±ÿ®ŸÜŸä ÿ¥ŸÉÿ±ÿßŸã', 'ŸáŸÖŸáŸÖ ÿßŸÑŸÑÿ≠ŸÜ ÿ®ÿ≥! ŸÖŸÖŸÜŸàÿπ ÿßŸÑŸÉŸÑŸÖÿßÿ™. "ÿ™Ÿà ÿ™Ÿà ÿ±Ÿà ÿ™Ÿà" ŸÅŸÇÿ∑!', 'üéµ', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startHumGame()', 'bg-yellow-600'); const game = state.currentGame; if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><p class="text-xl text-slate-400 mb-2">ÿßŸÑÿØŸàÿ± ÿπŸÑŸâ</p><h1 class="text-4xl font-black mb-8">${game.player.name}</h1><div class="bg-slate-700 p-6 rounded-3xl border border-slate-600/50 w-full mb-8 relative overflow-hidden shadow-xl">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-slate-800 z-10 flex items-center justify-center cursor-pointer hover:bg-slate-700 transition"><span class="text-xl font-bold animate-pulse">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑÿ£ÿ∫ŸÜŸäÿ©</span></div>` : ''}<p class="text-sm mb-2 text-slate-400">ÿßŸÑÿ£ÿ∫ŸÜŸäÿ©:</p><h2 class="text-3xl font-bold text-yellow-300">${game.song.song}</h2><p class="text-sm mt-2 text-slate-400">ÿßŸÑÿµÿπŸàÿ®ÿ©: ${game.song.difficulty}</p></div><button onclick="startHumRound()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition" ${!game.revealed ? 'disabled opacity-50' : ''}>ÿßÿ®ÿØÿ£ ÿßŸÑŸáŸÖŸáŸÖÿ©!</button></div>`; if (game.phase === 'humming') return `<div class="h-screen flex flex-col p-6 bg-slate-800"><div class="text-center mt-8 mb-8"><h2 class="text-slate-400">ÿßŸÑŸÖŸáŸÖŸáŸÖ: <span class="font-bold text-white">${game.player.name}</span></h2><h1 class="text-3xl font-black text-white mt-2">${game.song.song}</h1></div><div class="flex-1 flex justify-center items-center"><div class="text-8xl font-black text-orange-300" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3"><button onclick="humSuccess()" class="w-full py-4 bg-teal-500 hover:bg-teal-600 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">‚úì ÿπÿ±ŸÅŸàŸáÿß!</button><button onclick="humFail()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">ŸÖÿπÿ±ŸÅŸàÿ¥</button></div></div>`; }

        // --- LIKELY ---
        function startLikelyGame() { const question = getUniqueItem('likely', MOST_LIKELY); state.currentGame = { type: 'likely', phase: 'ready', question, timeLeft: 5 }; playSound('click'); saveState(); render(); }
        function startLikelyTimerNow() { state.currentGame.phase = 'showing'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function likelySelectPlayer(playerId) { 
            // Fair Scoring: Selected player gets -1, all others get +1
            state.players.forEach(p => {
                if (p.id === playerId) {
                    updateScore(p.id, false, -1); // Selected player loses a point
                } else {
                    updateScore(p.id, false, 1); // Others gain a point
                }
            });
            
            // Optional dare for selected player
            if (state.daresEnabled) showDare(); 
            
            nextLikelyRound(); 
        }
        function nextLikelyRound() { startLikelyGame(); }
        function renderLikelySetup() { if (!state.currentGame || state.currentGame.type !== 'likely') return renderGameStartScreen('ŸÖŸäŸÜ ÿßŸÑŸÉÿßÿ±ÿ´ÿ©ÿü', 'ÿ≥ÿ§ÿßŸÑ Ÿäÿ∏Ÿáÿ±. ŸÅŸä Ÿ• ÿ´ŸàÿßŸÜŸä ŸÉŸÑŸÉŸÖ ÿ™ÿ¥ÿßŸàÿ±Ÿàÿß ÿπŸÑŸâ ŸÜŸÅÿ≥ ÿßŸÑÿ¥ÿÆÿµ. ÿßŸÑŸÑŸä ÿßŸÑŸÉŸÑ ÿ¥ÿßŸàÿ± ÿπŸÑŸäŸá.. ÿπŸÇÿßÿ®!', 'üëâ', 'ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©', 'startLikelyGame()', 'bg-red-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center animate-in"><div class="text-6xl mb-6">üëâ</div><h2 class="text-3xl font-bold mb-8">ÿ¨ÿßŸáÿ≤ŸäŸÜÿü</h2><div onclick="startLikelyTimerNow()" class="w-full py-6 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-black text-2xl shadow-xl cursor-pointer active:scale-95 transition">ÿØŸàÿ≥ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ŸàŸÅ ÿßŸÑÿ≥ÿ§ÿßŸÑ<br><span class="text-sm font-normal text-slate-400">(5 ÿ´ŸàÿßŸÜŸä ÿ®ÿ≥!)</span></div></div>`; if (game.phase === 'showing') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><div class="bg-slate-700 p-8 rounded-3xl mb-8 w-full shadow-xl border border-slate-600/50"><h1 class="text-3xl font-black leading-relaxed">${game.question}</h1></div><div class="text-8xl font-black mb-8" id="game-timer">${game.timeLeft}</div><p class="text-xl text-slate-400">ÿ¥ÿßŸàÿ±Ÿàÿß ÿØŸÑŸàŸÇÿ™Ÿä! üëâ</p></div>`; if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-800 text-white text-center"><div class="bg-slate-700 p-6 rounded-3xl mb-6 w-full shadow-xl border border-slate-600/50"><h3 class="text-sm text-slate-400 mb-2">ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸÉÿßŸÜ:</h3><h1 class="text-2xl font-black leading-relaxed">${game.question}</h1></div><h2 class="text-3xl font-bold mb-8">ÿßÿ™ŸÅŸÇŸàÿß ÿπŸÑŸâ ŸÖŸäŸÜÿü</h2><div class="grid grid-cols-2 gap-3 w-full mb-8">${state.players.map(p => `<button onclick="likelySelectPlayer(${p.id})" class="p-4 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold shadow-lg active:scale-95 transition border border-slate-600/50">${p.name}</button>`).join('')}</div><button onclick="nextLikelyRound()" class="w-full py-3 bg-rose-500 hover:bg-rose-600 rounded-2xl font-bold shadow-lg active:scale-95 transition">ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-2xl font-bold mt-3 shadow-lg active:scale-95 transition border border-slate-600/50">ÿÆÿ±Ÿàÿ¨</button></div>`; }
        
        // ===== INIT =====
        // Auto-load on page load using DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            loadState(); // Load saved state from localStorage (includes players array)
            
            // Load theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
            
            render(); // Trigger render to display the loaded data
            updateBottomNav(); // Update bottom nav appearance
            
            // Close settings modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('settings-modal');
                    if (modal.classList.contains('active')) {
                        closeSettings();
                    }
                }
            });
        });
    </script>
</body>
</html>